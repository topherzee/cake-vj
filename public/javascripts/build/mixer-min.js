function Addon(){}function AudioAnalysis(e,n){var t=this;t.uuid="Analysis_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Addon",t.audio="",t.bypass=!1,t.bpm=128,t.beats=0,t.delayed_bpm=128,t.use_delay=!0,t.bpm_limit=256,t.bpm_float=0,t.mod=1,t.bps=1,t.sec=0,t.count=0,t.dataSet,t.tempoData,t.audio_src,t.options={audio:"/audio/fear_is_the_mind_killer_audio.mp3",microphone:!1},null!=n&&(t.options=n);var r=!0,o=[],a=0,u=(new Date).getTime();e.add(t);var c=new Audio;t.audio=c;var i,s=new(window.AudioContext||window.webkitAudioContext),l=s.createBiquadFilter(),d=s.createAnalyser(),m=Date.now();t.dataSet=new Array(4e3);var f,g=new Array(4e3),p=[],v=1,_=!1,h=[];c.controls=!0,c.loop=!0,c.autoplay=!0,c.crossorigin="anonymous",l.type="lowpass",l.frequency.value=350,l.Q.value=1,d.fftSize=128,f=d.frequencyBinCount,t.context=s,t.analyser=s,t.bufferLength=f,t.dataArray=void 0,t.disconnectOutput=function(){i.disconnect(s.destination)},t.connectOutput=function(){i.connect(s.destination)},t.getBpm=function(){return t.bpm};var y=function(){if(!t.audio.paused)return s.resume(),document.body.removeEventListener("click",y),void document.body.removeEventListener("touchstart",y);console.log("AudioAnalysis is re-intialized after click initialized!",c.src),s.resume().then(()=>{c.play(),console.log("Playback resumed successfully"),document.body.removeEventListener("click",y),document.body.removeEventListener("touchstart",y)})};document.body.addEventListener("click",y),document.body.addEventListener("touchstart",y),t.init=function(){console.log("init AudioAnalysis Addon."),t.options.microphone?(console.log("Audio analisis using microphone."),navigator.mediaDevices.getUserMedia({audio:c}).then(function(e){i=s.createMediaStreamSource(e),E(),t.disconnectOutput()}).catch(function(e){console.log(e.name+": "+e.message)})):(i=s.createMediaElementSource(c),c.src=t.options.audio,t.audio_src=t.options.audio,E())},t.render=function(){return t.bpm_float},t.add=function(e){o.push(e)},t.sync=function(){u=(new Date).getTime()},t.getBlackOut=function(){},t.getAmbience=function(){},t.getHighLevels=function(){},t.getMidLevels=function(){},t.getLowLevels=function(){};var b=0;t.update=function(){t.bypass||(t.disabled||o.forEach(function(e){e(t.render())}),t.bpm=t.tempodata_bpm,t.bpm>t.bpm_limit&&(console.warn("reached bpm limit!: ",t.bpm,"reset bpm to limit: ",t.bpm_limit),t.bpm=t.bpm_limit),a=((new Date).getTime()-u)/1e3,t.count=a,t.use_delay?(t.delayed_bpm<t.bpm&&(t.delayed_bpm+=.1),t.delayed_bpm>t.bpm&&(t.delayed_bpm-=.1)):t.delayed_bpm=t.bpm,t.sec=a*Math.PI*t.delayed_bpm/60,t.sec=t.sec*(b/t.delayed_bpm),t.bpm_float=(Math.sin(t.sec*t.mod)+1)/2,t.bpm!=b&&(b=t.delayed_bpm*t.mod),t.sec>t.delayed_bpm&&(u=(new Date).getTime()),t.bpm_float>.9&&!_?(t.beats+=1,_=!0):t.bpm_float<.1&&_&&(t.beats+=1,_=!1))};var E=function(){if(c.play(),i.connect(l),l.connect(d),i.connect(s.destination),window.Worker){console.log("go");var e=new Blob(['\n      \n        var _self = null;\n        onmessage = function(e) {\n          \n          var data = JSON.parse(e.data)\n          console.log("msgevent:", data.command );          \n          _self = data.module\n          if ( data.command == "start" ) {\n            //setInterval( worker_sampler, 1);\n            console.log("(TEST)start the worker!", _self)\n          }          \n        }\n\n        postMessage(\'Inline worker created\');          \n      ']),n=window.URL.createObjectURL(e),t=new Worker(n);t.onmessage=function(e){console.log("module got worker message: ",e.data)},window.my_worker=t,setInterval(S,1)}else setInterval(S,1)},x=!1,S=function(){if(!t.audio.muted&&!t.bypass){t.dataArray=new Uint8Array(f),d.getByteTimeDomainData(t.dataArray);var e=Date.now(),n=0;if(t.dataArray.forEach(e=>{e>n&&(n=e)}),t.dataSet.push([e,n]),t.dataSet.length>4e3&&t.dataSet.splice(0,t.dataSet.length-4e3),0,e-m>20){var r=C(t.dataSet);t.tempoData=r,null==r?(x||console.warn(" WARNING: sampler is active, but no audio was detected after 20 seconds -- check your audiofile or your microphone and make sure you've clicked in the window and gave it access! Halting."),x=!0,t.tempodata_bpm=128):(t.tempodata_bpm=r.bpm,x=!1),t.useAutoBPM&&(t.sec=a*Math.PI*(r.bpm*t.mod)/60),m=Date.now(),0}}},w=function(){0!=document.getElementsByClassName("blink").length&&(c.paused?document.getElementsByClassName("blink")[0].style.opacity=0:1==document.getElementsByClassName("blink")[0].style.opacity?document.getElementsByClassName("blink")[0].style.opacity=0:document.getElementsByClassName("blink")[0].style.opacity=1,setTimeout(w,60/t.bpm*1e3/t.mod))};w();var C=function(e){p=[],g=new Array(e.length);for(var n=0;n<e.length;n++)void 0!==e[n]&&e[n][1]>128*v&&(g[n]=[t.dataSet[n][0],1],p.push([e[n][0],1]),n+=50);p.length<15&&(v-=.05),p.length>60&&(v+=.05),v>2&&(v=2),v<1&&(v=1);var o=M(T(p));if(o.sort(I),0==o.length)o[0]={tempo:128};else{var a="";o.reverse().forEach(function(e,n){a+=n+", "+e.tempo+", "+e.count+"\t [";for(var t=0;t<e.count;)a+="#",t++;a+="]<br/>"}),null!=document.getElementById("info")&&(document.getElementById("info").html=a)}var u="calibrating";if(r=!1,void 0===e[0])r=!0,document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#999999");else{if(r=!1,void 0===o[0]||void 0===o[1])return;var c=o[0].count-o[1].count;c<=2?(u="low",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#990000")):c>2&&c<=7?(u="average",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#999900")):c>7&&(u="high",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#CCCCCC"))}return{bpm:o[0].tempo,confidence:u,calibrating:r,treshold:v,tempoCounts:o,foundpeaks:p,peaks:g}},I=function(e,n){return parseInt(e.count,10)-parseInt(n.count,10)},T=function(e){return h=[],e.forEach(function(n,t){for(var r=0;r<10;r++)if(void 0!==e[t+r]){var o=e[t+r][0]-n[0];h.some(function(e){if(e.interval===o)return e.count++})||h.push({interval:o,count:1})}}),h},M=function(e){var n=[];return e.forEach(function(e,t){if(0!=e.interval&&!isNaN(e.interval))var r=60/(e.interval/1e3);for(;r<90;)r*=2;for(;r>180;)r/=2;r=2*Math.round(r/2),n.some(function(n){if(n.tempo===r)return n.count+=e.count})||r&&n.push({tempo:r,count:e.count})}),n}}function BPM(e,n){var t=this;if(t.function_list=[["AUTO","method","toggleAutoBpm"],["MODDOWN","method","modDown"],["MODUP","method","modUp"],["MOD","method","modNum"]],null==e)return;t.uuid="BPM_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),window["bpm_"+t.uuid],t.type="Addon",t.options={},null!=n&&(t.options=n),t.bpm=128,t.bps=2.133333,t.sec=0,t.bpm_float=.46875,t.mod=1,t.useAutoBpm=!1,t.tempodata_bpm=128,t.mute=!1,t.autoBpmData={},t.audio_src="",t.useMicrophone=!1,t.bypass=!1;var r=[];e.add(t),t.init=function(){console.log("init BPM contoller.")};var o=(new Date).getTime(),a=0;t.update=function(){t.disabled||r.forEach(function(e){e(t.render())}),a=((new Date).getTime()-o)/1e3;var e=1/t.bpm*60;t.bpm_float=a%e/e},t.add=function(e){r.push(e)},t.render=function(e){return t.bpm_float},t.render2=function(e){if(void 0===e)return t.bpm_float;var n=1/t.bpm*60*e;return a%n/n},t.modUp=function(){t.mod*=2},t.modDown=function(){t.mod*=.5},t.modNum=function(e){console.log("MOD ",e);var n=t.useAutoBpm;t.mod=e,t.useAutoBpm=n},t.toggleAutoBpm=function(e){t.useAutoBpm=!t.useAutoBpm,console.log("---\x3e",t.useAutoBpm)},t.turnOff=function(){bpm.audio.muted=!1,bpm.useAutoBpm=!1};var u="TAP_PHASE_PRIME",c=0;t.tapCake=function(){if(t.useAutoBPM=!1,"TAP_PHASE_PRIME"==u)u="TAP_PHASE_SET_LENGTH",c=Number(new Date),console.log("BPM TAP. Start.");else if("TAP_PHASE_SET_LENGTH"==u){u="TAP_PHASE_PRIME";var e=Number(new Date)-c;t.bpm=6e4/e,t.resetCake(),console.log("BPM TAP. Complete. seconds:",(e/1e3).toFixed(2)),console.log("BPM TAP. Complete. bpm:",t.bpm.toFixed(2))}return u},t.resetCake=function(){o=(new Date).getTime(),t.update(),console.log("ResetCake bpm",t.bpm_float)},t.getBpm=function(){return t.bpm},t.setBpm=function(e){t.bpm=e,console.log("setBpm",e)}}function FileManager(e){console.log("FileManager START ----------------");var n=this;n.function_list=[["CHZ","method","changez"]],n.uuid="Filemanager_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="AddOn",n.defaultQuality="",n.source=e,n.debug=!1,n.set=[],n.load_set=function(e){console.log("FileManager load_set ----------------"),(new Utils).get(e,function(e){n.set=JSON.parse(e)})},null!=window.in_app&&(n.eu=window.eu),n.setSrc=function(e){null==window.in_app?(n.source.src(e),console.log("filemanager: set normal source:",e)):(n.source.src(n.eu.check_file(e)),console.log("filemanager: set checked source:",n.eu.check_file(e)))},n.load=function(e){(new Utils).get(e,function(e){n.set=JSON.parse(e),(n.debug=!1)&&console.log("got set: ",n.set)})},n.changeToNum=function(e){n.setSrc(n.set[e]),(n.debug=!1)&&console.log("changed file: ",e,self.set[e])},n.changeToUrl=function(e){n.setSrc(e),(n.debug=!1)&&console.log("changed file from url: ",_num,self.set[_num])},n.change=function(e){if(console.log("FileManager Change ----------------"),0!=n.set.length){if(null!=e)return void n.changeToNum(e);var t=n.set[Math.floor(Math.random()*n.set.length)];n.setSrc(t),(n.debug=!1)&&console.log("changed file: ",t)}},n.changez=function(e){n.change(e)},n.getSrcByTag=function(e){}}function GiphyManager(e){var n=this;n.uuid="GiphyManager_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="AddOn",n.source=e,n.file="",n.programs=[],n.program="";n.needle=function(e,t){(new Utils).get("//api.giphy.com/v1/gifs/search?api_key=tIovPHdiZhUF3w0UC6ETdEzjYOaFZQFu&q="+e,function(e){console.log(" === GIPHY (re)LOADED === "),n.programs=JSON.parse(e).data,null!=t&&t()})},n.search=function(e,t){n.needle(e,t)},n.setSrc=function(e){console.log("set source: ",e),n.source.src(e)},n.change=function(){if(0==n.programs.length)return"no programs found :(";n.program=n.programs[Math.floor(Math.random()*n.programs.length)],n.file=n.program,n.setSrc(n.program.images.original.url)},n.changez=function(){n.change()}}function Behaviour(e,n){var t=this;function r(e){"seconds"==e.mod.type?triggers.push([e,t.time+e.mod.value,null]):"beats"==e.mod.type?triggers.push([e,t.beats+e.mod.value]):"random-seconds"==e.mod.type?triggers.push([e,t.time+Math.random()*e.mod.value,null]):"random-beats"==e.mod.type&&triggers.push([e,t.beats+Math.random()*e.mod.value])}t.uuid="Behaviour"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Behaviour",e.add(t),t.beats=0,t.time=(new Date).getTime(),t.script={},t.sheets=[],t.sheet_index=0,t.bpm=n.bpm,triggers=[],t.tr=triggers,old_bpm=1,t.init=function(){},t.update=function(){t.time=(new Date).getTime();var e=Math.round(4*bpm.render());e!=old_bpm&&(t.beats+=1,old_bpm=e)},t.load=function(e){t.script=e,t.sheets=e.sheets,console.log("loaded A BEHAVIOUR",e.title),e.triggers.forEach(function(e,n){r(e)})},t.jump=function(e){console.log("how high?",e),e.video.currentTime=Math.random()*e.video.duration};var o=0;t.checkSheets=function(){t.sheets[0].length;checkBeats(o%t.sheets[t.sheet_index].length),t.sheets[t.sheet_index][o%t.sheets[t.sheet_index].length].forEach(function(e){if("....."!=e[0]){console.log(e);var n=t.script.composition[e[0]].target,r=t.script.composition[e[0]].functions,o=null;r.forEach(function(t,r){if(e[1]==t[0]){console.log("TRIGGERED",o=t[2]);var a=e[2];a=isNaN(e[2])?e[2]:parseFloat(e[2]),n[t[2]](a),console.log(n,o,a)}})}}),o+=1,setTimeout(t.checkSheets,60/bpm.bpm*1e3/4)};setTimeout(function(){},12e3)}async function start(){console.log("CAKE Start --------------------");var e=new GlRenderer({element:"glcanvas",width:800,height:450});function n(e,n){let a=document.getElementById("layer_template").innerHTML;a=a.replaceAll("_4","_"+n);const u=document.createElement("div");u.innerHTML=a;const c=u.firstElementChild;document.getElementById(e).appendChild(c),document.getElementById("layer_"+n).onclick=function(){I(n)},document.getElementById("layer_effect_d_p1_"+n).oninput=function(){d[n].extra(this.value)},document.getElementById("layer_effect_d_p2_"+n).oninput=function(){d[n].extra2(this.value)},document.getElementById("layer_effect_c1_p1_"+n).oninput=function(){m[n].extra(this.value),console.log("color layer_effect 1 "+n+" >>",parseFloat(this.value))},document.getElementById("layer_effect_c2_p1_"+n).oninput=function(){f[n].extra(this.value),console.log("color layer_effect 2 "+n+" >>",parseFloat(this.value))},document.getElementById("btn_bpm_layer_"+n).onclick=function(){r(n)},document.getElementById("layer_play_"+n).onclick=function(){console.log("play ",n),j[n].is_playing=!0},document.getElementById("layer_pause_"+n).onclick=function(){console.log("pause ",n),j[n].is_playing=!1},document.getElementById("layer_in_"+n).onclick=function(){console.log("in ",n),K(n)},document.getElementById("layer_out_"+n).onclick=function(){console.log("out ",n),q(n)},document.getElementById("layer_play_mode_"+n).oninput=function(){console.log("layer_play_mode_"+n,this.value),A(n,this.value)},document.getElementById("layer_bpm_mode_"+n).oninput=function(){console.log("layer_bpm_mode"+n,this.value),function(e,n){j[e].bpm_mode=n,console.log("setBpmModeOnLayer",e,n)}(n,this.value)},document.getElementById("layer_bpm_factor_"+n).oninput=function(){console.log("layer_bpm_factor_"+n,parseFloat(this.value)),j[n].bpm_factor=parseFloat(this.value)},document.getElementById("layer_time_"+n).oninput=function(){var e=this.value*l[n].duration();l[n].currentTime(e),j[n].time_last_beat=Date.now()-1e3*e},document.getElementById("layer_time_"+n).onmousedown=function(){j[n].is_scrubbing=!0},document.getElementById("layer_time_"+n).onmouseup=function(){j[n].is_scrubbing=!1},document.getElementById("monitor_"+n).onmousedown=function(e){W=n,I(n),V=!0,N=e.clientX,j[b].is_jogging=!0,j[b].is_scrubbing=!0},document.getElementById("cake-mixer").onmouseup=function(e){O=!1,V=!1,W=-1,N=-1,j[b].is_scrubbing=!1,j[b].is_jogging=!1},document.getElementById("cake-mixer").onmousemove=function(e){if(void 0!==V&&V&&W>0){const t=e.clientX-N;console.log("jog global",t),console.log("currenttime",l[b].video.currentTime),console.log("e.movementX",e.movementX);const r=l[b].video;var n=(r.currentTime+e.movementX/30)%r.duration;r.currentTime=n,document.getElementById("layer_time_"+b).value=n/r.duration}},document.getElementById("layer_speed_"+n).oninput=function(){console.log("layer_speed >>",n,parseFloat(this.value))},document.getElementById("layer_blendmode_"+n).oninput=function(){_.blendMode(this.value),console.log("layer_blendmode_"+n,parseFloat(this.value))};for(var i=document.getElementById("layer_effect_d_"+n),s=0;s<o.length;s++){var g=document.createElement("option");g.text=o[s].n,g.value=o[s].v,i.add(g)}i.oninput=function(){console.log("layer_effect_d_"+b,parseFloat(this.value)),function(e,n){d[e].effect(n)}(n,this.value)},t(n,1).oninput=function(){var e,n;console.log("layer_effect_c1_"+b,parseFloat(this.value)),e=b,n=this.value,m[e].effect(n)},t(n,2).oninput=function(){var e,n;console.log("layer_effect_c2_"+b,parseFloat(this.value)),e=b,n=this.value,f[e].effect(n)}}function t(e,n){for(var t=document.getElementById("layer_effect_c"+n+"_"+e),r=0;r<a.length;r++){var o=document.createElement("option");o.text=a[r].n,o.value=a[r].v,t.add(o)}return t}function r(e){j[e].bpm_on=!j[e].bpm_on,console.log("bpm layer "+e+" >>",j[e].bpm_on);let n=document.getElementById("btn_bpm_layer_"+e);j[e].bpm_on?n.classList.add("active"):n.classList.remove("active")}var o=[{n:"No Effect",v:1},{n:"Mirror Horizontal",v:107},{n:"Mirror Vertical",v:106},{n:"Wipe Horiz",v:108},{n:"Wipe Vert",v:110},{n:"Wipe Angle",v:111},{n:"Wipe Donut",v:112},{n:"Mirror Both",v:109},{n:"Kaleido",v:110}];var a=[{n:"No Effect",v:1},{n:"Toph Luma Black",v:100},{n:"Toph Luma White",v:102},{n:"Negative 3",v:2},{n:"B&W",v:10},{n:"Red",v:11},{n:"Blue",v:13},{n:"Green",v:12},{n:"Yellow",v:14},{n:"Teal",v:15},{n:"Magenta",v:16},{n:"Sepia",v:17},{n:"Swap 1",v:20},{n:"Paint",v:52},{n:"Colorize",v:53},{n:"Brightness",v:60},{n:"Contrast",v:61},{n:"Satur8",v:62},{n:"Hue",v:63},{n:"Black Edge",v:64}];function u(e,n){const t=document.getElementById("layer_bpm_factor_"+e);!function(e,n){const t=e.selectedIndex+n;t>-1&&t<5&&(e.selectedIndex=t)}(t,n);let r=parseFloat(t.value);console.log("changeBeatFactor",r),j[e].bpm_factor=r}function c(e){let n=s.getBpm()+e;s.setBpm(n),document.getElementById("bpm_slide").value=s.getBpm(),document.getElementById("bpm_display").textContent=Math.round(s.getBpm())}function i(e,n){document.getElementById("layer_play_mode_"+e).value=n,A(e,n)}console.log("addLayers"),n("channel_2_layers",4),n("channel_2_layers",3),n("channel_1_layers",2),n("channel_1_layers",1),window.addEventListener("keydown",e=>{if(console.log("e.code",e.code),console.log("target:",e.target.nodeName),"input"!=e.target.nodeName.toLowerCase()&&("Digit1"==e.code&&I(1),"Digit2"==e.code&&I(2),"Digit3"==e.code&&I(3),"Digit4"==e.code&&I(4),"ArrowLeft"==e.code&&i(b,H),"ArrowRight"==e.code&&i(b,F),"ArrowDown"==e.code&&i(b,L),"ArrowUp"==e.code&&i(b,z),"Space"==e.code&&(j[b].is_playing=!j[b].is_playing),"KeyI"==e.code&&K(b),"KeyO"==e.code&&q(b),"KeyA"==e.code&&$(),"KeyD"==e.code&&Z(),"KeyW"==e.code&&c(1),"KeyS"==e.code&&c(-1),"KeyK"==e.code&&r(b),"KeyJ"==e.code&&u(b,-1),"KeyL"==e.code&&u(b,1),"KeyU"==e.code)){let e=P;j[b].bpm_mode==P&&(e=G),document.getElementById("layer_bpm_mode_"+b).value=e,j[b].bpm_mode=e}}),document.getElementById("layer_fader_1").oninput=function(){v.pod(this.value)},document.getElementById("layer_fader_2").oninput=function(){_.pod(this.value)},document.getElementById("layer_fader_3").oninput=function(){h.pod(this.value)},document.getElementById("layer_fader_4").oninput=function(){y.pod(this.value)};var s=new BPM(e);s.add(function(e){e<.1?document.getElementById("bpm_reset").classList.add("phase"):document.getElementById("bpm_reset").classList.remove("phase")});let l=new Array,d=new Array,m=new Array,f=new Array;l[1]=new FlexSource(e,{src:"/video/DCVS01/DCVS01 container 01 ominouslong chop.mp4",uuid:"Video_1",fragmentChannel:1,elementId:"monitor_1"}),l[2]=new FlexSource(e,{src:"/video/DCVS01/DCVS01 container 02 scape.mp4",uuid:"Video_2",fragmentChannel:1,elementId:"monitor_2"}),l[3]=new FlexSource(e,{src:"/images/640X480.gif",fragmentChannel:2,uuid:"Gif_3",elementId:"monitor_3"}),l[4]=new FlexSource(e,{src:"/images/animal.gif",fragmentChannel:2,uuid:"Gif_4",elementId:"monitor_4"});d[1]=new DistortionEffect2(e,{source:l[1],fragmentChannel:1,uuid:"Dist_1"}),d[2]=new DistortionEffect2(e,{source:l[2],fragmentChannel:1,uuid:"Dist_2"}),d[3]=new DistortionEffect2(e,{source:l[3],fragmentChannel:2,uuid:"Dist_3"}),d[4]=new DistortionEffect2(e,{source:l[4],fragmentChannel:2,uuid:"Dist_4"}),m[1]=new ColorEffect(e,{source:d[1],fragmentChannel:1,uuid:"Color_c1_1"}),m[2]=new ColorEffect(e,{source:d[2],fragmentChannel:1,uuid:"Color_c1_2"}),m[3]=new ColorEffect(e,{source:d[3],fragmentChannel:2,uuid:"Color_c1_3"}),m[4]=new ColorEffect(e,{source:d[4],fragmentChannel:2,uuid:"Color_c1_4"}),f[1]=new ColorEffect(e,{source:m[1],fragmentChannel:1,uuid:"Color_c2_1"}),f[2]=new ColorEffect(e,{source:m[2],fragmentChannel:1,uuid:"Color_c2_2"}),f[3]=new ColorEffect(e,{source:m[3],fragmentChannel:2,uuid:"Color_c2_3"}),f[4]=new ColorEffect(e,{source:m[4],fragmentChannel:2,uuid:"Color_c2_4"});var g=new SolidSource(e,{color:{r:0,g:0,b:0},uuid:"Solid_Black"}),p=new SolidSource(e,{color:{r:0,g:0,b:0},fragmentChannel:2,uuid:"Solid_Black2"}),v=new Mixer(e,{source1:f[1],source2:g,uuid:"Mixer_1_a"}),_=new Mixer(e,{source1:f[2],source2:v,uuid:"Mixer_1_b"}),h=new Mixer(e,{source1:f[3],source2:p,uuid:"Mixer_2_a",fragmentChannel:2}),y=new Mixer(e,{source1:f[4],source2:h,uuid:"Mixer_2_b",fragmentChannel:2});new Output(e,_,y);console.log("CAKE Call renderer.init() --------------------"),e.init(),e.render(),void 0!==_&&_.pod(0),void 0!==v&&v.pod(1),setTimeout(()=>{document.getElementById("layer_fader_2").value=0,document.getElementById("layer_fader_1").value=1,l[1].pause(),l[2].pause()},1e3);for(var b=1,E=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],x=["add","substract","multiply","darken","color burn","linear burn","lighten","screen","color dodge","linear dodge","overlay","soft light","hard light","vivid light","linear light","pin light","difference","exclusion"],S=document.getElementById("layer_blendmode_2"),w=0;w<E.length;w++){var C=document.createElement("option");C.text=x[w],C.value=E[w],S.add(C)}function I(e){let n;console.log("new active laayer: ",e),b=e;for(let e=1;e<5;e++)(n=document.getElementById("layer_"+e)).classList.remove("active");(n=document.getElementById("layer_"+e)).classList.add("active")}let T=!1;async function M(e,n){console.log("fetchAndDisplayImages");try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok "+t.statusText);const r=await t.json(),o=document.getElementById(n);o.innerHTML="",r.forEach(e=>{const n=document.createElement("div");n.className="clip";const t=document.createElement("span"),r=e.replace("/video/DCVS01/DCVS01 ","");t.textContent=r,n.appendChild(t),n.onclick=(()=>(function(e){console.log("clip click:"+e),e="/video/"+e,j[b].time_last_beat=Date.now(),l[b].video.currentTime=0,l[b].src(e),l[b].pause()})(e)),o.appendChild(n)})}catch(e){console.error("Error fetching images:",e)}}M("http://localhost:4000/files/DCVS01","clip_bank_1"),M("http://localhost:4000/files/disco","clip_bank_2");const U=await async function(e){console.log("fetchFileDirs");try{const n=await fetch(e);if(!n.ok)throw new Error("Network response was not ok "+n.statusText);return await n.json()}catch(e){console.error("Error fetching images:",e)}}("http://localhost:4000/dirs/");var B=document.getElementById("clip_bank_select_1");U.forEach(e=>{var n=document.createElement("option");n.text=e,n.value=e,B.add(n)});var D=document.getElementById("clip_bank_select_2");U.forEach(e=>{var n=document.createElement("option");n.text=e,n.value=e,D.add(n)}),B.oninput=function(){console.log("clip_bank_select_1 >>",this.value),M("http://localhost:4000/files"+this.value,"clip_bank_1")},D.oninput=function(){console.log("clip_bank_select_2 >>",this.value),M("http://localhost:4000/files"+this.value,"clip_bank_2")};let k=0;function R(e,n,t,r){let o=e.video;if(null==o||"Video"!=e.type2)return;if(0==r.is_playing)return;if(1==r.is_scrubbing)return;let a=o.duration;-1!=r.out&&(a=r.out);let u=0;-1!=r.in&&(u=r.in);let c=a-u,i=(Date.now()-r.time_last_beat)/1e3;if(r.just_reversed){r.just_reversed=!1;let e=i/c,n=1-e-e;r.time_last_beat-=n*c*1e3,e=(i=(Date.now()-r.time_last_beat)/1e3)/c}let l=!1;i>c&&(console.log("loop normal"),l=!0),r.bpm_on&&r.bpm_mode==G&&s.render2(r.bpm_factor)<r.last_bpm_tap_render&&(console.log("loop BPM"),l=!0),r.last_bpm_tap_render=s.render2(r.bpm_factor),l&&(i=0,r.time_last_beat=Date.now(),r.is_bounce_reverse=!r.is_bounce_reverse),l=!1;let d=i/c;r.bpm_on&&(r.bpm_mode==P?d=s.render2(r.bpm_factor):r.bpm_mode);let m=0;r.play_mode==F?m=u+d*c:r.play_mode==H?m=u+(1-d)*c:r.play_mode==L&&(m=0==r.is_bounce_reverse?u+d*c:u+(1-d)*c),isFinite(m)?o.currentTime=m:console.log("warn updateVideo infinite time");var f=document.getElementById("layer_time_"+t);f&&(f.value=o.currentTime/o.duration)}function A(e,n){n!=j[e].play_mode&&(j[e].just_reversed=!0),j[e].play_mode=n}const F="FORWARD",H="REVERSE",L="BOUNCE",z="RANDOM",P="STRETCH",G="CUT";let V=!1,N=-1,O=!1,W=-1,j=new Array;for(let e=1;e<5;e++)j[e]=(j[e],{is_playing:!1,play_mode:F,bpm_on:!1,bpm_mode:P,bpm_factor:1,in:-1,out:-1,time_last_beat:Date.now(),just_reversed:!1,is_bounce_reverse:!1,last_bpm_tap_render:0,is_scrubbing:!1,is_jogging:!1,jog_start_x:-1});function K(e){-1==j[e].in?(j[e].in=l[e].video.currentTime,j[e].time_last_beat=Date.now(),document.getElementById("layer_in_"+e).classList.add("active")):(console.log("time_last_beat",j[e].time_last_beat),j[e].time_last_beat=j[e].time_last_beat-1e3*j[e].in,console.log("time_last_beat",j[e].time_last_beat),j[e].in=-1,document.getElementById("layer_in_"+e).classList.remove("active")),console.log("setInOnLayer",j[e].in)}function q(e){-1==j[e].out?(j[e].out=l[e].video.currentTime,document.getElementById("layer_out_"+e).classList.add("active")):(j[e].out=-1,document.getElementById("layer_out_"+e).classList.remove("active")),console.log("setOutOnLayer",j[e].out)}function $(){"TAP_PHASE_SET_LENGTH"==s.tapCake()?document.getElementById("bpm_tap_btn").classList.add("bpm-set-length"):document.getElementById("bpm_tap_btn").classList.remove("bpm-set-length"),document.getElementById("bpm_display").textContent=Math.round(s.bpm),document.getElementById("bpm_slide").value=Math.round(s.bpm)}function Z(){s.resetCake(),document.getElementById("bpm_reset").classList.add("phase")}(function e(){0==k&&(R(l[1],0,"1",j[1]),R(l[2],0,"2",j[2]),R(l[3],0,"3",j[3]),R(l[4],0,"4",j[4])),3==++k&&(k=0);s.render2(1);requestAnimationFrame(e)})(),document.getElementById("bpm_reset").onmousedown=function(){Z()},document.getElementById("bpm_tap_btn").onmousedown=function(){$()},document.getElementById("bpm_slide").oninput=function(){let e=Math.round(document.getElementById("bpm_slide").value);document.getElementById("bpm_display").textContent=e,s.setBpm(e)},document.getElementById("pause_all").onmousedown=function(){console.log("pause all button clicked"),console.log("pauseAll"),j[1].is_playing=!1,j[2].is_playing=!1,j[3].is_playing=!1,j[4].is_playing=!1},document.getElementById("effect_slide_feedback").oninput=function(){let n=this.value;e.setFeedbackEffect(n)},document.getElementById("effect_slide_rotate_vel_1").oninput=function(){let n=this.value;e.setRotationVel1(parseFloat(n))},document.getElementById("effect_slide_rotate_accel_1").oninput=function(){let n=this.value;e.setRotationAccel1(parseFloat(n))},document.getElementById("effect_slide_rotate_vel_2").oninput=function(){let n=this.value;e.setRotationVel2(parseFloat(n))},document.getElementById("rotate_vel_reset_1").onmousedown=function(){e.resetRotationVel1(),document.getElementById("effect_slide_rotate_vel_1").value=0},document.getElementById("rotate_accel_reset_1").onmousedown=function(){e.resetRotationAccel1(),document.getElementById("effect_slide_rotate_vel_1").value=0,document.getElementById("effect_slide_rotate_accel_1").value=0},document.getElementById("rotate_vel_reset_2").onmousedown=function(){e.resetRotationVel2(),document.getElementById("effect_slide_rotate_vel_2").value=0},document.getElementById("word_input_main").oninput=function(e){console.log("word",this.value),document.getElementById("word_main").textContent=this.value},document.getElementById("word_input_left").oninput=function(e){console.log("word",this.value),document.getElementById("word_left").textContent=this.value},document.getElementById("word_input_right").oninput=function(e){console.log("word",this.value),document.getElementById("word_right").textContent=this.value},document.getElementById("words_on").onmousedown=function(){!function(){T=!T;let e=document.getElementById("word_main"),n=document.getElementById("word_left"),t=document.getElementById("word_right");T?(e.classList.add("show"),n.classList.add("show"),t.classList.add("show")):(e.classList.remove("show"),n.classList.remove("show"),t.classList.remove("show"))}()}}function Controller(e){this.type="Controller",this.testControllerVar="test",this.init=function(){},this.update=function(){},this.render=function(){}}function GamePadController(e,n){var t=this;t.uuid="GamePadController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Control",t.controllers={},t.gamepad={},t.bypass=!0,t.debug=!1,t.gamepad_index=0,e.add(t);t.connect=function(){console.log("start gamepads"),window.addEventListener("gamepadconnected",function(e){console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),t.init()}),window.addEventListener("gamepaddisconnected",function(e){console.log("Gamepad disconnected from index %d: %s",e.gamepad.index,e.gamepad.id)}),t.bypass=!1},t.init=function(){console.log("init GamePadController."),setTimeout(function(){try{t.connect()}catch(e){console.log("Initial connect failed, hope somebody presses the button v14 ",t,e)}},1200)},t.update=function(){if(!t.bypass){if(t.debug&&console.log(navigator.getGamepads()[0].axes),t.debug&&console.log(navigator.getGamepads()[0].buttons),void 0===navigator.getGamepads()[t.gamepad_index]||null===navigator.getGamepads()[0])return console.log("Gamepad: No gamepad could be found"),void(t.bypass=!0);navigator.getGamepads()[t.gamepad_index].axes.forEach(function(e,n){o([n+100,e])}),navigator.getGamepads()[t.gamepad_index].buttons.forEach(function(e,n){e.pressed&&(t.debug&&console.log(" Button: ",n,e.value,e),o([n,e.value]))})}},t.render=function(){return t.controllers};var r=[];self.removeEventListener=function(){},t.addEventListener=function(e,n){r.push({target:e,callback:n}),console.log("Gamepad listeners: ",r)};var o=function(e){r.forEach(function(n,t){e[0]==n.target&&n.callback(e)})};t.getNodes=function(){return r}}function KeyboardController(e,n){var t=this;t.uuid="KeyboardController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Control",t.controllers={},t.keyboard={},t.bypass=!0,t.debug=!1,e.add(t);t.init=function(){console.log("init KeyboardController."),document.addEventListener("keydown",e=>{t.debug&&console.log(" down ",[e.keyCode,1]),o([e.keyCode,1])}),document.addEventListener("keyup",e=>{t.debug&&console.log(" up ",[e.keyCode,0]),o([e.keyCode,0])})},t.update=function(){t.bypass},t.render=function(){return t.controllers};var r=[];self.removeEventListener=function(){},t.addEventListener=function(e,n){r.push({target:e,callback:n}),console.log("Keyboard listeners: ",r)};var o=function(e){r.forEach(function(n,t){e[0]==n.target&&n.callback(e)})};t.getNodes=function(){return r}}function MidiController(e){var n=this;n.uuid="MidiController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="MidiController",n.bypass=!0,n.debug=!1,n.ready=!1,n.controllers={};var t,r,a=[];console.log("Midi check... "),navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(function(e){var a=(t=e).inputs.values(),u=t.outputs.values();for(i=a.next();i&&!i.done;i=a.next())i.value.onmidimessage=n.onMIDIMessage;for(o=u.next();o&&!o.done;o=u.next())r=o.value;console.log("Midi READY? ",r,t),null!=r&&(n.ready=!0),null!=r&&(n.bypass=!1)},function(e){console.error("No access to your midi devices.",e)});n.onMIDIMessage=function(e){n.debug&&console.log(" MIDIMESSAGE >>",e.data),u(e)},n.init=function(){},n.update=function(){},n.send=function(e){n.ready?(console.log("Midi send ",e,"to",r),r.send(e)):console.log("Midi is not ready yet")},n.clear=function(){for(var e=[],n=0;n++;n<100)e.push(144,n,0);r.send(e)},self.removeEventListener=function(e){a.forEach(function(n,t){if(n.target==e);}),a.splice(i,1)},n.addEventListener=function(e,n){a.push({target:e,callback:n}),console.log("MIDI listeners: ",a)};var u=function(e){a.forEach(function(n){n.target==e.data[1]&&n.callback(e.data)})}}function SocketController(e){var n=this;n.io=io.connect(),n.uuid="SocketController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Control",n.bypass=!0,n.title="",n.debug=!1,n.socket_pairing_id="no_paring_id",n.target="";var t=[];e&&"title"in e&&(n.title=e.title),n.io.on("test",function(e){console.log("got test",e)}),n.io.on("command",function(e){console.log("got command",e),"welcome"==e.command&&(n.target=e.payload,t.forEach(function(n,t){"welcome"!=n.target&&"ready"!=n.target||n.callback(e.payload)})),"reset_uuid"==e.command&&(console.log("reset uuid",e.payload),n.target=e.payload,t.forEach(function(n,t){"reset_uuid"!=n.target&&"reset"!=n.target||n.callback(e.payload)})),document.getElementById("sockets")&&(document.getElementById("sockets").innerHTML+="<div>"+n.title+" Socket: "+n.target+"</div>")}),n.io.on("controller",function(e){n.debug&&console.log("got controller",e),t.forEach(function(t,r){n.debug&&console.log("find node",r,t,e,n.target),e.client==n.target&&t.target==e.trigger&&(n.debug&&console.log("execute callback!"),t.callback(e.commands))})}),n.send=function(e,t,r){n.debug&&console.log("Socket send to: ",e,", trigger:",t," commands ",r),n.io.emit("controller",{client:e,trigger:t,commands:r})},self.removeEventListener=function(e){t.forEach(function(n,t){if(n.target==e);}),t.splice(i,1)},n.addEventListener=function(e,n){t.push({target:e,callback:n}),console.log("Socket listeners: ",t)}}function SourceControl(e,n){}function Effect(e,n){this.type="Effect",this.init=function(){},this.update=function(){},this.render=function(){}}function ColorEffect(e,n){var t=this;null==n.uuid?t.uuid="ColorEffect_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,null==n.fragmentChannel?t._fragmentChannel=1:t._fragmentChannel=n.fragmentChannel,e.add(t),t.type="Effect",t.debug=!1;var r=n.source,o=1;null!=n.effect&&(o=n.effect);var a=.8;null!=n.extra&&(a=n.currentExtra);t.init=function(){var n;console.log("ColorEffect init"),e.customUniforms[t.uuid+"_currentcoloreffect"]={type:"i",value:o},e.customUniforms[t.uuid+"_extra"]={type:"f",value:a},-1==(n=(n=(n=(n=1==t._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+t.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+t.uuid+"_currentcoloreffect;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+t.uuid+"_extra;\n/* custom_uniforms */")).indexOf("vec4 coloreffect ( vec4 src, int currentcoloreffect, float extra, vec2 vUv )")&&(console.log("ColorEffect REPLACE"),n=n.replace("/* custom_helpers */","\n/*\nfloat rand ( float seed ) {\n  return fract(sin(dot(vec2(seed) ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvec2 displace(vec2 co, float seed, float seed2) {\n  vec2 shift = vec2(0);\n  if (rand(seed) > 0.5) {\n      shift += 0.1 * vec2(2. * (0.5 - rand(seed2)));\n  }\n  if (rand(seed2) > 0.6) {\n      if (co.y > 0.5) {\n          shift.x *= rand(seed2 * seed);\n      }\n  }\n  return shift;\n}\n\nvec4 interlace(vec2 co, vec4 col) {\n  if (int(co.y) % 3 == 0) {\n      return col * ((sin(time * 4.) * 0.1) + 0.75) + (rand(time) * 0.05);\n  }\n  return col;\n}\n*/\n\n// bool mask_circle(vec2 uv, float radius, float x, float y){\n    \n//   uv.x *= 1.6; \n//   // uv.y *= 0.75;\n//   float len = sqrt(pow((uv.x - x),2.0) + pow(uv.y - y,2.0));\n//   if(len < radius){\n//     return true;\n//   }\n//   return false;\n// }\n\nvec4 coloreffect ( vec4 src, int currentcoloreffect, float extra, vec2 vUv ) {\n  if ( currentcoloreffect == 1 ) return vec4( src.rgba );                                                                                              // normal\n\n\n  //toph lum - BLACK GOES TRANSPARENT\n  if ( currentcoloreffect == 100 ) {\n    float brightness = (src.r + src.g + src.b) / 3.0;\n\n    float alpha = .0;\n    if (extra < brightness){\n      alpha = 1.0;\n    }\n    return vec4( src.r, src.g, src.b, alpha );\n  }\n\n  if ( currentcoloreffect == 102 ) {\n    float brightness = (src.r + src.g + src.b) / 3.0 ;\n\n    float alpha = 1.0;\n    if (extra < brightness){\n      alpha = 0.0;\n    }\n    return vec4( src.r, src.g, src.b, alpha );\n  }\n\n\n  // toph circle mask\n  if ( currentcoloreffect == 101 ) {\n    \n    // gl_FragCoord.xy; is 640x480\n    // u_resolution.xy is 640x480\n    /* vec2 uv = gl_FragCoord.xy; */\n    //vec2 uv = gl_FragCoord.xy/u_resolution.xy - 0.5; // 0 to 1\n    /* uv.x *= u_resolution.x/u_resolution.y; */\n\n    // return src;\n\n    // vec2 uv = vUv.xy;\n    vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5);\n    float radius = 0.2;\n    float x = -0.2;\n    float y = +0.0;\n    float scale = 4.0;\n\n    if(mask_circle(uv, radius, x, y)  || mask_circle(uv, radius, -x, y)) {\n      gl_FragColor = src;\n    }else{\n    \tgl_FragColor = vec4(0.0, 0.0, 0.3, 1.0);\t\n    }\n    return gl_FragColor;\n  }\n\n  // negative\n  // negative 3 (reversed channel)\n  if ( currentcoloreffect == 2  ) return vec4( 1.-src.r, 1.-src.g, 1.-src.b, src.a );\n  // negative 3 (inverted channel high)\n  if ( currentcoloreffect == 3  ) return vec4( 1./src.r-1.0, 1./src.g-1.0, 1./src.b-1.0, src.a );\n  // negative 3 (inverted channel, low)\n  if ( currentcoloreffect == 4  ) return vec4( 1./src.r-2.0, 1./src.g-2.0, 1./src.b-2.0, src.a );\n  // negative 4 (inverted colors, inverted bw )\n  if ( currentcoloreffect == 5  ) return vec4( src.g + src.b / 2., src.r + src.b / 2., src.r + src.b / 2., src.a );\n  // negative 5 (normal colors, inverted b/w)\n  if ( currentcoloreffect == 6  ) return vec4( ( (src.r/2.) + ( ( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).r) ), ( (src.g/2.) + (( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).g) ), ( (src.b/2.) + ( ( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).b) ), src.a );\n\n  // monocolor\n  if ( currentcoloreffect == 10 ) return vec4( vec3( src.r + src.g + src.b ) / 3., src.a );                                                            // black and white\n  if ( currentcoloreffect == 11 ) return vec4( vec3( (src.r+src.g+src.b) *3.  , (src.r+src.g+src.b)  /1.7 , (src.r+src.g+src.b) /1.7 ) / 3., src.a );  // mopnocolor red\n  if ( currentcoloreffect == 12 ) return vec4( vec3( (src.r+src.g+src.b) /1.7 , (src.r+src.g+src.b)  *3.  , (src.r+src.g+src.b) /1.7 ) / 3., src.a );  // mopnocolor blue\n  if ( currentcoloreffect == 13 ) return vec4( vec3( (src.r+src.g+src.b) /1.7 , (src.r+src.g+src.b)  /1.7 , (src.r+src.g+src.b) *3.  ) / 3., src.a );  // mopnocolor green\n  if ( currentcoloreffect == 14 ) return vec4( vec3( (src.r+src.g+src.b) *2.  , (src.r+src.g+src.b)  *2.  , (src.r+src.g+src.b) /1.2 ) / 3., src.a );  // mopnocolor yellow\n  if ( currentcoloreffect == 15 ) return vec4( vec3( (src.r+src.g+src.b) *1.2 , (src.r+src.g+src.b)  *2.  , (src.r+src.g+src.b) *2.  ) / 3., src.a );  // mopnocolor turqoise\n  if ( currentcoloreffect == 16 ) return vec4( vec3( (src.r+src.g+src.b) *2.  , (src.r+src.g+src.b)  /1.2 , (src.r+src.g+src.b) *2.  ) / 3., src.a );  // mopnocolor purple\n  if ( currentcoloreffect == 17 ) return vec4( vec3( src.r + src.g + src.b ) / 3. * vec3( 1.2, 1.0, 0.8 ), src.a);                                     // sepia\n\n  // color swapping\n  if ( currentcoloreffect == 20 ) return vec4( src.rrra );\n  if ( currentcoloreffect == 21 ) return vec4( src.rrga );\n  if ( currentcoloreffect == 22 ) return vec4( src.rrba );\n  if ( currentcoloreffect == 23 ) return vec4( src.rgra );\n  if ( currentcoloreffect == 24 ) return vec4( src.rgga );\n  if ( currentcoloreffect == 25 ) return vec4( src.rbra );\n  if ( currentcoloreffect == 26 ) return vec4( src.rbga );\n  if ( currentcoloreffect == 27 ) return vec4( src.rbba );\n  if ( currentcoloreffect == 28 ) return vec4( src.grra );\n  if ( currentcoloreffect == 29 ) return vec4( src.grga );\n  if ( currentcoloreffect == 30 ) return vec4( src.grba );\n  if ( currentcoloreffect == 31 ) return vec4( src.ggra );\n  if ( currentcoloreffect == 32 ) return vec4( src.ggga );\n  if ( currentcoloreffect == 33 ) return vec4( src.ggba );\n  if ( currentcoloreffect == 34 ) return vec4( src.gbra );\n  if ( currentcoloreffect == 35 ) return vec4( src.gbga );\n  if ( currentcoloreffect == 36 ) return vec4( src.gbba );\n  if ( currentcoloreffect == 37 ) return vec4( src.brra );\n  if ( currentcoloreffect == 38 ) return vec4( src.brga );\n  if ( currentcoloreffect == 39 ) return vec4( src.brba );\n  if ( currentcoloreffect == 40 ) return vec4( src.bgra );\n  if ( currentcoloreffect == 41 ) return vec4( src.bgga );\n  if ( currentcoloreffect == 42 ) return vec4( src.bgba );\n  if ( currentcoloreffect == 43 ) return vec4( src.bbra );\n  if ( currentcoloreffect == 44 ) return vec4( src.bbga );\n  if ( currentcoloreffect == 45 ) return vec4( src.bbba );\n\n  // lum key\n  if ( currentcoloreffect == 50 ) {\n    float red = clamp( src.r, extra, 1.) == extra ? .0 : src.r;\n    float green = clamp( src.g, extra, 1.) == extra ? .0 : src.g;\n    float blue = clamp( src.b, extra, 1.) == extra ? .0 : src.b;\n    float alpha = red + green + blue == .0 ? .0 : src.a;\n    return vec4( red, green, blue, alpha );\n  }\n\n\n\n  // color key; Greenkey\n  if ( currentcoloreffect == 51 ) {\n    return vec4( src.r, clamp( src.r, extra, 1.) == extra ? .0 : src.g, src.b, clamp( src.r, extra, 1.) == extra ? .0 : src.a );\n  }\n\n  // paint\n  if ( currentcoloreffect == 52 ) {\n    // return vec4( floor( src.r * extra ) / extra, floor( src.g * extra ) / extra, floor( src.b * extra ) / extra, src.a  );\n    // devide the image up in color bars\n    vec4 pnt = vec4(\n      src.x < .1 ? .1 : src.x < .2 ? .2 : src.x < .3 ? .3 : src.x < .4 ? .4 : src.x < .5 ? .5 : src.x < .6 ? .6 : src.x < .7 ? .7 : src.x < .8 ? .8 : src.x < .9 ? .9 : src.x,\n      src.y < .1 ? .1 : src.y < .2 ? .2 : src.y < .3 ? .3 : src.y < .4 ? .4 : src.y < .5 ? .5 : src.y < .6 ? .6 : src.y < .7 ? .7 : src.y < .8 ? .8 : src.y < .9 ? .9 : src.y,\n      src.z < .1 ? .1 : src.z < .2 ? .2 : src.z < .3 ? .3 : src.z < .4 ? .4 : src.z < .5 ? .5 : src.z < .6 ? .6 : src.z < .7 ? .7 : src.z < .8 ? .8 : src.z < .9 ? .9 : src.z,\n      src.a\n    );\n\n    return pnt;\n  }\n\n  // colorise\n  if ( currentcoloreffect == 53 ) {\n\n    // TODO: mix paint and colorize together?\n\n    // devide the image up in color bars\n    vec4 pnt = vec4(\n      src.x < .1 ? .1 : src.x < .2 ? .2 : src.x < .3 ? .3 : src.x < .4 ? .4 : src.x < .5 ? .5 : src.x < .6 ? .6 : src.x < .7 ? .7 : src.x < .8 ? .8 : src.x < .9 ? .9 : src.x,\n      src.y < .1 ? .1 : src.y < .2 ? .2 : src.y < .3 ? .3 : src.y < .4 ? .4 : src.y < .5 ? .5 : src.y < .6 ? .6 : src.y < .7 ? .7 : src.y < .8 ? .8 : src.y < .9 ? .9 : src.y,\n      src.z < .1 ? .1 : src.z < .2 ? .2 : src.z < .3 ? .3 : src.z < .4 ? .4 : src.z < .5 ? .5 : src.z < .6 ? .6 : src.z < .7 ? .7 : src.z < .8 ? .8 : src.z < .9 ? .9 : src.z,\n      src.a\n    );\n\n    // colorize effect, fill the colors with random values\n    ( pnt.r == .1 || pnt.g == .1 || pnt.b == .1 ) ? pnt.rgb = vec3( 1.0, 0.0, 0.0) : pnt.rgb;\n    ( pnt.r == .2 || pnt.g == .2 || pnt.b == .2 ) ? pnt.rgb = vec3( 0.0, 1.0, 0.0) : pnt.rgb;\n    ( pnt.r == .3 || pnt.g == .3 || pnt.b == .3 ) ? pnt.rgb = vec3( 0.0, 0.0, 1.0) : pnt.rgb;\n    ( pnt.r == .4 || pnt.g == .4 || pnt.b == .4 ) ? pnt.rgb = vec3( 1.0, 1.0, 0.0) : pnt.rgb;\n    ( pnt.r == .5 || pnt.g == .5 || pnt.b == .5 ) ? pnt.rgb = vec3( 0.0, 1.0, 1.0) : pnt.rgb;\n    ( pnt.r == .6 || pnt.g == .6 || pnt.b == .6 ) ? pnt.rgb = vec3( 1.0, 0.0, 1.0) : pnt.rgb;\n    ( pnt.r == .7 || pnt.g == .7 || pnt.b == .7 ) ? pnt.rgb = vec3( 1.0, 0.49, 0.49) : pnt.rgb;\n    ( pnt.r == .8 || pnt.g == .8 || pnt.b == .8 ) ? pnt.rgb = vec3( 0.49, 1.0, 0.49) : pnt.rgb;\n    ( pnt.r == .9 || pnt.g == .9 || pnt.b == .9 ) ? pnt.rgb = vec3( 0.49, 0.49, 1.0) : pnt.rgb;\n\n    return pnt;\n  }\n\n  // BRIGHTNESS [ 0 - 1 ]\n  // http://blog.ruofeidu.com/postprocessing-brightness-contrast-hue-saturation-vibrance/\n  if ( currentcoloreffect == 60 ) {\n    return vec4( src.rgb + extra, src.a );\n    //return vec4( src.rgb ^ (extra+1), src.a );\n  }\n\n  // CONTRAST [ 0 - 3 ]\n  if ( currentcoloreffect == 61 ) {\n    extra = extra * 3.;\n    float t = 0.5 - extra * 0.5;\n    src.rgb = src.rgb * extra + t;\n    return vec4( src.rgb, src.a );\n  }\n\n  // SATURATION [ 0 - 5 ]\n  if ( currentcoloreffect == 62 ) {\n    extra = extra * 5.;\n    vec3 luminance = vec3( 0.3086, 0.6094, 0.0820 );\n    float oneMinusSat = 1.0 - extra;\n    vec3 red = vec3( luminance.x * oneMinusSat );\n    red.r += extra;\n\n    vec3 green = vec3( luminance.y * oneMinusSat );\n    green.g += extra;\n\n    vec3 blue = vec3( luminance.z * oneMinusSat );\n    blue.b += extra;\n\n    return mat4(\n      red,     0,\n      green,   0,\n      blue,    0,\n      0, 0, 0, 1 ) * src;\n  }\n\n  // SHIFT HUE\n  if ( currentcoloreffect == 63 ) {\n    vec3 P = vec3(0.55735) * dot( vec3(0.55735), src.rgb );\n    vec3 U = src.rgb - P;\n    vec3 V = cross(vec3(0.55735), U);\n    src.rgb = U * cos( extra * 6.2832) + V * sin( extra * 6.2832) + P;\n    return src;\n  }\n\n  // hard black edge\n  if ( currentcoloreffect == 64 ) {\n    src.r + src.g + src.b > extra * 3.0? src.rgb = vec3( 1.0, 1.0, 1.0 ) : src.rgb = vec3( 0.0, 0.0, 0.0 );\n    return src;\n  }\n\n  // greenkey\n  if ( currentcoloreffect == 80 ) {\n    float temp_g = src.g;\n\n    //if ( src.g > 0.99 ) { // 135\n    if ( src.g > 0.2 && src.r < 0.2 && src.b < 0.2 ){\n      src.r = 0.0;\n      src.g = 0.0;\n      src.b = 0.0;\n      src.a = 0.0;\n    }\n\n    if ( src.g > 0.2 && src.r < 0.2 && src.b < 0.2 ){\n      src.r + src.g + src.b > extra * 3.0? src.rgb = vec3( 1.0, 1.0, 1.0 ) : src.rgb = vec3( 0.0, 0.0, 0.0 );\n    }\n\n\n    float maxrb = max( src.r, src.b );\n    float k = clamp( (src.g-maxrb)*5.0, 0.0, 1.0 );\n\n    //float ll = length( src );\n    //src.g = min( src.g, maxrb*0.8 );\n    //src = ll*normalize(src);\n\n    return vec4( mix(src.xyz, vec3(0.0, 0.0, 0.0), k), src.a );\n\n    //return vec4( src.xyz, src.a );\n    //return src;\n  }\n\n  // greenkey 2\n  if ( currentcoloreffect == 81 ) {\n\n    float maxrb = max( src.r, src.b );\n    float k = clamp( (src.g-maxrb)*5.0, 0.0, 1.0 );\n\n    //\n\n    //float ll = length( src );\n    //src.g = min( src.g, maxrb*0.8 );\n    //src = ll*normalize(src);\n\n    //else\n\n    //float dg = src.g;\n    //src.g = min( src.g, maxrb*0.8 );\n    //src += dg - src.g;\n\n    //#endif\n\n    vec3 bg = src.xyz;\n    bg.r = 0.0;\n    bg.g = 0.0;\n    bg.b = 0.0;\n\n    return vec4( mix(src.xyz, bg, k), mix( 1.0, 0.0, k) );\n    //return src;\n  }\n\n  if ( currentcoloreffect == 70 ) {\n    return src;\n  }\n\n\n\n\n\n  // default\n  return src;\n}\n\n/* custom_helpers */\n")),n=n.replace("/* custom_main */","vec4 "+t.uuid+"_output = coloreffect( "+r.uuid+"_output, "+t.uuid+"_currentcoloreffect, "+t.uuid+"_extra, vUv );\n  /* custom_main */"),1==t._fragmentChannel?e.fragmentShader=n:e.fragmentShader2=n},t.update=function(){},t.effect=function(n){return null!=n&&(o=n,console.log("effect set to: ",o),e.customUniforms[t.uuid+"_currentcoloreffect"].value=o),o},t.extra=function(n){return null!=n&&(a=n,e.customUniforms[t.uuid+"_extra"].value=a),t.debug&&console.log("extra set to: ",a),a}}function DistortionEffect2(e,n){var t=this;null==n.uuid?t.uuid="DistortionEffect2_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,null==n.fragmentChannel?t._fragmentChannel=1:t._fragmentChannel=n.fragmentChannel,e.add(t),t.type="Effect";var r=n.source,o=n.effect,a=(o=1,.8),u=0;t.init=function(){var n;e.customUniforms[t.uuid+"_currentDistortionEffect2"]={type:"i",value:1},e.customUniforms[t.uuid+"_extra"]={type:"f",value:2},e.customUniforms[t.uuid+"_extra2"]={type:"f",value:2},-1==(n=(n=(n=(n=(n=1==t._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+t.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+t.uuid+"_currentDistortionEffect2;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+t.uuid+"_extra;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+t.uuid+"_extra2;\n/* custom_uniforms */")).indexOf("vec4 DistortionEffect2 ( sampler2D src, int currentDistortionEffect2, float extra, float extra2, vec2 vUv )")&&(console.log("DistortionEffect2 REPLACE"),n=n.replace("/* custom_helpers */","\n\n  bool mask_circle(vec2 uv, float radius, float x, float y){\n      \n    // uv.x *= 1.6; \n     uv.y /= (16.0 / 9.0);\n    float len = sqrt(pow((uv.x - x),2.0) + pow(uv.y - y,2.0));\n    if(len < radius){\n      return true;\n    }\n    return false;\n  }\n  \n  bool tophTest(float a){\n    return true;\n  }\n  \n  vec4 DistortionEffect2 ( sampler2D src, int currentDistortionEffect2, float extra, float extra2, vec2 vUv ) {\n    \n    // normal\n    if ( currentDistortionEffect2 == 1 ) {\n      return texture2D( src, vUv ).rgba;\n    }\n  \n    //ONLY CIRCLE\n    if ( currentDistortionEffect2 == 105 ) {\n  \n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      float radius = 0.28;\n      float scale = 1.0; //Size of video.\n  \n      if(mask_circle(uv, radius, 0.0, 0.0)) {\n        vec2 uvs = vec2(uv);\n        uvs *= scale;\n        vec4 pixelColor = texture2D(src, vec2(uvs.x + 0.5, uvs.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0);\t\n        discard;\n      }\n      return gl_FragColor;\n    }//105\n  \n    //MIRROR_VERTICAL\n    if ( currentDistortionEffect2 == 106 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n      if (uv.y >= 0.0){\n       pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      }else{\n        pixelColor = texture2D(src, vec2(uv.x + 0.5, -uv.y + 0.5)); \n      }\n      // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n      gl_FragColor = vec4(pixelColor);\n      return gl_FragColor;\n    }//MIRROR_VERTICAAL\n  \n    //MIRROR_HORIZONTAL\n    if ( currentDistortionEffect2 == 107 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n      if (uv.x > 0.0){\n        pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      }else{\n        pixelColor = texture2D(src, vec2(-uv.x + 0.5, uv.y + 0.5)); \n      }\n      // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n      gl_FragColor = vec4(pixelColor);\n      return gl_FragColor;\n    }//MIRROR_VERTICAAL\n\n      //MIRROR_BOTH\n    if ( currentDistortionEffect2 == 109 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n\n      if (uv.x > 0.0){\n        if (uv.y >= 0.0){\n          pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        }else{\n          pixelColor = texture2D(src, vec2(uv.x + 0.5, -uv.y + 0.5)); \n        }      \n      }else{\n        if (uv.y >= 0.0){\n          pixelColor = texture2D(src, vec2(-uv.x + 0.5, uv.y + 0.5));          \n        }else{\n          pixelColor = texture2D(src, vec2(-uv.x + 0.5, -uv.y + 0.5));        \n        }\n      }\n      gl_FragColor = vec4(pixelColor);\n\n        // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n\n      return gl_FragColor;\n    }//MIRROR_BOTH\n\n\n    //WIPE_HORIZONTAL\n    if ( currentDistortionEffect2 == 108 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      if (uv.x > (extra - 0.5)){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_HORIZONTAL\n  \n        //WIPE_VERTICAL\n    if ( currentDistortionEffect2 == 110 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      if (uv.y > (extra - 0.5)){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_VERTICAL\n\n\n\n     //WIPE_ANGLE\n    if ( currentDistortionEffect2 == 111 ) {\n\n    float ratio = extra;\n    float angle = extra2;\n      // Convert angle to radians\n      float angleRad = angle * 3.141 * 2.0;\n\n      // Calculate the direction of the wipe\n      vec2 direction = vec2(cos(angleRad), sin(angleRad));\n\n      // Compute the position relative to the center\n      vec2 center = vec2(0.5, 0.5);\n      vec2 relativePos = vUv - center;\n\n      // Project the relative position onto the direction vector\n      float projection = dot(relativePos, direction);\n\n      // Determine if the current pixel is before or after the wipe threshold\n      if (projection < ratio - 0.5) {\n          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); // Black\n      } else {\n          // gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0); // White\n        vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n          vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5));\n          gl_FragColor = vec4(pixelColor);\n      }\n\n      return gl_FragColor;\n    }//WIPE_ANGLE\n\n            //WIPE_DONUT\n    if ( currentDistortionEffect2 == 112 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n\n      vec2 p = vUv - 0.5;\n\t\t\t// float r = length(p)*2.0;\n\t\t\tfloat r = length(p);\n\n      if (r > extra){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_DONUT\n\n        //KALEIDO - https://github.com/mrdoob/three.js/blob/dev/examples/jsm/shaders/KaleidoShader.js\n    if ( currentDistortionEffect2 == 110 ) {\n\n\n      float sides = 0.0 + 20.0 * extra;\n      float angle = 1.0;\n      // float angle = 2.0 * extra2;\n      vec2 p = vUv - 0.5;\n\t\t\t// float r = length(p)*2.0;\n\t\t\tfloat r = length(p);\n\t\t\tfloat a = atan(p.y, p.x) + angle;\n\t\t\tfloat tau = 2. * 3.1416;\n\t\t\ta = mod(a, tau/sides);\n\t\t\ta = abs(a - tau/sides/2.) + extra2 * 3.14 ;\n\t\t\tp = r * vec2(cos(a), sin(a));\n\t\t\tvec4 color = texture2D(src, p + 0.5);\n\t\t\tgl_FragColor = color;\n\n      // vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      // if (uv.x > (extra - 0.5)){\n      //   vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      //   gl_FragColor = vec4(pixelColor);\n      // }else{\n      //   gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      // }\n\n      return gl_FragColor;\n    }//WIPE_HORIZONTAL\n  \n    \n  }\n  \n  \n  \n  \n    // -------------\n  \n\n  \n  /* custom_helpers */\n  \n  \n  ")),n=n.replace("/* custom_main */","      vec4 "+t.uuid+"_output = DistortionEffect2( "+r.uuid+", "+t.uuid+"_currentDistortionEffect2, "+t.uuid+"_extra, "+t.uuid+"_extra2, vUv );\n  /* custom_main */"),1==t._fragmentChannel?e.fragmentShader=n:e.fragmentShader2=n};t.update=function(){.001},t.effect=function(n){return null!=n&&(o=n,e.customUniforms[t.uuid+"_currentDistortionEffect2"]&&(e.customUniforms[t.uuid+"_currentDistortionEffect2"].value=n)),o},t.extra=function(n){return null!=n&&(a=n,e.customUniforms[t.uuid+"_extra"]&&(e.customUniforms[t.uuid+"_extra"].value=a)),n},t.extra2=function(n){return null!=n&&(u=n,e.customUniforms[t.uuid+"_extra2"]&&(e.customUniforms[t.uuid+"_extra2"].value=u)),n}}function FeedbackEffect(e,n){var t=this;null==n.uuid?t.uuid="FeedbackEffect_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,e.add(t),t.type="Effect";var r,o,a=n.source,u=n.effect,c=(u=12,.8),i=128*window.devicePixelRatio;new Uint8Array(i*i*3);t.init=function(){(r=document.createElement("canvas")).width=1024,r.height=1024,canvasElementContext=r.getContext("2d"),canvasElementContext.fillStyle="#000000",canvasElementContext.fillRect(0,0,1024,1024),console.log("FeedbackEffect inits, with",e),(o=new THREE.Texture(r)).wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.repeat.set(4,4),e.customUniforms[t.uuid+"_effectsampler"]={type:"t",value:o},e.customUniforms[t.uuid+"_currentfeedbackeffect"]={type:"i",value:u},e.customUniforms[t.uuid+"_extra"]={type:"i",value:c},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+t.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D  "+t.uuid+"_effectsampler;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform int  "+t.uuid+"_currentfeedbackeffect;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float  "+t.uuid+"_extra;\n/* custom_uniforms */"),-1==renderer.fragmentShader.indexOf("vec4 feedbackeffect ( vec4 src, int currentfeedbackeffect, vec2 vUv )")&&(e.fragmentShader=e.fragmentShader.replace("/* custom_helpers */","\n  vec4 feedbackeffect ( vec4 src, int currentfeedbackeffect, vec2 vUv ) {\n\n    if ( currentfeedbackeffect == 100 ) {\n      // vec4 inbetween = vec4( src.r, src.g, src.b, vUv * 0.9. );\n      // gl_Position = vec4( vec2(0.,0.), 0., 0.);\n      // return inbetween.rrr;\n      // return src;\n\n      // return vec4(0., 0., 1., 1.);\n\n      vec2 wuv = vec2(0.,0.);\n      // wuv = vUv * vec2( 1.0, 1.0 ) - vec2( 0., 0. );\n      wuv = vUv; //* vec2( 1.0, 1.0 ) - vec2( 0., 0. );\n      //wuv = vUv - vec2( 0.1, 0. );\n      // wuv = vUv + vec2( extra, extra );\n      // return texture2D( src, wuv ).rgba;\n\n      return vec4( vec4( ( texture2D( "+t.uuid+"_effectsampler, wuv ).rgba * 0.9 ) + (src.rgba * .6 ) ).rgb, 1.);\n\n      // return ( texture2D( , vUv + vec2( 1., 0.99999999) ).rgba ) + src * 0.3;\n\n      // return ( texture2D( "+t.uuid+"_effectsampler, vUv  ).rgb * 1.4 + src * .8) * 0.5; //* vec3(.5, .5, .5\n      // return ( texture2D( src, vUv ).rgb );\n      // return ( texture2D( "+t.uuid+"_effectsampler, vUv  ).rgb ) * src + src;\n\n      //vec4 wuv = wuv = vUv * vec2( extra*6., extra*6. ) - vec2( extra * 3., extra * 3. );\n      //vec4 tex = texture2D( "+t.uuid+"_effectsampler, wuv ); //+ vec4( src.r, src.g, src.b, vUv * 2. );\n\n      // return src.rrr;\n      // tex.rgb = vec3(src.r, src.g, src.b);\n      // tex.xy = vec2(1.0,1.0);\n      // tex = tex + vec4( src.r, src.g, src.b, vUv * 2. );\n\n\n      // * 0.52 + vec4( src * 0.52, vUv ) *\n      // vec4 tex = vec4( src, vUv * .5 );\n      // return mix( tex, "+t.uuid+"_effectsampler, 0.).rgb;\n      // return mix(tex.rgb, src.rgb, 1.);\n    }\n\n    // uniform float noiseScale;\n    // uniform float time;\n    // uniform float baseSpeed;\n    // uniform sampler2D noiseTexture;\n\n    if ( currentfeedbackeffect == 101 ) {\n      // vec2 uvTimeShift = vUv + vec2( -0.7, 1.5 ) * time * baseSpeed;\n      // vec4 noiseGeneratorTimeShift = texture2D( noiseTexture, uvTimeShift );\n      // vec2 uvNoiseTimeShift = vUv + noiseScale * vec2( noiseGeneratorTimeShift.r, noiseGeneratorTimeShift.a );\n\n      // _effectsampler\n      // return  vec4 texture2D( baseTexture1, uvNoiseTimeShift )\n\n      // https://stackoverflow.com/questions/19872524/threejs-fragment-shader-using-recycled-frame-buffers\n      // http://labs.sense-studios.com/webgl/index4.html?r=sdad\n\n      // return _effectsampler.rgb\n      return src;\n    }\n\n    return src;\n  }\n\n  /* custom_helpers */\n")),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+t.uuid+"_output = feedbackeffect( "+a.uuid+"_output, "+t.uuid+"_currentfeedbackeffect, vUv );\n  /* custom_main */")};new THREE.Vector2;var s=0;t.update=function(){if(s++,glcanvas=document.getElementById("glcanvas"),s%4==0){var e=1024*(1.6*c),n=(1024-e)/2;canvasElementContext.drawImage(glcanvas,n,n,e,e)}o&&(o.needsUpdate=!0)},t.effect=function(e){return null!=e&&(u=e,renderer.customUniforms[t.uuid+"_currentfeedbackeffect"].value=u),u},t.extra=function(e){return null!=e&&(c=e,renderer.customUniforms[t.uuid+"_extra"].value=c),c}}AudioAnalysis.prototype=new Addon,AudioAnalysis.constructor=AudioAnalysis,BPM.prototype=new Addon,BPM.constructor=BPM,FileManager.prototype=new Addon,FileManager.constructor=FileManager,GiphyManager.prototype=new Addon,GiphyManager.constructor=GiphyManager,document.body.onload=function(){console.log("--------- cake.js onload ------------"),start()},GamePadController.prototype=new Controller,GamePadController.constructor=GamePadController,KeyboardController.prototype=new Controller,KeyboardController.constructor=KeyboardController,MidiController.prototype=new Controller,MidiController.constructor=MidiController,SocketController.prototype=new Controller,SocketController.constructor=SocketController,ColorEffect.prototype=new Effect,ColorEffect.constructor=ColorEffect,DistortionEffect2.prototype=new Effect,DistortionEffect2.constructor=DistortionEffect2,FeedbackEffect.prototype=new Effect,FeedbackEffect.constructor=FeedbackEffect;import*as THREE from"three";const clock=new THREE.Clock,initial_texture=(new THREE.TextureLoader).load("./circles.jpg"),fb_fragment="\nuniform vec2 u_resolution;\nuniform sampler2D u_in_buffer;\nuniform sampler2D u_init_buffer;\nuniform float u_time;\nuniform float u_extra;\n\n#define UV_ORIGIN 0.5\n#define ZOOM 1.00\n#define SPEED 1.01\nconst float PI = 3.14;\n\n// Take this and multiply your UV by the resulting mat2 to get the rotation\nmat2 rotationMatrix(float angle)\n{\n\tangle *= PI / 180.0;\n    float sine = sin(angle), cosine = cos(angle);\n    return mat2( cosine, -sine, \n                 sine,    cosine );\n}\n\nvoid main() {\n  // vec2 uv = gl_FragCoord.xy / u_resolution;\n\n    vec2 st = gl_FragCoord.xy / u_resolution;\n    vec2 uv = st;\n\n    // Float around\n    // uv *= vec2(1. + 0.02 * sin(u_time / 10.), 1. - 0.02 * cos(u_time/2.));\n\n    // Zoom\n    float zoom = .02;\n    uv *= vec2(1. - (uv.x - 0.5) *zoom, 1. - (uv.y - 0.5)* zoom);\n\n    // Rotate\n\n    // vec2 pivot = vec2(0.5, 0.5);\n    // uv -= pivot;\n    // uv *= rotationMatrix( 0.2) * ZOOM;\n    //  uv += pivot;\n\n\n    vec4 sum = texture2D(u_in_buffer, uv);\n    vec4 src = texture2D(u_init_buffer, st);\n\n    //Invert?\n    // sum = vec4( 1.-sum.r, 1.-sum.g, 1.-sum.b, sum.a );\n// src = vec4( 1.-src.r, 1.-src.g, 1.-src.b, src.a );\n\n    sum.rgb = mix(sum.rbg, src.rgb, (1.0 - u_extra));\n\n  \n    gl_FragColor = sum;\n}\n";let material_in,material_out;var GlRenderer=function(e){console.log("START GlRenderer  -------------------");var n=this;n.options={element:"glcanvas"},null!=e&&(n.options=e),n.options.canvas?n.element=n.options.canvas:n.element=document.getElementById(n.options.element),n.onafterrender=function(){},n.setFeedbackEffect=function(e){n.u_extra=e},n.setRotationVel1=function(e){n.rotation_vel_1=e},n.setRotationVel2=function(e){n.rotation_vel_2=e},n.setRotationAccel1=function(e){n.rotation_accel_1=e},n.resetRotationVel1=function(){n.rotation_vel_1=0,n.surface.rotation.z=0},n.resetRotationVel2=function(){n.rotation_vel_2=0,n.surface2.rotation.z=0,n.surface3.rotation.z=0},n.resetRotationAccel1=function(){n.rotation_accel_1=0,n.rotation_vel_1=0,n.surface.rotation.z=0},n.options.width&&n.options.height?(n.width=n.options.width,n.height=n.options.height):(n.width=window.innerWidth,n.height=window.innerHeight),n.textureA=new THREE.WebGLRenderTarget(n.width,n.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),n.textureB=new THREE.WebGLRenderTarget(n.width,n.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),n.textureC=new THREE.WebGLRenderTarget(n.width,n.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),n.u_extra=.5,n.scene=new THREE.Scene,n.in_scene=new THREE.Scene,n.in_scene_c=new THREE.Scene,n.camera=new THREE.PerspectiveCamera(75,n.width/n.height,.1,1e3),n.camera.position.z=27,n.cameraSquare=new THREE.PerspectiveCamera(75,n.width/n.width,.1,1e3),n.cameraSquare.position.z=27,n.nodes=[],n.customUniforms={},n.customDefines={};var t=0;n.customUniforms.time={type:"f",value:t},n.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(n.width,n.height)},n.rotation_vel_1=0,n.rotation_vel_2=0,n.rotation_accel_1=0,n.vertexShader="\n        varying vec2 vUv;        void main() {          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );          vUv = uv;        }\n      ",n.fragmentShader="\n        uniform float time;\n        uniform vec2 screenSize;\n    \n        /* custom_uniforms */        /* custom_helpers */        varying vec2 vUv;        void main() {          /* custom_main */        }\n      ",n.fragmentShader2="\n      uniform float time;\n      uniform vec2 screenSize;\n  \n      /* custom_uniforms */      /* custom_helpers */      varying vec2 vUv;      void main() {        /* custom_main */      }\n    ",n.init=function(){console.log("INIT Renderer -------------------"),n.glrenderer=new THREE.WebGLRenderer({canvas:n.element,alpha:!1,preserveDrawingBuffer:!0}),n.glrenderer.outputEncoding=THREE.sRGBEncoding,n.glrenderer.outputColorSpace=THREE.LinearSRGBColorSpace,n.nodes.forEach(function(e){e.init()}),n.shaderMaterial=new THREE.ShaderMaterial({uniforms:n.customUniforms,defines:n.customDefines,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:THREE.DoubleSide,transparent:!0}),n.shaderMaterial2=new THREE.ShaderMaterial({uniforms:n.customUniforms,defines:n.customDefines,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader2,side:THREE.DoubleSide,transparent:!0});n.flatGeometry=new THREE.CircleGeometry(19.96875,50),n.surface=new THREE.Mesh(n.flatGeometry,n.shaderMaterial),n.in_scene_c.add(n.surface);new THREE.PlaneGeometry(39.9375,39.9375);material_out=new THREE.MeshBasicMaterial({map:initial_texture});const e=new THREE.Mesh(n.flatGeometry,material_out);n.scene.add(e),n.flatGeometry2=new THREE.CircleGeometry(19.96875,300),n.flatGeometry2.rotateY(Math.PI/1),n.surface2=new THREE.Mesh(n.flatGeometry2,n.shaderMaterial2),n.surface2.scale.set(.3,.3,.3),n.surface2.position.set(25,-13,1),n.flatGeometry3=new THREE.CircleGeometry(19.96875,300),n.surface3=new THREE.Mesh(n.flatGeometry3,n.shaderMaterial2),n.surface3.scale.set(.3,.3,.3),n.surface3.position.set(-25,-13,1);const t=new THREE.PlaneGeometry(39.9375,39.9375),r={u_in_buffer:{value:n.textureA.texture},u_init_buffer:{value:initial_texture},u_resolution:{value:new THREE.Vector2(n.width,n.height)},u_time:{value:0},u_extra:{value:.5}};material_in=new THREE.ShaderMaterial({uniforms:r,fragmentShader:fb_fragment});const o=new THREE.Mesh(t,material_in);n.in_scene.add(o),n.scene.add(n.surface2),n.scene.add(n.surface3)},n.render=function(){requestAnimationFrame(n.render),material_in.uniforms.u_time.value=clock.getElapsedTime(),material_in.uniforms.u_extra.value=n.u_extra,n.glrenderer.setRenderTarget(n.textureB),n.glrenderer.render(n.in_scene,n.cameraSquare);var e=n.textureA;n.textureA=n.textureB,n.textureB=e,material_out.map=n.textureB.texture,material_out.map.encoding=THREE.sRGBEncoding,n.glrenderer.setRenderTarget(n.textureC),n.glrenderer.render(n.in_scene_c,n.cameraSquare),material_in.uniforms.u_in_buffer.value=n.textureA.texture,material_in.uniforms.u_init_buffer.value=n.textureC.texture,material_in.uniforms.u_resolution.value=new THREE.Vector2(n.width,n.width),n.glrenderer.setRenderTarget(null),n.glrenderer.render(n.scene,n.camera),n.onafterrender(),n.glrenderer.setSize(n.width,n.height),n.nodes.forEach(function(e){e.update()}),t++,n.customUniforms.time.value=t,n.surface.rotation.z+=n.rotation_vel_1*Math.PI/50,n.surface2.rotation.z+=n.rotation_vel_2*Math.PI/50,n.surface3.rotation.z-=n.rotation_vel_2*Math.PI/50,n.rotation_vel_1+=parseFloat(n.rotation_accel_1)*Math.PI/50},n.resize=function(){n.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(n.width,n.height)},n.camera.aspect=n.width/n.height,n.camera.updateProjectionMatrix(),n.glrenderer.setSize(n.width,n.height)},window.addEventListener("resize",function(){n.resize()}),n.add=function(e){n.nodes.push(e)},n.dispose=function(){n.shaderMaterial,n.flatGeometry,n.shaderMaterial2,n.flatGeometry2,n.shaderMaterial3,n.flatGeometry3,n.scene.remove(n.surface),n.scene.remove(n.surface2),n.scene.remove(n.surface3),n.glrenderer.resetGLState(),n.customUniforms={},n.customDefines={},t=0,n.customUniforms.time={type:"f",value:t},n.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(n.width,n.height)},n.vertexShader="\n          varying vec2 vUv;\n          void main() {\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            vUv = uv;\n          }\n        ",n.fragmentShader="\n          uniform int time;\n          uniform vec2 screenSize;\n    \n          /* custom_uniforms */\n          /* custom_helpers */\n          varying vec2 vUv;\n          void main() {\n            /* custom_main */\n          }\n        ",n.fragmentShader2="\n        uniform int time;\n        uniform vec2 screenSize;\n  \n        /* custom_uniforms */\n        /* custom_helpers */\n        varying vec2 vUv;\n        void main() {\n          /* custom_main */\n        }\n      ",n.nodes=[]}},Mapping=class{static function_list(){return[]}static help(){return"ownoes"}constructor(e,n){var t=this;null!=e&&(null==n.uuid?t.uuid="Mapping_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,t.renderer=e,t.source=n.source,e.add(t),t.type="Module",t.internal_renderer=null,t.init=function(){t.vertexShader_test="\n          varying vec2 vUv;          void main() {            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );            vUv = uv;          }\n        ",t.fragmentShader_test="\n            uniform float time;\n            uniform vec2 screenSize;\n  \n            /* custom_uniforms */            /* custom_helpers */            varying vec2 vUv;            void main() {              /* custom_main */            }\n          ",t.internal_renderer=new GlRenderer({element:n.element}),console.log(" fragment_shader: "),t.internal_renderer.fragmentShader=t.renderer.fragmentShader,t.internal_renderer.vertexShader=t.renderer.vertexShader,console.log(" uniforms: "),console.log(t.renderer.customUniforms),t.internal_renderer.customUniforms=t.renderer.customUniforms,t.internal_renderer.customDefines=t.renderer.customDefines;new Output(t.internal_renderer,t.source);t.internal_renderer.init(),t.internal_renderer.render()},t.update=function(){document.getElementById("sourceCanvas")},t.mapping={},t.load_pixelmap=function(e){(new Utils).get(e,function(e){t.mapping=JSON.parse(e)})})}};function Module(e,n){this.type="Module",this.init=function(){},this.update=function(){},this.render=function(){}}function Chain(e,n){var t,r=this;null==n.uuid?r.uuid="Chain_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):r.uuid=n.uuid,e.add(r),null!=n&&(t=n),r.type="Module",r.sources=t.sources,r.sources.forEach(function(n,t){e.customUniforms[r.uuid+"_source"+t+"_alpha"]={type:"f",value:.5}}),r.sources.forEach(function(n,t){e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+r.uuid+"_source"+t+"_alpha;\n/* custom_uniforms */")}),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+r.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec3 "+r.uuid+"_output;\n/* custom_uniforms */"),r.init=function(){var n="vec4(0.0,0.0,0.0,0.0)";r.sources.forEach(function(e,t){n+=" + ("+e.uuid+"_output * "+r.uuid+"_source"+t+"_alpha )"}),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+r.uuid+"_output = vec4( "+n+"); /* custom_main */")},r.update=function(){},r.setChainLink=function(n,t){e.customUniforms[r.uuid+"_source"+n+"_alpha"].value=t},r.getChainLink=function(n){return e.customUniforms[r.uuid+"_source"+n+"_alpha"].value},r.setAll=function(n=0){r.sources.forEach(function(t,o){e.customUniforms[r.uuid+"_source"+o+"_alpha"].value=n})},r.toggle=function(n,t){void 0===t?1==e.customUniforms[r.uuid+"_source"+n+"_alpha"].value?e.customUniforms[r.uuid+"_source"+n+"_alpha"].value=0:(e.customUniforms[r.uuid+"_source"+n+"_alpha"].value=1,current=n):e.customUniforms[r.uuid+"_source"+n+"_alpha"].value=t}}var Mixer=class{static function_list(){return[["BLEND","method","blendMode"],["MIX","method","mixMode"],["POD","set","pod"]]}constructor(e,n){var t=this;if(null!=e){null==n.uuid?t.uuid="Mixer_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,null==n.fragmentChannel?t._fragmentChannel=1:t._fragmentChannel=n.fragmentChannel,e.add(t),null!=n&&n,t.type="Module";var r=1,o=0,a=0,u=128,c=1,i=function(){return u};t.autoFade=!1,t.fading=!1;var s=1;t.mixmodes=[1,2,3,4,5,6,7,8,9];var l,d,m=1;t.blendmodes=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],l=n.source1,d=n.source2;var f="";f+="vec4 "+t.uuid+"_output = vec4( blend( ",f+=l.uuid+"_output * "+t.uuid+"_alpha1, ",f+=d.uuid+"_output * "+t.uuid+"_alpha2, ",f+=t.uuid+"_blendmode ) ",f+=")",f+=" + vec4(  "+l.uuid+"_output.a < 1.0 ? "+d.uuid+"_output.rgba * ( "+t.uuid+"_alpha1 - "+l.uuid+"_output.a ) : vec4( 0.,0.,0.,0. )  ) ",f+=" + vec4(  "+d.uuid+"_output.a < 1.0 ? "+l.uuid+"_output.rgba * ( "+t.uuid+"_alpha2 - - "+d.uuid+"_output.a ) : vec4( 0.,0.,0.,0. )  ) ",f+=";\n",f+="  /* custom_main */  ",t.init=function(){var n;e.customUniforms[t.uuid+"_mixmode"]={type:"i",value:1},e.customUniforms[t.uuid+"_blendmode"]={type:"i",value:1},e.customUniforms[t.uuid+"_alpha1"]={type:"f",value:.5},e.customUniforms[t.uuid+"_alpha2"]={type:"f",value:.5},e.customUniforms[t.uuid+"_sampler"]={type:"t",value:null},-1==(n=(n=(n=(n=(n=(n=1==t._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform int "+t.uuid+"_mixmode;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+t.uuid+"_blendmode;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha1;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha2;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform vec4 "+t.uuid+"_output;\n/* custom_uniforms */")).indexOf("vec4 blend ( vec4 src, vec4 dst, int blendmode )")&&(n=n.replace("/* custom_helpers */","\n  vec4 blend ( vec4 src, vec4 dst, int blendmode ) {\n    if ( blendmode ==  1 ) return src + dst;\n    if ( blendmode ==  2 ) return src - dst;\n    if ( blendmode ==  3 ) return src * dst;\n    if ( blendmode ==  4 ) return min(src, dst);\n    if ( blendmode ==  5)  return vec4((src.x == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.x) / src.x)), (src.y == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.y) / src.y)), (src.z == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.z) / src.z)),1.0);\n    if ( blendmode ==  6 ) return (src + dst) - 1.0;\n    if ( blendmode ==  7 ) return max(src, dst);\n    if ( blendmode ==  8 ) return (src + dst) - (src * dst);\n    if ( blendmode ==  9 ) return vec4((src.x == 1.0) ? 1.0 : min(1.0, dst.x / (1.0 - src.x)), (src.y == 1.0) ? 1.0 : min(1.0, dst.y / (1.0 - src.y)), (src.z == 1.0) ? 1.0 : min(1.0, dst.z / (1.0 - src.z)), 1.0);\n    if ( blendmode == 10 ) return src + dst;\n    if ( blendmode == 11 ) return vec4((dst.x <= 0.5) ? (2.0 * src.x * dst.x) : (1.0 - 2.0 * (1.0 - dst.x) * (1.0 - src.x)), (dst.y <= 0.5) ? (2.0 * src.y * dst.y) : (1.0 - 2.0 * (1.0 - dst.y) * (1.0 - src.y)), (dst.z <= 0.5) ? (2.0 * src.z * dst.z) : (1.0 - 2.0 * (1.0 - dst.z) * (1.0 - src.z)), 1.0);\n    if ( blendmode == 12 ) return vec4((src.x <= 0.5) ? (dst.x - (1.0 - 2.0 * src.x) * dst.x * (1.0 - dst.x)) : (((src.x > 0.5) && (dst.x <= 0.25)) ? (dst.x + (2.0 * src.x - 1.0) * (4.0 * dst.x * (4.0 * dst.x + 1.0) * (dst.x - 1.0) + 7.0 * dst.x)) : (dst.x + (2.0 * src.x - 1.0) * (sqrt(dst.x) - dst.x))), (src.y <= 0.5) ? (dst.y - (1.0 - 2.0 * src.y) * dst.y * (1.0 - dst.y)) : (((src.y > 0.5) && (dst.y <= 0.25)) ? (dst.y + (2.0 * src.y - 1.0) * (4.0 * dst.y * (4.0 * dst.y + 1.0) * (dst.y - 1.0) + 7.0 * dst.y)) : (dst.y + (2.0 * src.y - 1.0) * (sqrt(dst.y) - dst.y))), (src.z <= 0.5) ? (dst.z - (1.0 - 2.0 * src.z) * dst.z * (1.0 - dst.z)) : (((src.z > 0.5) && (dst.z <= 0.25)) ? (dst.z + (2.0 * src.z - 1.0) * (4.0 * dst.z * (4.0 * dst.z + 1.0) * (dst.z - 1.0) + 7.0 * dst.z)) : (dst.z + (2.0 * src.z - 1.0) * (sqrt(dst.z) - dst.z))), 1.0);\n    if ( blendmode == 13 ) return vec4((src.x <= 0.5) ? (2.0 * src.x * dst.x) : (1.0 - 2.0 * (1.0 - src.x) * (1.0 - dst.x)), (src.y <= 0.5) ? (2.0 * src.y * dst.y) : (1.0 - 2.0 * (1.0 - src.y) * (1.0 - dst.y)), (src.z <= 0.5) ? (2.0 * src.z * dst.z) : (1.0 - 2.0 * (1.0 - src.z) * (1.0 - dst.z)), 1.0);\n    if ( blendmode == 14 ) return vec4((src.x <= 0.5) ? (1.0 - (1.0 - dst.x) / (2.0 * src.x)) : (dst.x / (2.0 * (1.0 - src.x))), (src.y <= 0.5) ? (1.0 - (1.0 - dst.y) / (2.0 * src.y)) : (dst.y / (2.0 * (1.0 - src.y))), (src.z <= 0.5) ? (1.0 - (1.0 - dst.z) / (2.0 * src.z)) : (dst.z / (2.0 * (1.0 - src.z))),1.0);\n    if ( blendmode == 15 ) return 2.0 * src + dst - 1.0;\n    if ( blendmode == 16 ) return vec4((src.x > 0.5) ? max(dst.x, 2.0 * (src.x - 0.5)) : min(dst.x, 2.0 * src.x), (src.x > 0.5) ? max(dst.y, 2.0 * (src.y - 0.5)) : min(dst.y, 2.0 * src.y), (src.z > 0.5) ? max(dst.z, 2.0 * (src.z - 0.5)) : min(dst.z, 2.0 * src.z),1.0);\n    if ( blendmode == 17 ) return abs(dst - src);\n    if ( blendmode == 18 ) return src + dst - 2.0 * src * dst;\n    return src + dst;\n  }\n  /* custom_helpers */\n  ")),n=n.replace("/* custom_main */",f),1==t._fragmentChannel?e.fragmentShader=n:e.fragmentShader2=n};var g=(new Date).getTime(),p=0,v=0,_=0,h="b",y=0;t.update=function(){if(t.autoFade&&(u=i(),p=((new Date).getTime()-g)/1e3,t.pod(Math.sin(p*Math.PI*u*c/60)/2+.5)),t.fading){var e=(new Date).getTime(),n=(v=_-e)/y;"b"==h&&(n=Math.abs(n-1)),n<0&&(n=0),n>1&&(n=1),t.pod(n),v<0&&(t.fading=!1,n=Math.round(n),t.pod(n))}},t.render=function(){return a},t.alpha1=function(){return r},t.alpha2=function(){return o},t.mixMode=function(e){return null!=e&&(s=e),s},t.blendMode=function(n){return null!=n&&(m=n,e.customUniforms[t.uuid+"_blendmode"].value=m),t.pod(t.pod()),m},t.pod=function(n){return null!=n&&(a=n,1==s&&(r=a,o=1-a),2==s&&(r=Math.round(a),o=Math.round(1-a)),3==s&&((r=2*a)>1&&(r=1),(o=2-2*a)>1&&(o=1)),4==s&&(r=2*a,o=2-2*a),5==s&&((r=2*a)>1&&(r=1),(o=2-2*a)>1&&(o=1),r+=.36,o+=.36),6==s&&(r=1,o=0),7==s&&(r=0,o=1),8==s&&(r=.5,o=.5),9==s&&(r=1,o=1),10==s&&(r=a,o=1),11==s&&(r=1,o=a),e.customUniforms[t.uuid+"_alpha1"].value=r,e.customUniforms[t.uuid+"_alpha2"].value=o),a},t.bpm=function(e){return null!=e&&(u=e),u},t.bpmMod=function(e){return null!=e&&(c=e),c},t.bindBpm=function(e){i=e},t.setAutoFade=function(e){t.autoFade=e},t.fade=function(e){t.pod();t.fading=!0;var n=(new Date).getTime();_=n+e,h=t.pod()>.5?"a":"b",console.log("fadeTo",h,_,n,e),y=e}}}},Monitor=class{static function_list(){return[]}static help(){return"ownoes"}constructor(e,n){var t=this;null!=e&&(null==n.uuid?t.uuid="Monitor_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,t.renderer=e,t.source=n.source,e.add(t),t.type="Module",t.internal_renderer=null,t.init=function(){t.internal_renderer=new GlRenderer(n),t.internal_renderer.fragmentShader=t.renderer.fragmentShader,t.internal_renderer.vertexShader=t.renderer.vertexShader,t.internal_renderer.customUniforms=t.renderer.customUniforms,t.internal_renderer.customDefines=t.renderer.customDefines;new Output(t.internal_renderer,t.source);t.internal_renderer.init(),t.internal_renderer.render()},t.update=function(){})}};function Output(e,n,t){this.uuid="Output_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),this.type="Module",e.add(this);var r=n,o=t;this.init=function(){e.fragmentShader=e.fragmentShader.replace("/* custom_main */","\n  gl_FragColor = vec4( "+r.uuid+"_output );\n"),t&&(console.log("Output. Has 2nd source."),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","\n  gl_FragColor = vec4( "+o.uuid+"_output );\n"))},this.update=function(){}}function Switcher(e,n){var t=this;t.uuid="Switcher_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Module",e.add(t),t.sources=[n.source1,n.source2],t.active_source=0,t.init=function(){console.log("Switcher",t.uuid,t.sources),e.customUniforms[t.uuid+"_active_source"]={type:"i",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform int "+t.uuid+"_active_source;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+t.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_helpers */","\nvec4 get_source_"+t.uuid+" ( int active_source, vec4 src1, vec4 src2 ) {\n  if ( active_source ==  0 ) return src1;  if ( active_source ==  1 ) return src2;}\n/* custom_helpers */\n"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+t.uuid+"_output = get_source_"+t.uuid+"("+t.uuid+"_active_source, "+t.sources[0].uuid+"_output, "+t.sources[1].uuid+"_output );\n  /* custom_main */")},t.update=function(){},t.render=function(){return t.sources[t.active_source]},t.doSwitch=function(n){return null==n?0==t.active_source?t.active_source=1:t.active_source=0:0!=n&&1!=n?console.log(t.uuid,n,"not allowed"):t.active_source=n,e.customUniforms[t.uuid+"_active_source"]={type:"i",value:t.active_source},t.active_source}}var Source=class{constructor(e,n){this.type="Source",this.function_list=[["JUMP","method","jump"]],this.init=function(){},this.update=function(){},this.render=function(){},this.start=function(){},this.src=function(e){},this.play=function(){},this.pause=function(){},this.paused=function(){},this.currentFrame=function(e){},this.duration=function(){},this.jump=function(){}}};function FlexSource(e,n){var t=this,r=1024;null==n.uuid?t.uuid="FlexSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,null==n.fragmentChannel?t._fragmentChannel=1:t._fragmentChannel=n.fragmentChannel;n.texture_size&&(console.log("texture size now is: ",n.texture_size),r=n.texture_size),n.elementId?t.elementId=n.elementId:t.elementId="monitor_1",t.currentSrc="https://virtualmixproject.com/video/placeholder.mp4",t.type="FlexSource",t.bypass=!0,t.currentSrc=n.src;let o=n.src.split(".").pop();console.log("FlexSource. ext",o),"mp4"==o?t.type2="Video":"png"==o||"jpg"==o||"gif"==o?t.type2="Image":console.log("Unknown Source:",n.src);var a,u,c,i,s,l=128;t.bpmFollow=!1,t.fading=!1;e.add(t),t.init=function(){console.log("init Flex video source",t.uuid),(u=document.createElement("video")).setAttribute("crossorigin","anonymous"),u.setAttribute("playsinline",!0),u.playsinline=!0,u.preload="auto",u.muted=!0,u.poster="https://virtualmixproject.com/gif/telephone-pole-wire-tennis-shoes.jpg",null==n.src?u.src=t.currentSrc:u.src=n.src,console.log("loaded source: ",u.src),u.height=r,u.width=r,u.volume=0,u.loop=!0,u.load(),t.firstplay=!1,u.addEventListener("loadedmetadata",function(e){var n=this.videoWidth,t=this.videoHeight;console.log("WWWWW video width: ",n,t),console.log("WWWWW video duration: ",u.duration)},!1);var o=setInterval(function(){if(4==u.readyState){var e=Math.random()*u.duration;t.firstplay=!0,console.log(t.uuid,"First Play; ",e),clearInterval(o)}},400);function l(){t.firstplay=!0,document.body.removeEventListener("click",l),document.body.removeEventListener("touchstart",l),console.log("first touch was denied")}document.body.addEventListener("click",l),document.body.addEventListener("touchstart",l),(a=document.getElementById(t.elementId)).width=r,a.height=r,c=a.getContext("2d"),(i=new THREE.Texture(a)).wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,e.customUniforms[t.uuid]={type:"t",value:i},e.customUniforms[t.uuid+"_alpha"]={type:"f",value:1},e.customUniforms[t.uuid+"_uvmap"]={type:"v2",value:new THREE.Vector2(1,1)},1==t._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+t.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec2 "+t.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */",`\n        vec4 ${t.uuid+"_output"} = ( texture2D( ${t.uuid}, vUv * ${t.uuid+"_uvmap"} ).rgba * ${t.uuid+"_alpha"} );\n        /* custom_main */\n        `)):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+t.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec2 "+t.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */",`\n        vec4 ${t.uuid+"_output"} = ( texture2D( ${t.uuid}, vUv * ${t.uuid+"_uvmap"} ).rgba * ${t.uuid+"_alpha"} );\n        /* custom_main */\n        `)),t.video=u,t.canvas=a,window.image_source=new Image,(s=document.createElement("img")).setAttribute("id","gif_"+t.uuid),s.setAttribute("rel:auto_play","1"),console.log(t.uuid," Load",t.currentSrc,"..."),t.newImg=new Image,t.newImg.onload=function(){var e=t.newImg.height,n=t.newImg.width;t.imageWidth=n,t.imageHeight=e},t.newImg.src=t.currentSrc,console.log("FlexSource/Image Loaded First source!",t.currentSrc,"!"),t.bypass=!1};t.update=function(){let e=4/3;"Video"==t.type2&&u.videoWidth&&(e=u.videoWidth/u.videoHeight),"Image"==t.type2&&t.imageWidth&&(e=t.imageWidth/t.imageHeight);let n=r/(1/e),o=(r-n)/2;if(!(t.bypass=!1)){if("Video"==t.type2&&(u&&u.readyState.readyState===u.HAVE_ENOUGH_DATA&&u.seeking,c.drawImage(u,o,0,n,r),i&&(i.needsUpdate=!0)),"Image"==t.type2)try{c.clearRect(0,0,1024,1024),c.drawImage(t.newImg,o,0,n,1024),i&&(i.needsUpdate=!0)}catch(e){}if(t.bpmFollow){l=l,m=((new Date).getTime()-d)/1e3;let e=Math.sin(m*Math.PI*l*1/60)/2+.5;u.currentTime=e}}},t.render=function(){return i},t.src=function(e){if(null==e)return currentSrc;try{t.currentSrc=e,console.log("FlexSource set",t.currentSrc)}catch(e){return void console.log("FlexSource returned empty promise, retrying ...")}let r=e.split(".").pop();console.log("FlexSource. ext",r),"mp4"==r?t.type2="Video":"png"==r||"jpg"==r?t.type2="Image":console.log("Unknown Source:",n.src),"Video"==t.type2&&(u.src=e),"Image"==t.type2&&(console.log("load new src: ",e),t.currentSrc=e,t.newImg.src=t.currentSrc),i&&(i.needsUpdate=!0)},t.play=function(){return u.play()},t.pause=function(){return u.pause()},t.paused=function(){return u.paused},t.currentTime=function(e){return void 0===e?u.currentTime:(u.currentTime=e,e)},t.duration=function(){return u.duration},t.setUVMap=function(n,r){e.customUniforms[t.uuid+"_uvmap"].value=new THREE.Vector2(n,r)},t.setUVMapMod=function(n,r){console.log(e.customUniforms),e.customUniforms[t.uuid+"_uvmap_mod"].value=new THREE.Vector2(n,r)},t.alpha=function(n){if(null==n)return e.customUniforms[t.uuid+"_alpha"].value;e.customUniforms[t.uuid+"_alpha"].value=n},t.jump=function(e){if(4==u.readyState){if(null==e||isNaN(e))try{var n=Math.floor(Math.random()*u.buffered.end(0));console.log("jump to ",n),u.currentTime=n}catch(e){console.warn("video jump prevented a race error",e),u.currentTime=0}else u.currentTime=e;return u.currentTime}console.warn("Not enough data for jumping through video...")};var d=(new Date).getTime(),m=0;t.setBpmFollow=function(e){t.bpmFollow=e}}function GifSource(e,n){var t,r,o,a,u,c=this;null==n.uuid?c.uuid="GifSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):c.uuid=n.uuid,null==n.fragmentChannel?c._fragmentChannel=1:c._fragmentChannel=n.fragmentChannel,c.type="GifSource",c.bypass=!0,e.add(c),null==n.src?c.currentSrc="https://virtualmixerproject.com/gif/a443ae90a963a657e12737c466ddff95.gif":c.currentSrc=n.src,n.elementId?c.elementId=n.elementId:c.elementId="monitor_1";c.init=function(){(t=document.getElementById(c.elementId)).width=1024,t.height=1024,o=t.getContext("2d"),a=new THREE.Texture(t),e.customUniforms[c.uuid]={type:"t",value:a},e.customUniforms[c.uuid+"_alpha"]={type:"f",value:1},1==c._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */")):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec4 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */")),c.gif=u,c.canvas=t,window.image_source=new Image,(r=document.createElement("img")).setAttribute("id","gif_"+c.uuid),r.setAttribute("rel:auto_play","1"),(u=new SuperGif({gif:r,c_w:"1024px",c_h:"576px"})).draw_while_loading=!0,console.log(c.uuid," Load",c.currentSrc,"..."),c.newImg=new Image,c.newImg.onload=function(){var e=c.newImg.height,n=c.newImg.width;c.imageWidth=n,c.imageHeight=e},c.newImg.src=c.currentSrc,u.load_url(c.currentSrc,function(){console.log("play initial source"),u.play()}),console.log("Gifsource Loaded First source!",c.currentSrc,"!"),c.bypass=!1};var i=0;c.update=function(){let e=4/3;c.imageWidth&&(e=c.imageWidth/c.imageHeight);let n=1024/(1/e),t=(1024-n)/2;try{i%6==0&&(o.clearRect(0,0,1024,1024),o.drawImage(u.get_canvas(),t,0,n,1024),a&&(a.needsUpdate=!0)),i++}catch(e){}},c.render=function(){return a},c.src=function(e){if(null==e)return c.currentSrc;console.log("load new src: ",e),c.currentSrc=e,u.pause(),u.load_url(e,function(){console.log("play gif",e),u.play()})},c.play=function(){return u.play()},c.pause=function(){return u.pause()},c.paused=function(){return!u.get_playing()},c.currentFrame=function(e){return void 0===e?u.get_current_frame():(u.move_to(e),e)},c.duration=function(){return u.get_length()}}function ImageSource(e,n){var t,r,o,a,u=this;null==n.uuid?u.uuid="ImageSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):u.uuid=n.uuid,null==n.fragmentChannel?u._fragmentChannel=1:u._fragmentChannel=n.fragmentChannel,u.type="ImageSource",u.bypass=!0,e.add(u),null==n.src?u.currentSrc="https://virtualmixerproject.com/gif/a443ae90a963a657e12737c466ddff95.gif":u.currentSrc=n.src,n.elementId?u.elementId=n.elementId:u.elementId="monitor_1";u.init=function(){(t=document.getElementById(u.elementId)).width=1024,t.height=1024,o=t.getContext("2d"),a=new THREE.Texture(t),e.customUniforms[u.uuid]={type:"t",value:a},e.customUniforms[u.uuid+"_alpha"]={type:"f",value:1},1==u._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */")):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec4 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */")),u.canvas=t,window.image_source=new Image,(r=document.createElement("img")).setAttribute("id","gif_"+u.uuid),r.setAttribute("rel:auto_play","1"),console.log(u.uuid," Load",u.currentSrc,"..."),u.newImg=new Image,u.newImg.onload=function(){var e=u.newImg.height,n=u.newImg.width;u.imageWidth=n,u.imageHeight=e},u.newImg.src=u.currentSrc,console.log("ImageSource Loaded First source!",u.currentSrc,"!"),u.bypass=!1};u.update=function(){let e=4/3;u.imageWidth&&(e=u.imageWidth/u.imageHeight);let n=1024/(1/e),t=(1024-n)/2;try{o.clearRect(0,0,1024,1024),o.drawImage(u.newImg,t,0,n,1024),a&&(a.needsUpdate=!0)}catch(e){}},u.render=function(){return a},u.src=function(e){if(null==e)return u.currentSrc;console.log("load new src: ",e),u.currentSrc=e},u.play=function(){return null},u.pause=function(){return null},u.paused=function(){return!0},u.currentFrame=function(e){return 0},u.duration=function(){return 0}}function MultiVideoSource(e,n){var t,r,o,a=this;null==n.uuid?a.uuid="MultiVideoSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):a.uuid=n.uuid,a.type="MultiVideoSource",a.bypass=!0,e.add(a);a.init=function(){console.log("init video source",a.uuid),videoElement=document.createElement("video"),videoElement.setAttribute("crossorigin","anonymous"),videoElement.muted=!0,null==n.src?videoElement.src="/streamable.com/w0skqb":videoElement.src=n.src,console.log("loaded source: ",videoElement.src),videoElement.height=1024,videoElement.width=1024,videoElement.loop=!0,videoElement.load(),a.firstplay=!1;var u=setInterval(function(){if(4==videoElement.readyState){var e=Math.random()*videoElement.duration;videoElement.currentTime=e,videoElement.play(),a.firstplay=!0,console.log(a.uuid,"First Play; ",e),clearInterval(u)}},400);document.body.addEventListener("click",function(){videoElement.play(),a.firstplay=!0}),videoElement.volume=0,(t=document.createElement("canvas")).width=1024,t.height=1024,r=t.getContext("2d"),o=new THREE.Texture(t),e.customUniforms[a.uuid]={type:"t",value:o},e.customUniforms[a.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+a.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+a.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+a.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+a.uuid+"_output = ( texture2D( "+a.uuid+", vUv ).rgba * "+a.uuid+"_alpha );\n  /* custom_main */"),a.video=videoElement,a.canvas=t,a.bypass=!1},a.update=function(){(a.bypass=!1)||(videoElement.readyState!==videoElement.HAVE_ENOUGH_DATA||videoElement.seeking?(r.clearRect(0,0,1024,1024),a.alpha=0):(r.drawImage(videoElement,0,0,1024,1024),o&&(o.needsUpdate=!0)))},a.render=function(){return o},a.src=function(e){videoElement.src=e;var n=setInterval(function(){4==videoElement.readyState&&(videoElement.play(),console.log(a.uuid,"First Play."),clearInterval(n))},400)},a.play=function(){return videoElement.play()},a.pause=function(){return videoElement.pause()},a.paused=function(){return videoElement.paused},a.currentTime=function(e){return void 0===e?videoElement.currentTime:(console.log("set time",e),videoElement.currentTime=e,e)},a.duration=function(){return videoElement.duration},a.alpha=function(n){if(null==n)return e.customUniforms[a.uuid+"_alpha"].value;e.customUniforms[a.uuid+"_alpha"].value=n},a.jump=function(e){if(null==e||isNaN(e))try{videoElement.currentTime=Math.floor(Math.random()*a.duration())}catch(e){console.log("prevented a race error")}else videoElement.currentTime=e;return videoElement.currentTime}}function SocketSource(e,n){}function SolidSource(e,n){var t,r=this;null==n.uuid?r.uuid="SolidSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):r.uuid=n.uuid,null==n.fragmentChannel?r._fragmentChannel=1:r._fragmentChannel=n.fragmentChannel,r.bypass=!0,e.add(r);var o={r:0,g:0,b:0,a:1};null!=n&&(t=n),r.init=function(){let n;console.log("init solid",t),null!=t.color&&(o=t.color),e.customUniforms[r.uuid+"_color"]={type:"v4",value:new THREE.Vector4(o.r,o.g,o.b,o.a)},n=(n=(n=(n=1==r._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+r.uuid+"_color;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform vec4 "+r.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_main */","vec4 "+r.uuid+"_output = "+r.uuid+"_color;\n  /* custom_main */"),1==r._fragmentChannel?e.fragmentShader=n:e.fragmentShader2=n},r.update=function(){},r.render=function(){return o},r.color=function(n){return null!=n&&(null==(o=n).a&&(o.a=1),console.log(r.uuid," sets color: ",o),e.customUniforms[r.uuid+"_color"]={type:"v4",value:new THREE.Vector4(o.r,o.g,o.b,o.a)}),o},r.jump=function(e){console.log("no")}}function SVGSource(e,n){}function TextSource(e,n){var t,r,o,a,u=this;null==n.uuid?u.uuid="TextSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):u.uuid=n.uuid,u.type="TextSource",u.bypass=!0,e.add(u);u.init=function(){console.log("init text source",u.uuid),(r=document.createElement("DIV")).innerHTML="<h1> Awaiting text </h1>",r.height=1024,r.width=1024,u.firstplay=!1,t=document.createElement("canvas"),document.body.appendChild(t),t.width=1024,t.height=1024,o=t.getContext("2d"),a=new THREE.CanvasTexture(t),e.customUniforms[u.uuid]={type:"t",value:a},e.customUniforms[u.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */"),u.divElement=r,u.canvas=t,u.bypass=!1};var c=null;utils.get("/texts/fear_is_the_mind_killer.txt",function(e){c=e,console.log("get text",e)});var i=0,s="",l=0,d=12,m=600,f=300,g=64,p=512;u.update=function(){g*=.99,(u.bypass=!1)||null!=c&&(o.clearRect(0,0,t.width,t.height),o.fillStyle="rgba(60, 60, 60, 0.4)",o.font="604px IMPACT",o.textAlign="center",o.fillText(s.split(".").join(""),10*bpm.render()+f,m),o.fillStyle="white",o.font=g+"px IMPACT",o.textAlign="center",o.fillText(s.split(".").join(""),p,460),i>d&&(s=c.split(",")[l],d=c.split(",")[l].length*(bpm.bpm/72)+3,++l==c.split(",").length&&(l=0),i=0,m=Math.floor(200*Math.random())+600,f=Math.floor(200*Math.random())+200,p=Math.floor(100*Math.random())+470,g=Math.floor(30*Math.random())+70),i++,a&&(a.needsUpdate=!0))},u.render=function(){return a},u.alpha=function(n){if(null==n)return e.customUniforms[u.uuid+"_alpha"].value;e.customUniforms[u.uuid+"_alpha"].value=n}}function VideoSource(e,n){var t=this,r=1024;null==n.uuid?t.uuid="VideoSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):t.uuid=n.uuid,null==n.fragmentChannel?t._fragmentChannel=1:t._fragmentChannel=n.fragmentChannel;var o,a,u,c;n.texture_size&&(console.log("texture size now is: ",n.texture_size),r=n.texture_size),n.elementId?t.elementId=n.elementId:t.elementId="monitor_1",t.currentSrc="https://virtualmixproject.com/video/placeholder.mp4",t.type="VideoSource",t.bypass=!0;e.add(t),t.init=function(){console.log("init video source",t.uuid),(a=document.createElement("video")).setAttribute("crossorigin","anonymous"),a.setAttribute("playsinline",!0),a.playsinline=!0,a.preload="auto",a.muted=!0,a.poster="https://virtualmixproject.com/gif/telephone-pole-wire-tennis-shoes.jpg",null==n.src?a.src=t.currentSrc:a.src=n.src,console.log("loaded source: ",a.src),a.height=r,a.width=r,a.volume=0,a.loop=!0,a.load(),t.firstplay=!1,a.addEventListener("loadedmetadata",function(e){var n=this.videoWidth,t=this.videoHeight;console.log("WWWWW video width: ",n,t)},!1);var i=setInterval(function(){if(4==a.readyState){var e=Math.random()*a.duration;a.play(),t.firstplay=!0,console.log(t.uuid,"First Play; ",e),clearInterval(i)}},400);function s(){t.firstplay=!0,document.body.removeEventListener("click",s),document.body.removeEventListener("touchstart",s),console.log("first touch was denied")}document.body.addEventListener("click",s),document.body.addEventListener("touchstart",s),(o=document.getElementById(t.elementId)).width=r,o.height=r,u=o.getContext("2d"),(c=new THREE.Texture(o)).wrapS=THREE.RepeatWrapping,c.wrapT=THREE.RepeatWrapping,e.customUniforms[t.uuid]={type:"t",value:c},e.customUniforms[t.uuid+"_alpha"]={type:"f",value:1},e.customUniforms[t.uuid+"_uvmap"]={type:"v2",value:new THREE.Vector2(1,1)},1==t._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+t.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec2 "+t.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */",`\n        vec4 ${t.uuid+"_output"} = ( texture2D( ${t.uuid}, vUv * ${t.uuid+"_uvmap"} ).rgba * ${t.uuid+"_alpha"} );\n        /* custom_main */\n        `)):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+t.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+t.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec2 "+t.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */",`\n        vec4 ${t.uuid+"_output"} = ( texture2D( ${t.uuid}, vUv * ${t.uuid+"_uvmap"} ).rgba * ${t.uuid+"_alpha"} );\n        /* custom_main */\n        `)),t.video=a,t.canvas=o,t.bypass=!1};t.update=function(){let e=4/3;a.videoWidth&&(e=a.videoWidth/a.videoHeight);let n=r/(1/e),o=(r-n)/2;(t.bypass=!1)||(a&&a.readyState.readyState===a.HAVE_ENOUGH_DATA&&a.seeking,u.drawImage(a,o,0,n,r),c&&(c.needsUpdate=!0))},t.render=function(){return c},t.src=function(e){if(null==e)return currentSrc;try{t.currentSrc=e}catch(e){return void console.log("VideoSource returned empty promise, retrying ...")}a.src=e,a.play()},t.play=function(){return a.play()},t.pause=function(){return a.pause()},t.paused=function(){return a.paused},t.currentTime=function(e){return void 0===e?a.currentTime:(console.log("set time",e),a.currentTime=e,e)},t.duration=function(){return a.duration},t.setUVMap=function(n,r){e.customUniforms[t.uuid+"_uvmap"].value=new THREE.Vector2(n,r)},t.setUVMapMod=function(n,r){console.log(e.customUniforms),e.customUniforms[t.uuid+"_uvmap_mod"].value=new THREE.Vector2(n,r)},t.alpha=function(n){if(null==n)return e.customUniforms[t.uuid+"_alpha"].value;e.customUniforms[t.uuid+"_alpha"].value=n},t.jump=function(e){if(4==a.readyState){if(null==e||isNaN(e))try{var n=Math.floor(Math.random()*a.buffered.end(0));console.log("jump to ",n),a.currentTime=n}catch(e){console.warn("video jump prevented a race error",e),a.currentTime=0}else a.currentTime=e;return a.currentTime}console.warn("Not enough data for jumping through video...")}}function WebcamSource(e,n){var t,r,o,a,u=this;null==n.uuid?u.uuid="WebcamSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):u.uuid=n.uuid,u.type="WebcamSource",u.bypass=!0,e.add(u);u.init=function(){console.log("init video source",u.uuid),(r=document.createElement("video")).setAttribute("crossorigin","anonymous"),r.height=1024,r.width=1024,r.loop=!0,r.load(),u.firstplay=!1;navigator.mediaDevices.getUserMedia({audio:!1,video:{width:1024,height:1024}}).then(function(e){r.srcObject=e,r.onloadedmetadata=function(e){r.play()}}).catch(function(e){console.log(e.name+": "+e.message)});var n=setInterval(function(){if(4==r.readyState){var e=Math.random()*r.duration;r.play(),u.firstplay=!0,console.log(u.uuid,"First Play; ",e),clearInterval(n)}},400);document.body.addEventListener("click",function(){r.play(),u.firstplay=!0}),r.volume=0,(t=document.createElement("canvas")).width=1024,t.height=1024,o=t.getContext("2d"),a=new THREE.Texture(t),e.customUniforms[u.uuid]={type:"t",value:a},e.customUniforms[u.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec3 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */"),u.video=r,u.canvas=t,u.bypass=!1},u.update=function(){(u.bypass=!1)||(r.readyState!==r.HAVE_ENOUGH_DATA||r.seeking?(o.clearRect(0,0,1024,1024),u.alpha=0):(o.drawImage(r,0,0,1024,1024),a&&(a.needsUpdate=!0)))},u.render=function(){return a},u.play=function(){return r.play()},u.pause=function(){return r.pause()},u.paused=function(){return r.paused},u.duration=function(){return r.duration},u.alpha=function(n){if(null==n)return e.customUniforms[u.uuid+"_alpha"].value;e.customUniforms[u.uuid+"_alpha"].value=n}}FlexSource.prototype=new Source,FlexSource.constructor=FlexSource,GifSource.prototype=new Source,GifSource.constructor=GifSource,ImageSource.prototype=new Source,ImageSource.constructor=ImageSource,MultiVideoSource.prototype=new Source,MultiVideoSource.constructor=MultiVideoSource,SocketSource.prototype=new Source,SocketSource.constructor=SocketSource,SolidSource.prototype=new Source,SolidSource.constructor=SolidSource,SVGSource.prototype=new Source,SVGSource.constructor=SVGSource,TextSource.prototype=new Source,TextSource.constructor=TextSource,VideoSource.prototype=new Source,VideoSource.constructor=VideoSource,WebcamSource.prototype=new Source,WebcamSource.constructor=WebcamSource;