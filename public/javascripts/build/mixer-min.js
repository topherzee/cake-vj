function Addon(){}function AudioAnalysis(e,t){var n=this;n.uuid="Analysis_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Addon",n.audio="",n.bypass=!1,n.bpm=128,n.beats=0,n.delayed_bpm=128,n.use_delay=!0,n.bpm_limit=256,n.bpm_float=0,n.mod=1,n.bps=1,n.sec=0,n.count=0,n.dataSet,n.tempoData,n.audio_src,n.options={audio:"/audio/fear_is_the_mind_killer_audio.mp3",microphone:!1},null!=t&&(n.options=t);var r=!0,o=[],a=0,c=(new Date).getTime();e.add(n);var u=new Audio;n.audio=u;var i,s=new(window.AudioContext||window.webkitAudioContext),l=s.createBiquadFilter(),d=s.createAnalyser(),m=Date.now();n.dataSet=new Array(4e3);var f,g=new Array(4e3),p=[],v=1,_=!1,h=[];u.controls=!0,u.loop=!0,u.autoplay=!0,u.crossorigin="anonymous",l.type="lowpass",l.frequency.value=350,l.Q.value=1,d.fftSize=128,f=d.frequencyBinCount,n.context=s,n.analyser=s,n.bufferLength=f,n.dataArray=void 0,n.disconnectOutput=function(){i.disconnect(s.destination)},n.connectOutput=function(){i.connect(s.destination)},n.getBpm=function(){return n.bpm};var y=function(){if(!n.audio.paused)return s.resume(),document.body.removeEventListener("click",y),void document.body.removeEventListener("touchstart",y);console.log("AudioAnalysis is re-intialized after click initialized!",u.src),s.resume().then(()=>{u.play(),console.log("Playback resumed successfully"),document.body.removeEventListener("click",y),document.body.removeEventListener("touchstart",y)})};document.body.addEventListener("click",y),document.body.addEventListener("touchstart",y),n.init=function(){console.log("init AudioAnalysis Addon."),n.options.microphone?(console.log("Audio analisis using microphone."),navigator.mediaDevices.getUserMedia({audio:u}).then(function(e){i=s.createMediaStreamSource(e),E(),n.disconnectOutput()}).catch(function(e){console.log(e.name+": "+e.message)})):(i=s.createMediaElementSource(u),u.src=n.options.audio,n.audio_src=n.options.audio,E())},n.render=function(){return n.bpm_float},n.add=function(e){o.push(e)},n.sync=function(){c=(new Date).getTime()},n.getBlackOut=function(){},n.getAmbience=function(){},n.getHighLevels=function(){},n.getMidLevels=function(){},n.getLowLevels=function(){};var b=0;n.update=function(){n.bypass||(n.disabled||o.forEach(function(e){e(n.render())}),n.bpm=n.tempodata_bpm,n.bpm>n.bpm_limit&&(console.warn("reached bpm limit!: ",n.bpm,"reset bpm to limit: ",n.bpm_limit),n.bpm=n.bpm_limit),a=((new Date).getTime()-c)/1e3,n.count=a,n.use_delay?(n.delayed_bpm<n.bpm&&(n.delayed_bpm+=.1),n.delayed_bpm>n.bpm&&(n.delayed_bpm-=.1)):n.delayed_bpm=n.bpm,n.sec=a*Math.PI*n.delayed_bpm/60,n.sec=n.sec*(b/n.delayed_bpm),n.bpm_float=(Math.sin(n.sec*n.mod)+1)/2,n.bpm!=b&&(b=n.delayed_bpm*n.mod),n.sec>n.delayed_bpm&&(c=(new Date).getTime()),n.bpm_float>.9&&!_?(n.beats+=1,_=!0):n.bpm_float<.1&&_&&(n.beats+=1,_=!1))};var E=function(){if(u.play(),i.connect(l),l.connect(d),i.connect(s.destination),window.Worker){console.log("go");var e=new Blob(['\n      \n        var _self = null;\n        onmessage = function(e) {\n          \n          var data = JSON.parse(e.data)\n          console.log("msgevent:", data.command );          \n          _self = data.module\n          if ( data.command == "start" ) {\n            //setInterval( worker_sampler, 1);\n            console.log("(TEST)start the worker!", _self)\n          }          \n        }\n\n        postMessage(\'Inline worker created\');          \n      ']),t=window.URL.createObjectURL(e),n=new Worker(t);n.onmessage=function(e){console.log("module got worker message: ",e.data)},window.my_worker=n,setInterval(S,1)}else setInterval(S,1)},x=!1,S=function(){if(!n.audio.muted&&!n.bypass){n.dataArray=new Uint8Array(f),d.getByteTimeDomainData(n.dataArray);var e=Date.now(),t=0;if(n.dataArray.forEach(e=>{e>t&&(t=e)}),n.dataSet.push([e,t]),n.dataSet.length>4e3&&n.dataSet.splice(0,n.dataSet.length-4e3),0,e-m>20){var r=C(n.dataSet);n.tempoData=r,null==r?(x||console.warn(" WARNING: sampler is active, but no audio was detected after 20 seconds -- check your audiofile or your microphone and make sure you've clicked in the window and gave it access! Halting."),x=!0,n.tempodata_bpm=128):(n.tempodata_bpm=r.bpm,x=!1),n.useAutoBPM&&(n.sec=a*Math.PI*(r.bpm*n.mod)/60),m=Date.now(),0}}},w=function(){0!=document.getElementsByClassName("blink").length&&(u.paused?document.getElementsByClassName("blink")[0].style.opacity=0:1==document.getElementsByClassName("blink")[0].style.opacity?document.getElementsByClassName("blink")[0].style.opacity=0:document.getElementsByClassName("blink")[0].style.opacity=1,setTimeout(w,60/n.bpm*1e3/n.mod))};w();var C=function(e){p=[],g=new Array(e.length);for(var t=0;t<e.length;t++)void 0!==e[t]&&e[t][1]>128*v&&(g[t]=[n.dataSet[t][0],1],p.push([e[t][0],1]),t+=50);p.length<15&&(v-=.05),p.length>60&&(v+=.05),v>2&&(v=2),v<1&&(v=1);var o=M(T(p));if(o.sort(I),0==o.length)o[0]={tempo:128};else{var a="";o.reverse().forEach(function(e,t){a+=t+", "+e.tempo+", "+e.count+"\t [";for(var n=0;n<e.count;)a+="#",n++;a+="]<br/>"}),null!=document.getElementById("info")&&(document.getElementById("info").html=a)}var c="calibrating";if(r=!1,void 0===e[0])r=!0,document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#999999");else{if(r=!1,void 0===o[0]||void 0===o[1])return;var u=o[0].count-o[1].count;u<=2?(c="low",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#990000")):u>2&&u<=7?(c="average",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#999900")):u>7&&(c="high",document.getElementsByClassName("blink").length>0&&(document.getElementsByClassName("blink")[0].style.backgroundColor="#CCCCCC"))}return{bpm:o[0].tempo,confidence:c,calibrating:r,treshold:v,tempoCounts:o,foundpeaks:p,peaks:g}},I=function(e,t){return parseInt(e.count,10)-parseInt(t.count,10)},T=function(e){return h=[],e.forEach(function(t,n){for(var r=0;r<10;r++)if(void 0!==e[n+r]){var o=e[n+r][0]-t[0];h.some(function(e){if(e.interval===o)return e.count++})||h.push({interval:o,count:1})}}),h},M=function(e){var t=[];return e.forEach(function(e,n){if(0!=e.interval&&!isNaN(e.interval))var r=60/(e.interval/1e3);for(;r<90;)r*=2;for(;r>180;)r/=2;r=2*Math.round(r/2),t.some(function(t){if(t.tempo===r)return t.count+=e.count})||r&&t.push({tempo:r,count:e.count})}),t}}function BPM(e,t){var n=this;if(n.function_list=[["AUTO","method","toggleAutoBpm"],["MODDOWN","method","modDown"],["MODUP","method","modUp"],["MOD","method","modNum"]],null==e)return;n.uuid="BPM_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),window["bpm_"+n.uuid],n.type="Addon",n.options={},null!=t&&(n.options=t),n.bpm=128,n.bps=2.133333,n.sec=0,n.bpm_float=.46875,n.mod=1,n.useAutoBpm=!1,n.tempodata_bpm=128,n.mute=!1,n.autoBpmData={},n.audio_src="",n.useMicrophone=!1,n.bypass=!1;var r=[];e.add(n),n.init=function(){console.log("init BPM contoller.")};var o=(new Date).getTime(),a=0;n.update=function(){n.disabled||r.forEach(function(e){e(n.render())}),a=((new Date).getTime()-o)/1e3;var e=1/n.bpm*60;n.bpm_float=a%e/e},n.add=function(e){r.push(e)},n.render=function(e){return n.bpm_float},n.render2=function(e){if(void 0===e)return n.bpm_float;var t=1/n.bpm*60*e;return a%t/t},n.modUp=function(){n.mod*=2},n.modDown=function(){n.mod*=.5},n.modNum=function(e){console.log("MOD ",e);var t=n.useAutoBpm;n.mod=e,n.useAutoBpm=t},n.toggleAutoBpm=function(e){n.useAutoBpm=!n.useAutoBpm,console.log("---\x3e",n.useAutoBpm)},n.turnOff=function(){bpm.audio.muted=!1,bpm.useAutoBpm=!1};var c="TAP_PHASE_PRIME",u=0;n.tapCake=function(){if(n.useAutoBPM=!1,"TAP_PHASE_PRIME"==c)c="TAP_PHASE_SET_LENGTH",u=Number(new Date),console.log("BPM TAP. Start.");else if("TAP_PHASE_SET_LENGTH"==c){c="TAP_PHASE_PRIME";var e=Number(new Date)-u;n.bpm=6e4/e,n.resetCake(),console.log("BPM TAP. Complete. seconds:",(e/1e3).toFixed(2)),console.log("BPM TAP. Complete. bpm:",n.bpm.toFixed(2))}return c},n.resetCake=function(){o=(new Date).getTime(),n.update(),console.log("ResetCake bpm",n.bpm_float)},n.getBpm=function(){return n.bpm},n.setBpm=function(e){n.bpm=e,console.log("setBpm",e)}}function FileManager(e){console.log("FileManager START ----------------");var t=this;t.function_list=[["CHZ","method","changez"]],t.uuid="Filemanager_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="AddOn",t.defaultQuality="",t.source=e,t.debug=!1,t.set=[],t.load_set=function(e){console.log("FileManager load_set ----------------"),(new Utils).get(e,function(e){t.set=JSON.parse(e)})},null!=window.in_app&&(t.eu=window.eu),t.setSrc=function(e){null==window.in_app?(t.source.src(e),console.log("filemanager: set normal source:",e)):(t.source.src(t.eu.check_file(e)),console.log("filemanager: set checked source:",t.eu.check_file(e)))},t.load=function(e){(new Utils).get(e,function(e){t.set=JSON.parse(e),(t.debug=!1)&&console.log("got set: ",t.set)})},t.changeToNum=function(e){t.setSrc(t.set[e]),(t.debug=!1)&&console.log("changed file: ",e,self.set[e])},t.changeToUrl=function(e){t.setSrc(e),(t.debug=!1)&&console.log("changed file from url: ",_num,self.set[_num])},t.change=function(e){if(console.log("FileManager Change ----------------"),0!=t.set.length){if(null!=e)return void t.changeToNum(e);var n=t.set[Math.floor(Math.random()*t.set.length)];t.setSrc(n),(t.debug=!1)&&console.log("changed file: ",n)}},t.changez=function(e){t.change(e)},t.getSrcByTag=function(e){}}function GiphyManager(e){var t=this;t.uuid="GiphyManager_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="AddOn",t.source=e,t.file="",t.programs=[],t.program="";t.needle=function(e,n){(new Utils).get("//api.giphy.com/v1/gifs/search?api_key=tIovPHdiZhUF3w0UC6ETdEzjYOaFZQFu&q="+e,function(e){console.log(" === GIPHY (re)LOADED === "),t.programs=JSON.parse(e).data,null!=n&&n()})},t.search=function(e,n){t.needle(e,n)},t.setSrc=function(e){console.log("set source: ",e),t.source.src(e)},t.change=function(){if(0==t.programs.length)return"no programs found :(";t.program=t.programs[Math.floor(Math.random()*t.programs.length)],t.file=t.program,t.setSrc(t.program.images.original.url)},t.changez=function(){t.change()}}function Behaviour(e,t){var n=this;function r(e){"seconds"==e.mod.type?triggers.push([e,n.time+e.mod.value,null]):"beats"==e.mod.type?triggers.push([e,n.beats+e.mod.value]):"random-seconds"==e.mod.type?triggers.push([e,n.time+Math.random()*e.mod.value,null]):"random-beats"==e.mod.type&&triggers.push([e,n.beats+Math.random()*e.mod.value])}n.uuid="Behaviour"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Behaviour",e.add(n),n.beats=0,n.time=(new Date).getTime(),n.script={},n.sheets=[],n.sheet_index=0,n.bpm=t.bpm,triggers=[],n.tr=triggers,old_bpm=1,n.init=function(){},n.update=function(){n.time=(new Date).getTime();var e=Math.round(4*bpm.render());e!=old_bpm&&(n.beats+=1,old_bpm=e)},n.load=function(e){n.script=e,n.sheets=e.sheets,console.log("loaded A BEHAVIOUR",e.title),e.triggers.forEach(function(e,t){r(e)})},n.jump=function(e){console.log("how high?",e),e.video.currentTime=Math.random()*e.video.duration};var o=0;n.checkSheets=function(){n.sheets[0].length;checkBeats(o%n.sheets[n.sheet_index].length),n.sheets[n.sheet_index][o%n.sheets[n.sheet_index].length].forEach(function(e){if("....."!=e[0]){console.log(e);var t=n.script.composition[e[0]].target,r=n.script.composition[e[0]].functions,o=null;r.forEach(function(n,r){if(e[1]==n[0]){console.log("TRIGGERED",o=n[2]);var a=e[2];a=isNaN(e[2])?e[2]:parseFloat(e[2]),t[n[2]](a),console.log(t,o,a)}})}}),o+=1,setTimeout(n.checkSheets,60/bpm.bpm*1e3/4)};setTimeout(function(){},12e3)}async function start(){console.log("CAKE Start --------------------");var e=new GlRenderer({element:"glcanvas",width:800,height:450});function t(e,t){let r=document.getElementById("layer_template").innerHTML;r=r.replaceAll("_4","_"+t);const u=document.createElement("div");u.innerHTML=r;const i=u.firstElementChild;document.getElementById(e).appendChild(i),document.getElementById("layer_"+t).onclick=function(){B(t)},document.getElementById("layer_effect_d_p1_"+t).oninput=function(){f[t].extra(this.value)},document.getElementById("layer_effect_d_p2_"+t).oninput=function(){f[t].extra2(this.value)},document.getElementById("layer_effect_c1_p1_"+t).oninput=function(){g[t].extra(this.value),console.log("color layer_effect 1 "+t+" >>",parseFloat(this.value))},document.getElementById("layer_effect_c2_p1_"+t).oninput=function(){p[t].extra(this.value),console.log("color layer_effect 2 "+t+" >>",parseFloat(this.value))},document.getElementById("btn_bpm_layer_"+t).onclick=function(){a(t)},document.getElementById("layer_play_"+t).onclick=function(){console.log("play ",t),ae[t].is_playing=!0},document.getElementById("layer_pause_"+t).onclick=function(){console.log("pause ",t),ae[t].is_playing=!1},document.getElementById("layer_in_"+t).onclick=function(){console.log("in ",t),ce(t)},document.getElementById("layer_out_"+t).onclick=function(){console.log("out ",t),ue(t)},document.getElementById("layer_play_mode_"+t).oninput=function(){console.log("layer_play_mode_"+t,this.value),q(t,this.value)},document.getElementById("layer_bpm_mode_"+t).oninput=function(){console.log("layer_bpm_mode"+t,this.value),function(e,t){ae[e].bpm_mode=t,console.log("setBpmModeOnLayer",e,t)}(t,this.value)},document.getElementById("layer_bpm_factor_"+t).oninput=function(){console.log("layer_bpm_factor_"+t,parseFloat(this.value)),ae[t].bpm_factor=parseFloat(this.value)},document.getElementById("layer_time_"+t).oninput=function(){var e=this.value*m[t].duration();m[t].currentTime(e),ae[t].time_last_beat=Date.now()-1e3*e},document.getElementById("layer_time_"+t).onmousedown=function(){ae[t].is_scrubbing=!0},document.getElementById("layer_time_"+t).onmouseup=function(){ae[t].is_scrubbing=!1},document.getElementById("monitor_"+t).onmousedown=function(e){oe=t,B(t),te=!0,ne=e.clientX,ae[w].is_jogging=!0,ae[w].is_scrubbing=!0},document.getElementById("cake-mixer").onmouseup=function(e){re=!1,te=!1,oe=-1,ne=-1,ae[w].is_scrubbing=!1,ae[w].is_jogging=!1},document.getElementById("cake-mixer").onmousemove=function(e){if(void 0!==te&&te&&oe>0){const n=e.clientX-ne;console.log("jog global",n),console.log("currenttime",m[w].video.currentTime),console.log("e.movementX",e.movementX);const r=m[w].video;var t=(r.currentTime+e.movementX/30)%r.duration;r.currentTime=t,document.getElementById("layer_time_"+w).value=t/r.duration}},document.getElementById("layer_speed_"+t).oninput=function(){console.log("layer_speed >>",t,parseFloat(this.value))},document.getElementById("layer_blendmode_"+t).oninput=function(){E.blendMode(this.value),console.log("layer_blendmode_"+t,parseFloat(this.value))},document.getElementById("layer_samples_"+t).oninput=function(){!function(e,t){if(console.log("loadSample",e,t),"-"==t)return;let n=parseFloat(t.split("-")[0]),r=parseFloat(t.split("-")[1]);(function(e,t){ae[e].in=t,ae[e].time_last_beat=Date.now(),ae[e].is_playing=!0,document.getElementById("layer_in_"+e).classList.add("active")})(e,n),function(e,t){ae[e].out=t,document.getElementById("layer_out_"+e).classList.add("active")}(e,r)}(t,this.value),console.log("layer_samples_"+t,parseFloat(this.value))};for(var s=document.getElementById("layer_effect_d_"+t),l=0;l<c.length;l++){var d=document.createElement("option");d.text=c[l].n,d.value=c[l].v,s.add(d)}s.oninput=function(){console.log("layer_effect_d_"+w,parseFloat(this.value)),function(e,t){f[e].effect(t)}(t,this.value)},n(t,1).oninput=function(){var e,t;console.log("layer_effect_c1_"+w,parseFloat(this.value)),e=w,t=this.value,g[e].effect(t)},n(t,2).oninput=function(){var e,t;console.log("layer_effect_c2_"+w,parseFloat(this.value)),e=w,t=this.value,p[e].effect(t)},document.getElementById("layer_new_sample_"+t).onclick=async function(){console.log("layer_new_sample_ ",t);var e=document.getElementById("layer_sample_name_"+t);e.classList.remove("dialog_hidden"),e.focus()},document.getElementById("layer_sample_name_"+t).onkeypress=function(e){(console.log("sample name",this.value),13==e.keyCode)&&(!async function(e,t){console.log("saveSample",e,t);let n=ae[e];if(-1==n.in||-1==n.out)return void console.log("no new sample to save");let r={name:""!=t?t:"samp "+parseInt(n.in)+"->"+parseInt(n.out),in:parseFloat(n.in.toFixed(2)),out:parseFloat(n.out.toFixed(2))};n.metadata.samples.push(r),o(e,n.metadata.samples);var a=n.url.split(".").slice(0,-1).join(".");a+=".json",console.log("Save url",a);const c=`${v}?file=${encodeURIComponent(a)}`;fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae[e].metadata)}).then(e=>{if(!e.ok)throw new Error("Network response was not ok "+e.statusText);return e.json()}).then(e=>{console.log("Success:",e)}).catch(e=>{console.error("Error:",e)})}(t,this.value),this.value="",document.getElementById("layer_sample_name_"+t).classList.add("dialog_hidden"))}}function n(e,t){for(var n=document.getElementById("layer_effect_c"+t+"_"+e),r=0;r<u.length;r++){var o=document.createElement("option");o.text=u[r].n,o.value=u[r].v,n.add(o)}return n}function r(e){var t;for(t=e.options.length-1;t>=0;t--)e.remove(t)}function o(e,t){var n=document.getElementById("layer_samples_"+e);r(n),(a=document.createElement("option")).text="Samples",a.value="-",n.add(a);for(var o=0;o<t.length;o++){var a;(a=document.createElement("option")).text=t[o].name,a.value=t[o].in+"-"+t[o].out,n.add(a)}return n}function a(e){ae[e].bpm_on=!ae[e].bpm_on,console.log("bpm layer "+e+" >>",ae[e].bpm_on);let t=document.getElementById("btn_bpm_layer_"+e);ae[e].bpm_on?t.classList.add("active"):t.classList.remove("active")}var c=[{n:"No Effect",v:1},{n:"Mirror Horizontal",v:107},{n:"Mirror Vertical",v:106},{n:"Wipe Horiz",v:108},{n:"Wipe Vert",v:110},{n:"Wipe Angle",v:111},{n:"Wipe Donut",v:112},{n:"Mirror Both",v:109},{n:"Kaleido",v:120}];var u=[{n:"No Effect",v:1},{n:"Toph Luma Black",v:100},{n:"Toph Luma White",v:102},{n:"Negative 3",v:2},{n:"B&W",v:10},{n:"Red",v:11},{n:"Blue",v:13},{n:"Green",v:12},{n:"Yellow",v:14},{n:"Teal",v:15},{n:"Magenta",v:16},{n:"Sepia",v:17},{n:"Swap 1",v:20},{n:"Paint",v:52},{n:"Colorize",v:53},{n:"Brightness",v:60},{n:"Contrast",v:61},{n:"Satur8",v:62},{n:"Hue",v:63},{n:"Black Edge",v:64}];function i(e,t){const n=document.getElementById("layer_bpm_factor_"+e);!function(e,t){const n=e.selectedIndex+t;n>-1&&n<9&&(e.selectedIndex=n)}(n,t);let r=parseFloat(n.value);console.log("changeBeatFactor",r),ae[e].bpm_factor=r}function s(e){let t=d.getBpm()+e;d.setBpm(t),document.getElementById("bpm_slide").value=d.getBpm(),document.getElementById("bpm_display").textContent=Math.round(d.getBpm())}function l(e,t){document.getElementById("layer_play_mode_"+e).value=t,q(e,t)}console.log("addLayers"),t("channel_2_layers",4),t("channel_2_layers",3),t("channel_1_layers",2),t("channel_1_layers",1),window.addEventListener("keydown",e=>{if(console.log("e.code",e.code),console.log("target:",e.target.nodeName),"input"!=e.target.nodeName.toLowerCase()){if("Digit1"==e.code&&B(1),"Digit2"==e.code&&B(2),"Digit3"==e.code&&B(3),"Digit4"==e.code&&B(4),"ArrowLeft"==e.code&&l(w,J),"ArrowRight"==e.code&&l(w,Z),"ArrowDown"==e.code&&l(w,X),"ArrowUp"==e.code&&l(w,Y),"Space"==e.code&&(ae[w].is_playing=!ae[w].is_playing),"KeyI"==e.code&&ce(w),"KeyO"==e.code&&ue(w),"KeyA"==e.code&&ie(),"KeyD"==e.code&&se(),"KeyW"==e.code&&s(1),"KeyS"==e.code&&s(-1),"KeyK"==e.code&&a(w),"KeyJ"==e.code&&i(w,-1),"KeyL"==e.code&&i(w,1),"KeyU"==e.code){let e=Q;ae[w].bpm_mode==Q&&(e=ee),document.getElementById("layer_bpm_mode_"+w).value=e,ae[w].bpm_mode=e}e.preventDefault()}}),document.getElementById("layer_fader_1").oninput=function(){b.pod(this.value)},document.getElementById("layer_fader_2").oninput=function(){E.pod(this.value)},document.getElementById("layer_fader_3").oninput=function(){x.pod(this.value)},document.getElementById("layer_fader_4").oninput=function(){S.pod(this.value)};var d=new BPM(e);d.add(function(e){e<.1?document.getElementById("bpm_reset").classList.add("phase"):document.getElementById("bpm_reset").classList.remove("phase"),e});let m=new Array,f=new Array,g=new Array,p=new Array;m[1]=new FlexSource(e,{src:"",uuid:"Video_1",fragmentChannel:1,elementId:"monitor_1"}),m[2]=new FlexSource(e,{src:"",uuid:"Video_2",fragmentChannel:1,elementId:"monitor_2"}),m[3]=new FlexSource(e,{src:"/images/640X480.gif",fragmentChannel:2,uuid:"Gif_3",elementId:"monitor_3"}),m[4]=new FlexSource(e,{src:"/images/animal.gif",fragmentChannel:2,uuid:"Gif_4",elementId:"monitor_4"});var v="http://localhost:4000/save";async function _(e,t){console.log("clip click:",t,e);ae[t].url=e,ae[t].time_last_beat=Date.now(),m[t].video.currentTime=0,m[t].src(e),m[t].pause();var n,a=e.split(".").slice(0,-1).join(".");a+=".json",n=t,r(document.getElementById("layer_samples_"+n));try{const e=await fetch(a);if(!e.ok)return;const n=await e.json();console.log("metadata:",n),ae[t].metadata=n,o(t,n.samples)}catch(e){return}}f[1]=new DistortionEffect2(e,{source:m[1],fragmentChannel:1,uuid:"Dist_1"}),f[2]=new DistortionEffect2(e,{source:m[2],fragmentChannel:1,uuid:"Dist_2"}),f[3]=new DistortionEffect2(e,{source:m[3],fragmentChannel:2,uuid:"Dist_3"}),f[4]=new DistortionEffect2(e,{source:m[4],fragmentChannel:2,uuid:"Dist_4"}),g[1]=new ColorEffect(e,{source:f[1],fragmentChannel:1,uuid:"Color_c1_1"}),g[2]=new ColorEffect(e,{source:f[2],fragmentChannel:1,uuid:"Color_c1_2"}),g[3]=new ColorEffect(e,{source:f[3],fragmentChannel:2,uuid:"Color_c1_3"}),g[4]=new ColorEffect(e,{source:f[4],fragmentChannel:2,uuid:"Color_c1_4"}),p[1]=new ColorEffect(e,{source:g[1],fragmentChannel:1,uuid:"Color_c2_1"}),p[2]=new ColorEffect(e,{source:g[2],fragmentChannel:1,uuid:"Color_c2_2"}),p[3]=new ColorEffect(e,{source:g[3],fragmentChannel:2,uuid:"Color_c2_3"}),p[4]=new ColorEffect(e,{source:g[4],fragmentChannel:2,uuid:"Color_c2_4"});var h=new SolidSource(e,{color:{r:0,g:0,b:0},uuid:"Solid_Black"}),y=new SolidSource(e,{color:{r:0,g:0,b:0},fragmentChannel:2,uuid:"Solid_Black2"}),b=new Mixer(e,{source1:p[1],source2:h,uuid:"Mixer_1_a"}),E=new Mixer(e,{source1:p[2],source2:b,uuid:"Mixer_1_b"}),x=new Mixer(e,{source1:p[3],source2:y,uuid:"Mixer_2_a",fragmentChannel:2}),S=new Mixer(e,{source1:p[4],source2:x,uuid:"Mixer_2_b",fragmentChannel:2});new Output(e,E,S);console.log("CAKE Call renderer.init() --------------------"),e.init(),e.render(),void 0!==E&&E.pod(0),void 0!==b&&b.pod(1),setTimeout(()=>{document.getElementById("layer_fader_2").value=0,document.getElementById("layer_fader_1").value=1,m[1].pause(),m[2].pause()},1e3);for(var w=1,C=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],I=["add","substract","multiply","darken","color burn","linear burn","lighten","screen","color dodge","linear dodge","overlay","soft light","hard light","vivid light","linear light","pin light","difference","exclusion"],T=document.getElementById("layer_blendmode_2"),M=0;M<C.length;M++){var U=document.createElement("option");U.text=I[M],U.value=C[M],T.add(U)}function B(e){let t;console.log("new active laayer: ",e),w=e;for(let e=1;e<5;e++)(t=document.getElementById("layer_"+e)).classList.remove("active");(t=document.getElementById("layer_"+e)).classList.add("active")}let k=!0;function D(){k=!k,console.log("toggleSideFlipMirror"),k?(e.setLeft(0),e.setRight(0)):(e.setLeft(1),e.setRight(1))}let R=!0;function A(){R=!R,console.log("toggleSideFlipSame"),R?(e.setLeft(0),e.setRight(1)):(e.setLeft(1),e.setRight(0))}let F=!1;let L=!1;var H=1;document.getElementById("side_flip_bpm_factor").oninput=function(){H=parseFloat(this.value)};let z=!1;let P=!1;let G=!1;async function V(e,t){console.log("fetchAndDisplayImages");try{const n=await fetch(e);if(!n.ok)throw new Error("Network response was not ok "+n.statusText);const r=await n.json(),o=document.getElementById(t);o.innerHTML="",r.forEach(e=>{if("json"!=e.split(".").pop()){const t=document.createElement("div");t.className="clip";const n=document.createElement("span"),r=e.replace("/video/DCVS01/DCVS01 ","");n.textContent=r,t.appendChild(n),t.onclick=(()=>(async function(e){_(e="/video/"+e,w)})(e)),o.appendChild(t)}})}catch(e){console.error("Error fetching images:",e)}}V("http://localhost:4000/files/DCVS01","clip_bank_1"),V("http://localhost:4000/files/disco","clip_bank_2");const N=await async function(e){console.log("fetchFileDirs");try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok "+t.statusText);return await t.json()}catch(e){console.error("Error fetching images:",e)}}("http://localhost:4000/dirs/");var O=document.getElementById("clip_bank_select_1");N.forEach(e=>{var t=document.createElement("option");t.text=e,t.value=e,O.add(t)});var W=document.getElementById("clip_bank_select_2");N.forEach(e=>{var t=document.createElement("option");t.text=e,t.value=e,W.add(t)}),O.oninput=function(){console.log("clip_bank_select_1 >>",this.value),V("http://localhost:4000/files"+this.value,"clip_bank_1")},W.oninput=function(){console.log("clip_bank_select_2 >>",this.value),V("http://localhost:4000/files"+this.value,"clip_bank_2")};let j=0;function K(e,t,n,r){let o=e.video;if(null==o||"Video"!=e.type2)return;if(0==r.is_playing)return;if(1==r.is_scrubbing)return;let a=o.duration;-1!=r.out&&(a=r.out);let c=0;-1!=r.in&&(c=r.in);let u=a-c,i=(Date.now()-r.time_last_beat)/1e3;if(r.just_reversed){r.just_reversed=!1;let e=i/u,t=1-e-e;r.time_last_beat-=t*u*1e3,e=(i=(Date.now()-r.time_last_beat)/1e3)/u}let s=!1;i>u&&(console.log("loop normal"),s=!0),r.bpm_on&&r.bpm_mode==ee&&d.render2(r.bpm_factor)<r.last_bpm_tap_render&&(console.log("loop BPM"),s=!0),r.last_bpm_tap_render=d.render2(r.bpm_factor),s&&(i=0,r.time_last_beat=Date.now(),r.is_bounce_reverse=!r.is_bounce_reverse),s=!1;let l=i/u;r.bpm_on&&(r.bpm_mode==Q?l=d.render2(r.bpm_factor):r.bpm_mode);let m=0;r.play_mode==Z?m=c+l*u:r.play_mode==J?m=c+(1-l)*u:r.play_mode==X&&(m=0==r.is_bounce_reverse?c+l*u:c+(1-l)*u),isFinite(m)?o.currentTime=m:console.log("warn updateVideo infinite time");var f=document.getElementById("layer_time_"+n);f&&(f.value=o.currentTime/o.duration)}function q(e,t){t!=ae[e].play_mode&&(ae[e].just_reversed=!0),ae[e].play_mode=t}var $=0;const Z="FORWARD",J="REVERSE",X="BOUNCE",Y="RANDOM",Q="STRETCH",ee="CUT";let te=!1,ne=-1,re=!1,oe=-1,ae=new Array;for(let e=1;e<5;e++)ae[e]=(ae[e],{is_playing:!1,play_mode:Z,bpm_on:!1,bpm_mode:Q,bpm_factor:1,in:-1,out:-1,time_last_beat:Date.now(),just_reversed:!1,is_bounce_reverse:!1,last_bpm_tap_render:0,is_scrubbing:!1,is_jogging:!1,jog_start_x:-1,url:"",metadata:{samples:[]}});function ce(e){-1==ae[e].in?(ae[e].in=m[e].video.currentTime,ae[e].time_last_beat=Date.now(),document.getElementById("layer_in_"+e).classList.add("active")):(console.log("time_last_beat",ae[e].time_last_beat),ae[e].time_last_beat=ae[e].time_last_beat-1e3*ae[e].in,console.log("time_last_beat",ae[e].time_last_beat),ae[e].in=-1,document.getElementById("layer_in_"+e).classList.remove("active")),console.log("setInOnLayer",ae[e].in)}function ue(e){-1==ae[e].out?(ae[e].out=m[e].video.currentTime,document.getElementById("layer_out_"+e).classList.add("active")):(ae[e].out=-1,document.getElementById("layer_out_"+e).classList.remove("active")),console.log("setOutOnLayer",ae[e].out)}function ie(){"TAP_PHASE_SET_LENGTH"==d.tapCake()?document.getElementById("bpm_tap_btn").classList.add("bpm-set-length"):document.getElementById("bpm_tap_btn").classList.remove("bpm-set-length"),document.getElementById("bpm_display").textContent=Math.round(d.bpm),document.getElementById("bpm_slide").value=Math.round(d.bpm)}function se(){d.resetCake(),document.getElementById("bpm_reset").classList.add("phase")}!function e(){0==j&&(K(m[1],0,"1",ae[1]),K(m[2],0,"2",ae[2]),K(m[3],0,"3",ae[3]),K(m[4],0,"4",ae[4])),3==++j&&(j=0);d.render2(1);requestAnimationFrame(e)}(),function e(){let t=d.render2(H);t<$&&(F&&D(),L&&A()),$=t,requestAnimationFrame(e)}(),document.getElementById("bpm_reset").onmousedown=function(){se()},document.getElementById("bpm_tap_btn").onmousedown=function(){ie()},document.getElementById("bpm_slide").oninput=function(){let e=Math.round(document.getElementById("bpm_slide").value);document.getElementById("bpm_display").textContent=e,d.setBpm(e)},document.getElementById("pause_all").onmousedown=function(){console.log("pause all button clicked"),console.log("pauseAll"),ae[1].is_playing=!1,ae[2].is_playing=!1,ae[3].is_playing=!1,ae[4].is_playing=!1},document.getElementById("effect_slide_feedback").oninput=function(){let t=this.value;e.setFeedbackEffect(t)},document.getElementById("effect_slide_rotate_vel_1").oninput=function(){let t=this.value;e.setRotationVel1(parseFloat(t))},document.getElementById("effect_slide_rotate_accel_1").oninput=function(){let t=this.value;e.setRotationAccel1(parseFloat(t))},document.getElementById("effect_slide_rotate_vel_2").oninput=function(){let t=this.value;e.setRotationVel2(parseFloat(t))},document.getElementById("rotate_vel_reset_1").onmousedown=function(){e.resetRotationVel1(),document.getElementById("effect_slide_rotate_vel_1").value=0},document.getElementById("rotate_accel_reset_1").onmousedown=function(){e.resetRotationAccel1(),document.getElementById("effect_slide_rotate_vel_1").value=0,document.getElementById("effect_slide_rotate_accel_1").value=0},document.getElementById("rotate_vel_reset_2").onmousedown=function(){e.resetRotationVel2(),document.getElementById("effect_slide_rotate_vel_2").value=0},document.getElementById("word_input_main").oninput=function(e){console.log("word",this.value),document.getElementById("word_main").textContent=this.value},document.getElementById("word_input_left").oninput=function(e){console.log("word",this.value),document.getElementById("word_left").textContent=this.value},document.getElementById("word_input_right").oninput=function(e){console.log("word",this.value),document.getElementById("word_right").textContent=this.value},document.getElementById("words_on").onmousedown=function(){!function(){G=!G;let e=document.getElementById("word_main"),t=document.getElementById("word_left"),n=document.getElementById("word_right");G?(e.classList.add("show"),t.classList.add("show"),n.classList.add("show")):(e.classList.remove("show"),t.classList.remove("show"),n.classList.remove("show"))}()},document.getElementById("side_flip_mirror").onmousedown=function(){D()},document.getElementById("side_flip_same").onmousedown=function(){A()},document.getElementById("side_flip_mirror_bpm").onmousedown=function(){!function(){F=!F;let e=document.getElementById("side_flip_mirror_bpm");F?e.classList.add("active"):e.classList.remove("active")}()},document.getElementById("side_flip_same_bpm").onmousedown=function(){!function(){L=!L;let e=document.getElementById("side_flip_same_bpm");L?e.classList.add("active"):e.classList.remove("active")}()},document.getElementById("channel_side").onmousedown=function(){z=!z,e.setChannels(P,z)},document.getElementById("channel_center").onmousedown=function(){P=!P,e.setChannels(P,z)},_("/video/DCVS01/DCVS01 container 02 scape.mp4",2),_("/video/DCVS01/DCVS01 container 01 ominouslong chop.mp4",1),B(1)}function initKeyboardTips(){let e=!1;const t=[];document.addEventListener("keydown",n=>{"Tab"===n.key&&(n.preventDefault(),e=!e,t.forEach(t=>{t.style.display=e?"block":"none"}),e&&document.querySelectorAll("[data-key]").forEach((e,n)=>{const r=t[n],o=e.getBoundingClientRect();r.style.top=`${o.top-r.offsetHeight}px`,r.style.left=`${o.left}px`}))}),document.querySelectorAll("[data-key]").forEach(e=>{const n=e.getAttribute("data-key"),r=document.createElement("div");r.classList.add("shortcut-popup"),r.textContent=n,document.body.appendChild(r),t.push(r);const o=e.getBoundingClientRect();r.style.top=`${o.top-r.offsetHeight}px`,r.style.left=`${o.left}px`})}function Controller(e){this.type="Controller",this.testControllerVar="test",this.init=function(){},this.update=function(){},this.render=function(){}}function GamePadController(e,t){var n=this;n.uuid="GamePadController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Control",n.controllers={},n.gamepad={},n.bypass=!0,n.debug=!1,n.gamepad_index=0,e.add(n);n.connect=function(){console.log("start gamepads"),window.addEventListener("gamepadconnected",function(e){console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),n.init()}),window.addEventListener("gamepaddisconnected",function(e){console.log("Gamepad disconnected from index %d: %s",e.gamepad.index,e.gamepad.id)}),n.bypass=!1},n.init=function(){console.log("init GamePadController."),setTimeout(function(){try{n.connect()}catch(e){console.log("Initial connect failed, hope somebody presses the button v14 ",n,e)}},1200)},n.update=function(){if(!n.bypass){if(n.debug&&console.log(navigator.getGamepads()[0].axes),n.debug&&console.log(navigator.getGamepads()[0].buttons),void 0===navigator.getGamepads()[n.gamepad_index]||null===navigator.getGamepads()[0])return console.log("Gamepad: No gamepad could be found"),void(n.bypass=!0);navigator.getGamepads()[n.gamepad_index].axes.forEach(function(e,t){o([t+100,e])}),navigator.getGamepads()[n.gamepad_index].buttons.forEach(function(e,t){e.pressed&&(n.debug&&console.log(" Button: ",t,e.value,e),o([t,e.value]))})}},n.render=function(){return n.controllers};var r=[];self.removeEventListener=function(){},n.addEventListener=function(e,t){r.push({target:e,callback:t}),console.log("Gamepad listeners: ",r)};var o=function(e){r.forEach(function(t,n){e[0]==t.target&&t.callback(e)})};n.getNodes=function(){return r}}function KeyboardController(e,t){var n=this;n.uuid="KeyboardController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Control",n.controllers={},n.keyboard={},n.bypass=!0,n.debug=!1,e.add(n);n.init=function(){console.log("init KeyboardController."),document.addEventListener("keydown",e=>{n.debug&&console.log(" down ",[e.keyCode,1]),o([e.keyCode,1])}),document.addEventListener("keyup",e=>{n.debug&&console.log(" up ",[e.keyCode,0]),o([e.keyCode,0])})},n.update=function(){n.bypass},n.render=function(){return n.controllers};var r=[];self.removeEventListener=function(){},n.addEventListener=function(e,t){r.push({target:e,callback:t}),console.log("Keyboard listeners: ",r)};var o=function(e){r.forEach(function(t,n){e[0]==t.target&&t.callback(e)})};n.getNodes=function(){return r}}function MidiController(e){var t=this;t.uuid="MidiController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="MidiController",t.bypass=!0,t.debug=!1,t.ready=!1,t.controllers={};var n,r,a=[];console.log("Midi check... "),navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(function(e){var a=(n=e).inputs.values(),c=n.outputs.values();for(i=a.next();i&&!i.done;i=a.next())i.value.onmidimessage=t.onMIDIMessage;for(o=c.next();o&&!o.done;o=c.next())r=o.value;console.log("Midi READY? ",r,n),null!=r&&(t.ready=!0),null!=r&&(t.bypass=!1)},function(e){console.error("No access to your midi devices.",e)});t.onMIDIMessage=function(e){t.debug&&console.log(" MIDIMESSAGE >>",e.data),c(e)},t.init=function(){},t.update=function(){},t.send=function(e){t.ready?(console.log("Midi send ",e,"to",r),r.send(e)):console.log("Midi is not ready yet")},t.clear=function(){for(var e=[],t=0;t++;t<100)e.push(144,t,0);r.send(e)},self.removeEventListener=function(e){a.forEach(function(t,n){if(t.target==e);}),a.splice(i,1)},t.addEventListener=function(e,t){a.push({target:e,callback:t}),console.log("MIDI listeners: ",a)};var c=function(e){a.forEach(function(t){t.target==e.data[1]&&t.callback(e.data)})}}function SocketController(e){var t=this;t.io=io.connect(),t.uuid="SocketController_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),t.type="Control",t.bypass=!0,t.title="",t.debug=!1,t.socket_pairing_id="no_paring_id",t.target="";var n=[];e&&"title"in e&&(t.title=e.title),t.io.on("test",function(e){console.log("got test",e)}),t.io.on("command",function(e){console.log("got command",e),"welcome"==e.command&&(t.target=e.payload,n.forEach(function(t,n){"welcome"!=t.target&&"ready"!=t.target||t.callback(e.payload)})),"reset_uuid"==e.command&&(console.log("reset uuid",e.payload),t.target=e.payload,n.forEach(function(t,n){"reset_uuid"!=t.target&&"reset"!=t.target||t.callback(e.payload)})),document.getElementById("sockets")&&(document.getElementById("sockets").innerHTML+="<div>"+t.title+" Socket: "+t.target+"</div>")}),t.io.on("controller",function(e){t.debug&&console.log("got controller",e),n.forEach(function(n,r){t.debug&&console.log("find node",r,n,e,t.target),e.client==t.target&&n.target==e.trigger&&(t.debug&&console.log("execute callback!"),n.callback(e.commands))})}),t.send=function(e,n,r){t.debug&&console.log("Socket send to: ",e,", trigger:",n," commands ",r),t.io.emit("controller",{client:e,trigger:n,commands:r})},self.removeEventListener=function(e){n.forEach(function(t,n){if(t.target==e);}),n.splice(i,1)},t.addEventListener=function(e,t){n.push({target:e,callback:t}),console.log("Socket listeners: ",n)}}function SourceControl(e,t){}function Effect(e,t){this.type="Effect",this.init=function(){},this.update=function(){},this.render=function(){}}function ColorEffect(e,t){var n=this;null==t.uuid?n.uuid="ColorEffect_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,null==t.fragmentChannel?n._fragmentChannel=1:n._fragmentChannel=t.fragmentChannel,e.add(n),n.type="Effect",n.debug=!1;var r=t.source,o=1;null!=t.effect&&(o=t.effect);var a=.8;null!=t.extra&&(a=t.currentExtra);n.init=function(){var t;console.log("ColorEffect init"),e.customUniforms[n.uuid+"_currentcoloreffect"]={type:"i",value:o},e.customUniforms[n.uuid+"_extra"]={type:"f",value:a},-1==(t=(t=(t=(t=1==n._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+n.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+n.uuid+"_currentcoloreffect;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+n.uuid+"_extra;\n/* custom_uniforms */")).indexOf("vec4 coloreffect ( vec4 src, int currentcoloreffect, float extra, vec2 vUv )")&&(console.log("ColorEffect REPLACE"),t=t.replace("/* custom_helpers */","\n/*\nfloat rand ( float seed ) {\n  return fract(sin(dot(vec2(seed) ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvec2 displace(vec2 co, float seed, float seed2) {\n  vec2 shift = vec2(0);\n  if (rand(seed) > 0.5) {\n      shift += 0.1 * vec2(2. * (0.5 - rand(seed2)));\n  }\n  if (rand(seed2) > 0.6) {\n      if (co.y > 0.5) {\n          shift.x *= rand(seed2 * seed);\n      }\n  }\n  return shift;\n}\n\nvec4 interlace(vec2 co, vec4 col) {\n  if (int(co.y) % 3 == 0) {\n      return col * ((sin(time * 4.) * 0.1) + 0.75) + (rand(time) * 0.05);\n  }\n  return col;\n}\n*/\n\n// bool mask_circle(vec2 uv, float radius, float x, float y){\n    \n//   uv.x *= 1.6; \n//   // uv.y *= 0.75;\n//   float len = sqrt(pow((uv.x - x),2.0) + pow(uv.y - y,2.0));\n//   if(len < radius){\n//     return true;\n//   }\n//   return false;\n// }\n\nvec4 coloreffect ( vec4 src, int currentcoloreffect, float extra, vec2 vUv ) {\n  if ( currentcoloreffect == 1 ) return vec4( src.rgba );                                                                                              // normal\n\n\n  //toph lum - BLACK GOES TRANSPARENT\n  if ( currentcoloreffect == 100 ) {\n    float brightness = (src.r + src.g + src.b) / 3.0;\n\n    float alpha = .0;\n    if (extra < brightness){\n      alpha = 1.0;\n    }\n    return vec4( src.r, src.g, src.b, alpha );\n  }\n\n  if ( currentcoloreffect == 102 ) {\n    float brightness = (src.r + src.g + src.b) / 3.0 ;\n\n    float alpha = 1.0;\n    if (extra < brightness){\n      alpha = 0.0;\n    }\n    return vec4( src.r, src.g, src.b, alpha );\n  }\n\n\n  // toph circle mask\n  if ( currentcoloreffect == 101 ) {\n    \n    // gl_FragCoord.xy; is 640x480\n    // u_resolution.xy is 640x480\n    /* vec2 uv = gl_FragCoord.xy; */\n    //vec2 uv = gl_FragCoord.xy/u_resolution.xy - 0.5; // 0 to 1\n    /* uv.x *= u_resolution.x/u_resolution.y; */\n\n    // return src;\n\n    // vec2 uv = vUv.xy;\n    vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5);\n    float radius = 0.2;\n    float x = -0.2;\n    float y = +0.0;\n    float scale = 4.0;\n\n    if(mask_circle(uv, radius, x, y)  || mask_circle(uv, radius, -x, y)) {\n      gl_FragColor = src;\n    }else{\n    \tgl_FragColor = vec4(0.0, 0.0, 0.3, 1.0);\t\n    }\n    return gl_FragColor;\n  }\n\n  // negative\n  // negative 3 (reversed channel)\n  if ( currentcoloreffect == 2  ) return vec4( 1.-src.r, 1.-src.g, 1.-src.b, src.a );\n  // negative 3 (inverted channel high)\n  if ( currentcoloreffect == 3  ) return vec4( 1./src.r-1.0, 1./src.g-1.0, 1./src.b-1.0, src.a );\n  // negative 3 (inverted channel, low)\n  if ( currentcoloreffect == 4  ) return vec4( 1./src.r-2.0, 1./src.g-2.0, 1./src.b-2.0, src.a );\n  // negative 4 (inverted colors, inverted bw )\n  if ( currentcoloreffect == 5  ) return vec4( src.g + src.b / 2., src.r + src.b / 2., src.r + src.b / 2., src.a );\n  // negative 5 (normal colors, inverted b/w)\n  if ( currentcoloreffect == 6  ) return vec4( ( (src.r/2.) + ( ( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).r) ), ( (src.g/2.) + (( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).g) ), ( (src.b/2.) + ( ( ( (vec3( src.r + src.g + src.b ) / 3.) * -1.) + 1. ).b) ), src.a );\n\n  // monocolor\n  if ( currentcoloreffect == 10 ) return vec4( vec3( src.r + src.g + src.b ) / 3., src.a );                                                            // black and white\n  if ( currentcoloreffect == 11 ) return vec4( vec3( (src.r+src.g+src.b) *3.  , (src.r+src.g+src.b)  /1.7 , (src.r+src.g+src.b) /1.7 ) / 3., src.a );  // mopnocolor red\n  if ( currentcoloreffect == 12 ) return vec4( vec3( (src.r+src.g+src.b) /1.7 , (src.r+src.g+src.b)  *3.  , (src.r+src.g+src.b) /1.7 ) / 3., src.a );  // mopnocolor blue\n  if ( currentcoloreffect == 13 ) return vec4( vec3( (src.r+src.g+src.b) /1.7 , (src.r+src.g+src.b)  /1.7 , (src.r+src.g+src.b) *3.  ) / 3., src.a );  // mopnocolor green\n  if ( currentcoloreffect == 14 ) return vec4( vec3( (src.r+src.g+src.b) *2.  , (src.r+src.g+src.b)  *2.  , (src.r+src.g+src.b) /1.2 ) / 3., src.a );  // mopnocolor yellow\n  if ( currentcoloreffect == 15 ) return vec4( vec3( (src.r+src.g+src.b) *1.2 , (src.r+src.g+src.b)  *2.  , (src.r+src.g+src.b) *2.  ) / 3., src.a );  // mopnocolor turqoise\n  if ( currentcoloreffect == 16 ) return vec4( vec3( (src.r+src.g+src.b) *2.  , (src.r+src.g+src.b)  /1.2 , (src.r+src.g+src.b) *2.  ) / 3., src.a );  // mopnocolor purple\n  if ( currentcoloreffect == 17 ) return vec4( vec3( src.r + src.g + src.b ) / 3. * vec3( 1.2, 1.0, 0.8 ), src.a);                                     // sepia\n\n  // color swapping\n  if ( currentcoloreffect == 20 ) return vec4( src.rrra );\n  if ( currentcoloreffect == 21 ) return vec4( src.rrga );\n  if ( currentcoloreffect == 22 ) return vec4( src.rrba );\n  if ( currentcoloreffect == 23 ) return vec4( src.rgra );\n  if ( currentcoloreffect == 24 ) return vec4( src.rgga );\n  if ( currentcoloreffect == 25 ) return vec4( src.rbra );\n  if ( currentcoloreffect == 26 ) return vec4( src.rbga );\n  if ( currentcoloreffect == 27 ) return vec4( src.rbba );\n  if ( currentcoloreffect == 28 ) return vec4( src.grra );\n  if ( currentcoloreffect == 29 ) return vec4( src.grga );\n  if ( currentcoloreffect == 30 ) return vec4( src.grba );\n  if ( currentcoloreffect == 31 ) return vec4( src.ggra );\n  if ( currentcoloreffect == 32 ) return vec4( src.ggga );\n  if ( currentcoloreffect == 33 ) return vec4( src.ggba );\n  if ( currentcoloreffect == 34 ) return vec4( src.gbra );\n  if ( currentcoloreffect == 35 ) return vec4( src.gbga );\n  if ( currentcoloreffect == 36 ) return vec4( src.gbba );\n  if ( currentcoloreffect == 37 ) return vec4( src.brra );\n  if ( currentcoloreffect == 38 ) return vec4( src.brga );\n  if ( currentcoloreffect == 39 ) return vec4( src.brba );\n  if ( currentcoloreffect == 40 ) return vec4( src.bgra );\n  if ( currentcoloreffect == 41 ) return vec4( src.bgga );\n  if ( currentcoloreffect == 42 ) return vec4( src.bgba );\n  if ( currentcoloreffect == 43 ) return vec4( src.bbra );\n  if ( currentcoloreffect == 44 ) return vec4( src.bbga );\n  if ( currentcoloreffect == 45 ) return vec4( src.bbba );\n\n  // lum key\n  if ( currentcoloreffect == 50 ) {\n    float red = clamp( src.r, extra, 1.) == extra ? .0 : src.r;\n    float green = clamp( src.g, extra, 1.) == extra ? .0 : src.g;\n    float blue = clamp( src.b, extra, 1.) == extra ? .0 : src.b;\n    float alpha = red + green + blue == .0 ? .0 : src.a;\n    return vec4( red, green, blue, alpha );\n  }\n\n\n\n  // color key; Greenkey\n  if ( currentcoloreffect == 51 ) {\n    return vec4( src.r, clamp( src.r, extra, 1.) == extra ? .0 : src.g, src.b, clamp( src.r, extra, 1.) == extra ? .0 : src.a );\n  }\n\n  // paint\n  if ( currentcoloreffect == 52 ) {\n    // return vec4( floor( src.r * extra ) / extra, floor( src.g * extra ) / extra, floor( src.b * extra ) / extra, src.a  );\n    // devide the image up in color bars\n    vec4 pnt = vec4(\n      src.x < .1 ? .1 : src.x < .2 ? .2 : src.x < .3 ? .3 : src.x < .4 ? .4 : src.x < .5 ? .5 : src.x < .6 ? .6 : src.x < .7 ? .7 : src.x < .8 ? .8 : src.x < .9 ? .9 : src.x,\n      src.y < .1 ? .1 : src.y < .2 ? .2 : src.y < .3 ? .3 : src.y < .4 ? .4 : src.y < .5 ? .5 : src.y < .6 ? .6 : src.y < .7 ? .7 : src.y < .8 ? .8 : src.y < .9 ? .9 : src.y,\n      src.z < .1 ? .1 : src.z < .2 ? .2 : src.z < .3 ? .3 : src.z < .4 ? .4 : src.z < .5 ? .5 : src.z < .6 ? .6 : src.z < .7 ? .7 : src.z < .8 ? .8 : src.z < .9 ? .9 : src.z,\n      src.a\n    );\n\n    return pnt;\n  }\n\n  // colorise\n  if ( currentcoloreffect == 53 ) {\n\n    // TODO: mix paint and colorize together?\n\n    // devide the image up in color bars\n    vec4 pnt = vec4(\n      src.x < .1 ? .1 : src.x < .2 ? .2 : src.x < .3 ? .3 : src.x < .4 ? .4 : src.x < .5 ? .5 : src.x < .6 ? .6 : src.x < .7 ? .7 : src.x < .8 ? .8 : src.x < .9 ? .9 : src.x,\n      src.y < .1 ? .1 : src.y < .2 ? .2 : src.y < .3 ? .3 : src.y < .4 ? .4 : src.y < .5 ? .5 : src.y < .6 ? .6 : src.y < .7 ? .7 : src.y < .8 ? .8 : src.y < .9 ? .9 : src.y,\n      src.z < .1 ? .1 : src.z < .2 ? .2 : src.z < .3 ? .3 : src.z < .4 ? .4 : src.z < .5 ? .5 : src.z < .6 ? .6 : src.z < .7 ? .7 : src.z < .8 ? .8 : src.z < .9 ? .9 : src.z,\n      src.a\n    );\n\n    // colorize effect, fill the colors with random values\n    ( pnt.r == .1 || pnt.g == .1 || pnt.b == .1 ) ? pnt.rgb = vec3( 1.0, 0.0, 0.0) : pnt.rgb;\n    ( pnt.r == .2 || pnt.g == .2 || pnt.b == .2 ) ? pnt.rgb = vec3( 0.0, 1.0, 0.0) : pnt.rgb;\n    ( pnt.r == .3 || pnt.g == .3 || pnt.b == .3 ) ? pnt.rgb = vec3( 0.0, 0.0, 1.0) : pnt.rgb;\n    ( pnt.r == .4 || pnt.g == .4 || pnt.b == .4 ) ? pnt.rgb = vec3( 1.0, 1.0, 0.0) : pnt.rgb;\n    ( pnt.r == .5 || pnt.g == .5 || pnt.b == .5 ) ? pnt.rgb = vec3( 0.0, 1.0, 1.0) : pnt.rgb;\n    ( pnt.r == .6 || pnt.g == .6 || pnt.b == .6 ) ? pnt.rgb = vec3( 1.0, 0.0, 1.0) : pnt.rgb;\n    ( pnt.r == .7 || pnt.g == .7 || pnt.b == .7 ) ? pnt.rgb = vec3( 1.0, 0.49, 0.49) : pnt.rgb;\n    ( pnt.r == .8 || pnt.g == .8 || pnt.b == .8 ) ? pnt.rgb = vec3( 0.49, 1.0, 0.49) : pnt.rgb;\n    ( pnt.r == .9 || pnt.g == .9 || pnt.b == .9 ) ? pnt.rgb = vec3( 0.49, 0.49, 1.0) : pnt.rgb;\n\n    return pnt;\n  }\n\n  // BRIGHTNESS [ 0 - 1 ]\n  // http://blog.ruofeidu.com/postprocessing-brightness-contrast-hue-saturation-vibrance/\n  if ( currentcoloreffect == 60 ) {\n    return vec4( src.rgb + extra, src.a );\n    //return vec4( src.rgb ^ (extra+1), src.a );\n  }\n\n  // CONTRAST [ 0 - 3 ]\n  if ( currentcoloreffect == 61 ) {\n    extra = extra * 3.;\n    float t = 0.5 - extra * 0.5;\n    src.rgb = src.rgb * extra + t;\n    return vec4( src.rgb, src.a );\n  }\n\n  // SATURATION [ 0 - 5 ]\n  if ( currentcoloreffect == 62 ) {\n    extra = extra * 5.;\n    vec3 luminance = vec3( 0.3086, 0.6094, 0.0820 );\n    float oneMinusSat = 1.0 - extra;\n    vec3 red = vec3( luminance.x * oneMinusSat );\n    red.r += extra;\n\n    vec3 green = vec3( luminance.y * oneMinusSat );\n    green.g += extra;\n\n    vec3 blue = vec3( luminance.z * oneMinusSat );\n    blue.b += extra;\n\n    return mat4(\n      red,     0,\n      green,   0,\n      blue,    0,\n      0, 0, 0, 1 ) * src;\n  }\n\n  // SHIFT HUE\n  if ( currentcoloreffect == 63 ) {\n    vec3 P = vec3(0.55735) * dot( vec3(0.55735), src.rgb );\n    vec3 U = src.rgb - P;\n    vec3 V = cross(vec3(0.55735), U);\n    src.rgb = U * cos( extra * 6.2832) + V * sin( extra * 6.2832) + P;\n    return src;\n  }\n\n  // hard black edge\n  if ( currentcoloreffect == 64 ) {\n    src.r + src.g + src.b > extra * 3.0? src.rgb = vec3( 1.0, 1.0, 1.0 ) : src.rgb = vec3( 0.0, 0.0, 0.0 );\n    return src;\n  }\n\n  // greenkey\n  if ( currentcoloreffect == 80 ) {\n    float temp_g = src.g;\n\n    //if ( src.g > 0.99 ) { // 135\n    if ( src.g > 0.2 && src.r < 0.2 && src.b < 0.2 ){\n      src.r = 0.0;\n      src.g = 0.0;\n      src.b = 0.0;\n      src.a = 0.0;\n    }\n\n    if ( src.g > 0.2 && src.r < 0.2 && src.b < 0.2 ){\n      src.r + src.g + src.b > extra * 3.0? src.rgb = vec3( 1.0, 1.0, 1.0 ) : src.rgb = vec3( 0.0, 0.0, 0.0 );\n    }\n\n\n    float maxrb = max( src.r, src.b );\n    float k = clamp( (src.g-maxrb)*5.0, 0.0, 1.0 );\n\n    //float ll = length( src );\n    //src.g = min( src.g, maxrb*0.8 );\n    //src = ll*normalize(src);\n\n    return vec4( mix(src.xyz, vec3(0.0, 0.0, 0.0), k), src.a );\n\n    //return vec4( src.xyz, src.a );\n    //return src;\n  }\n\n  // greenkey 2\n  if ( currentcoloreffect == 81 ) {\n\n    float maxrb = max( src.r, src.b );\n    float k = clamp( (src.g-maxrb)*5.0, 0.0, 1.0 );\n\n    //\n\n    //float ll = length( src );\n    //src.g = min( src.g, maxrb*0.8 );\n    //src = ll*normalize(src);\n\n    //else\n\n    //float dg = src.g;\n    //src.g = min( src.g, maxrb*0.8 );\n    //src += dg - src.g;\n\n    //#endif\n\n    vec3 bg = src.xyz;\n    bg.r = 0.0;\n    bg.g = 0.0;\n    bg.b = 0.0;\n\n    return vec4( mix(src.xyz, bg, k), mix( 1.0, 0.0, k) );\n    //return src;\n  }\n\n  if ( currentcoloreffect == 70 ) {\n    return src;\n  }\n\n\n\n\n\n  // default\n  return src;\n}\n\n/* custom_helpers */\n")),t=t.replace("/* custom_main */","vec4 "+n.uuid+"_output = coloreffect( "+r.uuid+"_output, "+n.uuid+"_currentcoloreffect, "+n.uuid+"_extra, vUv );\n  /* custom_main */"),1==n._fragmentChannel?e.fragmentShader=t:e.fragmentShader2=t},n.update=function(){},n.effect=function(t){return null!=t&&(o=t,console.log("effect set to: ",o),e.customUniforms[n.uuid+"_currentcoloreffect"].value=o),o},n.extra=function(t){return null!=t&&(a=t,e.customUniforms[n.uuid+"_extra"].value=a),n.debug&&console.log("extra set to: ",a),a}}function DistortionEffect2(e,t){var n=this;null==t.uuid?n.uuid="DistortionEffect2_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,null==t.fragmentChannel?n._fragmentChannel=1:n._fragmentChannel=t.fragmentChannel,e.add(n),n.type="Effect";var r=t.source,o=t.effect,a=(o=1,.8),c=0;n.init=function(){var t;e.customUniforms[n.uuid+"_currentDistortionEffect2"]={type:"i",value:1},e.customUniforms[n.uuid+"_extra"]={type:"f",value:2},e.customUniforms[n.uuid+"_extra2"]={type:"f",value:2},-1==(t=(t=(t=(t=(t=1==n._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+n.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+n.uuid+"_currentDistortionEffect2;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+n.uuid+"_extra;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+n.uuid+"_extra2;\n/* custom_uniforms */")).indexOf("vec4 DistortionEffect2 ( sampler2D src, int currentDistortionEffect2, float extra, float extra2, vec2 vUv )")&&(console.log("DistortionEffect2 REPLACE"),t=t.replace("/* custom_helpers */","\n\n  bool mask_circle(vec2 uv, float radius, float x, float y){\n      \n    // uv.x *= 1.6; \n     uv.y /= (16.0 / 9.0);\n    float len = sqrt(pow((uv.x - x),2.0) + pow(uv.y - y,2.0));\n    if(len < radius){\n      return true;\n    }\n    return false;\n  }\n  \n  bool tophTest(float a){\n    return true;\n  }\n  \n  vec4 DistortionEffect2 ( sampler2D src, int currentDistortionEffect2, float extra, float extra2, vec2 vUv ) {\n    \n    // normal\n    if ( currentDistortionEffect2 == 1 ) {\n      return texture2D( src, vUv ).rgba;\n    }\n  \n    //ONLY CIRCLE\n    if ( currentDistortionEffect2 == 105 ) {\n  \n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      float radius = 0.28;\n      float scale = 1.0; //Size of video.\n  \n      if(mask_circle(uv, radius, 0.0, 0.0)) {\n        vec2 uvs = vec2(uv);\n        uvs *= scale;\n        vec4 pixelColor = texture2D(src, vec2(uvs.x + 0.5, uvs.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0);\t\n        discard;\n      }\n      return gl_FragColor;\n    }//105\n  \n    //MIRROR_VERTICAL\n    if ( currentDistortionEffect2 == 106 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n      if (uv.y >= 0.0){\n       pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      }else{\n        pixelColor = texture2D(src, vec2(uv.x + 0.5, -uv.y + 0.5)); \n      }\n      // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n      gl_FragColor = vec4(pixelColor);\n      return gl_FragColor;\n    }//MIRROR_VERTICAAL\n  \n    //MIRROR_HORIZONTAL\n    if ( currentDistortionEffect2 == 107 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n      if (uv.x > 0.0){\n        pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      }else{\n        pixelColor = texture2D(src, vec2(-uv.x + 0.5, uv.y + 0.5)); \n      }\n      // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n      gl_FragColor = vec4(pixelColor);\n      return gl_FragColor;\n    }//MIRROR_VERTICAAL\n\n      //MIRROR_BOTH\n    if ( currentDistortionEffect2 == 109 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      vec4 pixelColor;\n\n      if (uv.x > 0.0){\n        if (uv.y >= 0.0){\n          pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        }else{\n          pixelColor = texture2D(src, vec2(uv.x + 0.5, -uv.y + 0.5)); \n        }      \n      }else{\n        if (uv.y >= 0.0){\n          pixelColor = texture2D(src, vec2(-uv.x + 0.5, uv.y + 0.5));          \n        }else{\n          pixelColor = texture2D(src, vec2(-uv.x + 0.5, -uv.y + 0.5));        \n        }\n      }\n      gl_FragColor = vec4(pixelColor);\n\n        // gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0); \n\n      return gl_FragColor;\n    }//MIRROR_BOTH\n\n\n    //WIPE_HORIZONTAL\n    if ( currentDistortionEffect2 == 108 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      if (uv.x > (extra - 0.5)){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_HORIZONTAL\n  \n\n    //WIPE_VERTICAL\n    if ( currentDistortionEffect2 == 110 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      if (uv.y > (extra - 0.5)){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_VERTICAL\n\n\n\n     //WIPE_ANGLE\n    if ( currentDistortionEffect2 == 111 ) {\n\n    float ratio = extra;\n    float angle = extra2;\n      // Convert angle to radians\n      float angleRad = angle * 3.141 * 2.0;\n\n      // Calculate the direction of the wipe\n      vec2 direction = vec2(cos(angleRad), sin(angleRad));\n\n      // Compute the position relative to the center\n      vec2 center = vec2(0.5, 0.5);\n      vec2 relativePos = vUv - center;\n\n      // Project the relative position onto the direction vector\n      float projection = dot(relativePos, direction);\n\n      // Determine if the current pixel is before or after the wipe threshold\n      if (projection < ratio - 0.5) {\n          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); // Black\n      } else {\n          // gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0); // White\n        vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n          vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5));\n          gl_FragColor = vec4(pixelColor);\n      }\n\n      return gl_FragColor;\n    }//WIPE_ANGLE\n\n            //WIPE_DONUT\n    if ( currentDistortionEffect2 == 112 ) {\n      vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n\n      vec2 p = vUv - 0.5;\n\t\t\t// float r = length(p)*2.0;\n\t\t\tfloat r = length(p);\n\n      if (r > extra){\n        vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n        gl_FragColor = vec4(pixelColor);\n      }else{\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      }\n\n      return gl_FragColor;\n    }//WIPE_DONUT\n\n        //KALEIDO - https://github.com/mrdoob/three.js/blob/dev/examples/jsm/shaders/KaleidoShader.js\n    if ( currentDistortionEffect2 == 120 ) {\n\n\n      float sides = 0.0 + 20.0 * extra;\n      float angle = 1.0;\n      // float angle = 2.0 * extra2;\n      vec2 p = vUv - 0.5;\n\t\t\t// float r = length(p)*2.0;\n\t\t\tfloat r = length(p);\n\t\t\tfloat a = atan(p.y, p.x) + angle;\n\t\t\tfloat tau = 2. * 3.1416;\n\t\t\ta = mod(a, tau/sides);\n\t\t\ta = abs(a - tau/sides/2.) + extra2 * 3.14 ;\n\t\t\tp = r * vec2(cos(a), sin(a));\n\t\t\tvec4 color = texture2D(src, p + 0.5);\n\t\t\tgl_FragColor = color;\n\n      // vec2 uv = vec2(vUv.x - 0.5, vUv.y - 0.5); //assuming they are 0 to 1.\n      // if (uv.x > (extra - 0.5)){\n      //   vec4 pixelColor = texture2D(src, vec2(uv.x + 0.5, uv.y + 0.5)); \n      //   gl_FragColor = vec4(pixelColor);\n      // }else{\n      //   gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); \n      // }\n\n      return gl_FragColor;\n    }//KALEIDO\n  \n    \n  }\n  \n  \n  \n  \n    // -------------\n  \n\n  \n  /* custom_helpers */\n  \n  \n  ")),t=t.replace("/* custom_main */","      vec4 "+n.uuid+"_output = DistortionEffect2( "+r.uuid+", "+n.uuid+"_currentDistortionEffect2, "+n.uuid+"_extra, "+n.uuid+"_extra2, vUv );\n  /* custom_main */"),1==n._fragmentChannel?e.fragmentShader=t:e.fragmentShader2=t};n.update=function(){.001},n.effect=function(t){return null!=t&&(o=t,e.customUniforms[n.uuid+"_currentDistortionEffect2"]&&(e.customUniforms[n.uuid+"_currentDistortionEffect2"].value=t)),o},n.extra=function(t){return null!=t&&(a=t,e.customUniforms[n.uuid+"_extra"]&&(e.customUniforms[n.uuid+"_extra"].value=a)),t},n.extra2=function(t){return null!=t&&(c=t,e.customUniforms[n.uuid+"_extra2"]&&(e.customUniforms[n.uuid+"_extra2"].value=c)),t}}function FeedbackEffect(e,t){var n=this;null==t.uuid?n.uuid="FeedbackEffect_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,e.add(n),n.type="Effect";var r,o,a=t.source,c=t.effect,u=(c=12,.8),i=128*window.devicePixelRatio;new Uint8Array(i*i*3);n.init=function(){(r=document.createElement("canvas")).width=1024,r.height=1024,canvasElementContext=r.getContext("2d"),canvasElementContext.fillStyle="#000000",canvasElementContext.fillRect(0,0,1024,1024),console.log("FeedbackEffect inits, with",e),(o=new THREE.Texture(r)).wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.repeat.set(4,4),e.customUniforms[n.uuid+"_effectsampler"]={type:"t",value:o},e.customUniforms[n.uuid+"_currentfeedbackeffect"]={type:"i",value:c},e.customUniforms[n.uuid+"_extra"]={type:"i",value:u},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+n.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D  "+n.uuid+"_effectsampler;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform int  "+n.uuid+"_currentfeedbackeffect;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float  "+n.uuid+"_extra;\n/* custom_uniforms */"),-1==renderer.fragmentShader.indexOf("vec4 feedbackeffect ( vec4 src, int currentfeedbackeffect, vec2 vUv )")&&(e.fragmentShader=e.fragmentShader.replace("/* custom_helpers */","\n  vec4 feedbackeffect ( vec4 src, int currentfeedbackeffect, vec2 vUv ) {\n\n    if ( currentfeedbackeffect == 100 ) {\n      // vec4 inbetween = vec4( src.r, src.g, src.b, vUv * 0.9. );\n      // gl_Position = vec4( vec2(0.,0.), 0., 0.);\n      // return inbetween.rrr;\n      // return src;\n\n      // return vec4(0., 0., 1., 1.);\n\n      vec2 wuv = vec2(0.,0.);\n      // wuv = vUv * vec2( 1.0, 1.0 ) - vec2( 0., 0. );\n      wuv = vUv; //* vec2( 1.0, 1.0 ) - vec2( 0., 0. );\n      //wuv = vUv - vec2( 0.1, 0. );\n      // wuv = vUv + vec2( extra, extra );\n      // return texture2D( src, wuv ).rgba;\n\n      return vec4( vec4( ( texture2D( "+n.uuid+"_effectsampler, wuv ).rgba * 0.9 ) + (src.rgba * .6 ) ).rgb, 1.);\n\n      // return ( texture2D( , vUv + vec2( 1., 0.99999999) ).rgba ) + src * 0.3;\n\n      // return ( texture2D( "+n.uuid+"_effectsampler, vUv  ).rgb * 1.4 + src * .8) * 0.5; //* vec3(.5, .5, .5\n      // return ( texture2D( src, vUv ).rgb );\n      // return ( texture2D( "+n.uuid+"_effectsampler, vUv  ).rgb ) * src + src;\n\n      //vec4 wuv = wuv = vUv * vec2( extra*6., extra*6. ) - vec2( extra * 3., extra * 3. );\n      //vec4 tex = texture2D( "+n.uuid+"_effectsampler, wuv ); //+ vec4( src.r, src.g, src.b, vUv * 2. );\n\n      // return src.rrr;\n      // tex.rgb = vec3(src.r, src.g, src.b);\n      // tex.xy = vec2(1.0,1.0);\n      // tex = tex + vec4( src.r, src.g, src.b, vUv * 2. );\n\n\n      // * 0.52 + vec4( src * 0.52, vUv ) *\n      // vec4 tex = vec4( src, vUv * .5 );\n      // return mix( tex, "+n.uuid+"_effectsampler, 0.).rgb;\n      // return mix(tex.rgb, src.rgb, 1.);\n    }\n\n    // uniform float noiseScale;\n    // uniform float time;\n    // uniform float baseSpeed;\n    // uniform sampler2D noiseTexture;\n\n    if ( currentfeedbackeffect == 101 ) {\n      // vec2 uvTimeShift = vUv + vec2( -0.7, 1.5 ) * time * baseSpeed;\n      // vec4 noiseGeneratorTimeShift = texture2D( noiseTexture, uvTimeShift );\n      // vec2 uvNoiseTimeShift = vUv + noiseScale * vec2( noiseGeneratorTimeShift.r, noiseGeneratorTimeShift.a );\n\n      // _effectsampler\n      // return  vec4 texture2D( baseTexture1, uvNoiseTimeShift )\n\n      // https://stackoverflow.com/questions/19872524/threejs-fragment-shader-using-recycled-frame-buffers\n      // http://labs.sense-studios.com/webgl/index4.html?r=sdad\n\n      // return _effectsampler.rgb\n      return src;\n    }\n\n    return src;\n  }\n\n  /* custom_helpers */\n")),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+n.uuid+"_output = feedbackeffect( "+a.uuid+"_output, "+n.uuid+"_currentfeedbackeffect, vUv );\n  /* custom_main */")};new THREE.Vector2;var s=0;n.update=function(){if(s++,glcanvas=document.getElementById("glcanvas"),s%4==0){var e=1024*(1.6*u),t=(1024-e)/2;canvasElementContext.drawImage(glcanvas,t,t,e,e)}o&&(o.needsUpdate=!0)},n.effect=function(e){return null!=e&&(c=e,renderer.customUniforms[n.uuid+"_currentfeedbackeffect"].value=c),c},n.extra=function(e){return null!=e&&(u=e,renderer.customUniforms[n.uuid+"_extra"].value=u),u}}AudioAnalysis.prototype=new Addon,AudioAnalysis.constructor=AudioAnalysis,BPM.prototype=new Addon,BPM.constructor=BPM,FileManager.prototype=new Addon,FileManager.constructor=FileManager,GiphyManager.prototype=new Addon,GiphyManager.constructor=GiphyManager,document.body.onload=function(){console.log("--------- cake.js onload ------------"),start(),initKeyboardTips()},GamePadController.prototype=new Controller,GamePadController.constructor=GamePadController,KeyboardController.prototype=new Controller,KeyboardController.constructor=KeyboardController,MidiController.prototype=new Controller,MidiController.constructor=MidiController,SocketController.prototype=new Controller,SocketController.constructor=SocketController,ColorEffect.prototype=new Effect,ColorEffect.constructor=ColorEffect,DistortionEffect2.prototype=new Effect,DistortionEffect2.constructor=DistortionEffect2,FeedbackEffect.prototype=new Effect,FeedbackEffect.constructor=FeedbackEffect;import*as THREE from"three";const clock=new THREE.Clock,initial_texture=(new THREE.TextureLoader).load("./circles.jpg"),fb_fragment="\nuniform vec2 u_resolution;\nuniform sampler2D u_in_buffer;\nuniform sampler2D u_init_buffer;\nuniform float u_time;\nuniform float u_extra;\n\n#define UV_ORIGIN 0.5\n#define ZOOM 1.00\n#define SPEED 1.01\nconst float PI = 3.14;\n\n// Take this and multiply your UV by the resulting mat2 to get the rotation\nmat2 rotationMatrix(float angle)\n{\n\tangle *= PI / 180.0;\n    float sine = sin(angle), cosine = cos(angle);\n    return mat2( cosine, -sine, \n                 sine,    cosine );\n}\n\nvoid main() {\n  // vec2 uv = gl_FragCoord.xy / u_resolution;\n\n    vec2 st = gl_FragCoord.xy / u_resolution;\n    vec2 uv = st;\n\n    // Float around\n    // uv *= vec2(1. + 0.02 * sin(u_time / 10.), 1. - 0.02 * cos(u_time/2.));\n\n    // Zoom\n    float zoom = .02;\n    uv *= vec2(1. - (uv.x - 0.5) *zoom, 1. - (uv.y - 0.5)* zoom);\n\n    // Rotate\n\n    // vec2 pivot = vec2(0.5, 0.5);\n    // uv -= pivot;\n    // uv *= rotationMatrix( 0.2) * ZOOM;\n    //  uv += pivot;\n\n\n    vec4 sum = texture2D(u_in_buffer, uv);\n    vec4 src = texture2D(u_init_buffer, st);\n\n    //Invert?\n    // sum = vec4( 1.-sum.r, 1.-sum.g, 1.-sum.b, sum.a );\n// src = vec4( 1.-src.r, 1.-src.g, 1.-src.b, src.a );\n\n    sum.rgb = mix(sum.rbg, src.rgb, (1.0 - u_extra));\n\n  \n    gl_FragColor = sum;\n}\n";let material_in,material_out;var GlRenderer=function(e){console.log("START GlRenderer  -------------------");var t=this;t.options={element:"glcanvas"},null!=e&&(t.options=e),t.options.canvas?t.element=t.options.canvas:t.element=document.getElementById(t.options.element),t.onafterrender=function(){},t.setFeedbackEffect=function(e){t.u_extra=e},t.setRotationVel1=function(e){t.rotation_vel_1=e},t.setRotationVel2=function(e){t.rotation_vel_2=e},t.setRotationAccel1=function(e){t.rotation_accel_1=e},t.resetRotationVel1=function(){t.rotation_vel_1=0,t.surface.rotation.z=0},t.resetRotationVel2=function(){t.rotation_vel_2=0,t.surface2.rotation.z=0,t.surface3.rotation.z=0},t.resetRotationAccel1=function(){t.rotation_accel_1=0,t.rotation_vel_1=0,t.surface.rotation.z=0},t.options.width&&t.options.height?(t.width=t.options.width,t.height=t.options.height):(t.width=window.innerWidth,t.height=window.innerHeight),t.textureA=new THREE.WebGLRenderTarget(t.width,t.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),t.textureB=new THREE.WebGLRenderTarget(t.width,t.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),t.textureC=new THREE.WebGLRenderTarget(t.width,t.width,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,colorSpace:THREE.LinearSRGBColorSpace}),t.u_extra=.5,t.scene=new THREE.Scene,t.in_scene=new THREE.Scene,t.in_scene_c=new THREE.Scene,t.camera=new THREE.PerspectiveCamera(75,t.width/t.height,.1,1e3),t.camera.position.z=27,t.cameraSquare=new THREE.PerspectiveCamera(75,t.width/t.width,.1,1e3),t.cameraSquare.position.z=27,t.nodes=[],t.customUniforms={},t.customDefines={};var n=0;t.customUniforms.time={type:"f",value:n},t.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(t.width,t.height)},t.rotation_vel_1=0,t.rotation_vel_2=0,t.rotation_accel_1=0,t.vertexShader="\n        varying vec2 vUv;        void main() {          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );          vUv = uv;        }\n      ",t.fragmentShader="\n        uniform float time;\n        uniform vec2 screenSize;\n    \n        /* custom_uniforms */        /* custom_helpers */        varying vec2 vUv;        void main() {          /* custom_main */        }\n      ",t.fragmentShader2="\n      uniform float time;\n      uniform vec2 screenSize;\n  \n      /* custom_uniforms */      /* custom_helpers */      varying vec2 vUv;      void main() {        /* custom_main */      }\n    ",t.init=function(){console.log("INIT Renderer -------------------"),t.glrenderer=new THREE.WebGLRenderer({canvas:t.element,alpha:!1,preserveDrawingBuffer:!0}),t.glrenderer.outputEncoding=THREE.sRGBEncoding,t.glrenderer.outputColorSpace=THREE.LinearSRGBColorSpace,t.nodes.forEach(function(e){e.init()}),t.shaderMaterial=new THREE.ShaderMaterial({uniforms:t.customUniforms,defines:t.customDefines,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,side:THREE.DoubleSide,transparent:!0}),t.shaderMaterial2=new THREE.ShaderMaterial({uniforms:t.customUniforms,defines:t.customDefines,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader2,side:THREE.DoubleSide,transparent:!0});t.flatGeometry=new THREE.CircleGeometry(19.96875,50),t.surface=new THREE.Mesh(t.flatGeometry,t.shaderMaterial),t.in_scene_c.add(t.surface);new THREE.PlaneGeometry(39.9375,39.9375);material_out=new THREE.MeshBasicMaterial({map:initial_texture});const e=new THREE.Mesh(t.flatGeometry,material_out);t.scene.add(e),t.flatGeometry2=new THREE.CircleGeometry(19.96875,300),t.flatGeometry2.rotateY(Math.PI/1),t.surface2=new THREE.Mesh(t.flatGeometry2,t.shaderMaterial2),t.surface2.scale.set(.3,.3,.3),t.surface2.position.set(25,-13,1),t.flatGeometry3=new THREE.CircleGeometry(19.96875,300),t.surface3=new THREE.Mesh(t.flatGeometry3,t.shaderMaterial2),t.surface3.scale.set(.3,.3,.3),t.surface3.position.set(-25,-13,1);const n=new THREE.PlaneGeometry(39.9375,39.9375),r={u_in_buffer:{value:t.textureA.texture},u_init_buffer:{value:initial_texture},u_resolution:{value:new THREE.Vector2(t.width,t.height)},u_time:{value:0},u_extra:{value:.5}};material_in=new THREE.ShaderMaterial({uniforms:r,fragmentShader:fb_fragment});const o=new THREE.Mesh(n,material_in);t.in_scene.add(o),t.scene.add(t.surface2),t.scene.add(t.surface3)},t.render=function(){requestAnimationFrame(t.render),material_in.uniforms.u_time.value=clock.getElapsedTime(),material_in.uniforms.u_extra.value=t.u_extra,t.glrenderer.setRenderTarget(t.textureB),t.glrenderer.render(t.in_scene,t.cameraSquare);var e=t.textureA;t.textureA=t.textureB,t.textureB=e,material_out.map=t.textureB.texture,material_out.map.encoding=THREE.sRGBEncoding,t.glrenderer.setRenderTarget(t.textureC),t.glrenderer.render(t.in_scene_c,t.cameraSquare),material_in.uniforms.u_in_buffer.value=t.textureA.texture,material_in.uniforms.u_init_buffer.value=t.textureC.texture,material_in.uniforms.u_resolution.value=new THREE.Vector2(t.width,t.width),t.glrenderer.setRenderTarget(null),t.glrenderer.render(t.scene,t.camera),t.onafterrender(),t.glrenderer.setSize(t.width,t.height),t.nodes.forEach(function(e){e.update()}),n++,t.customUniforms.time.value=n,t.surface.rotation.z+=t.rotation_vel_1*Math.PI/50,t.surface2.rotation.z+=t.rotation_vel_2*Math.PI/50,t.surface3.rotation.z-=t.rotation_vel_2*Math.PI/50,t.rotation_vel_1+=parseFloat(t.rotation_accel_1)*Math.PI/50},t.setRight=function(e){t.surface2.rotation.y=0==e?Math.PI/1:0},t.setLeft=function(e){t.surface3.rotation.y=0==e?Math.PI/1:0},t.setChannels=function(e,n){t.surface.material=e?t.shaderMaterial2:t.shaderMaterial,n?(t.surface2.material=t.shaderMaterial2,t.surface3.material=t.shaderMaterial2):(t.surface2.material=t.shaderMaterial,t.surface3.material=t.shaderMaterial)},t.resize=function(){t.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(t.width,t.height)},t.camera.aspect=t.width/t.height,t.camera.updateProjectionMatrix(),t.glrenderer.setSize(t.width,t.height)},window.addEventListener("resize",function(){t.resize()}),t.add=function(e){t.nodes.push(e)},t.dispose=function(){t.shaderMaterial,t.flatGeometry,t.shaderMaterial2,t.flatGeometry2,t.shaderMaterial3,t.flatGeometry3,t.scene.remove(t.surface),t.scene.remove(t.surface2),t.scene.remove(t.surface3),t.glrenderer.resetGLState(),t.customUniforms={},t.customDefines={},n=0,t.customUniforms.time={type:"f",value:n},t.customUniforms.screenSize={type:"v2",value:new THREE.Vector2(t.width,t.height)},t.vertexShader="\n          varying vec2 vUv;\n          void main() {\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            vUv = uv;\n          }\n        ",t.fragmentShader="\n          uniform int time;\n          uniform vec2 screenSize;\n    \n          /* custom_uniforms */\n          /* custom_helpers */\n          varying vec2 vUv;\n          void main() {\n            /* custom_main */\n          }\n        ",t.fragmentShader2="\n        uniform int time;\n        uniform vec2 screenSize;\n  \n        /* custom_uniforms */\n        /* custom_helpers */\n        varying vec2 vUv;\n        void main() {\n          /* custom_main */\n        }\n      ",t.nodes=[]}},Mapping=class{static function_list(){return[]}static help(){return"ownoes"}constructor(e,t){var n=this;null!=e&&(null==t.uuid?n.uuid="Mapping_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,n.renderer=e,n.source=t.source,e.add(n),n.type="Module",n.internal_renderer=null,n.init=function(){n.vertexShader_test="\n          varying vec2 vUv;          void main() {            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );            vUv = uv;          }\n        ",n.fragmentShader_test="\n            uniform float time;\n            uniform vec2 screenSize;\n  \n            /* custom_uniforms */            /* custom_helpers */            varying vec2 vUv;            void main() {              /* custom_main */            }\n          ",n.internal_renderer=new GlRenderer({element:t.element}),console.log(" fragment_shader: "),n.internal_renderer.fragmentShader=n.renderer.fragmentShader,n.internal_renderer.vertexShader=n.renderer.vertexShader,console.log(" uniforms: "),console.log(n.renderer.customUniforms),n.internal_renderer.customUniforms=n.renderer.customUniforms,n.internal_renderer.customDefines=n.renderer.customDefines;new Output(n.internal_renderer,n.source);n.internal_renderer.init(),n.internal_renderer.render()},n.update=function(){document.getElementById("sourceCanvas")},n.mapping={},n.load_pixelmap=function(e){(new Utils).get(e,function(e){n.mapping=JSON.parse(e)})})}};function Module(e,t){this.type="Module",this.init=function(){},this.update=function(){},this.render=function(){}}function Chain(e,t){var n,r=this;null==t.uuid?r.uuid="Chain_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):r.uuid=t.uuid,e.add(r),null!=t&&(n=t),r.type="Module",r.sources=n.sources,r.sources.forEach(function(t,n){e.customUniforms[r.uuid+"_source"+n+"_alpha"]={type:"f",value:.5}}),r.sources.forEach(function(t,n){e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+r.uuid+"_source"+n+"_alpha;\n/* custom_uniforms */")}),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+r.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec3 "+r.uuid+"_output;\n/* custom_uniforms */"),r.init=function(){var t="vec4(0.0,0.0,0.0,0.0)";r.sources.forEach(function(e,n){t+=" + ("+e.uuid+"_output * "+r.uuid+"_source"+n+"_alpha )"}),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+r.uuid+"_output = vec4( "+t+"); /* custom_main */")},r.update=function(){},r.setChainLink=function(t,n){e.customUniforms[r.uuid+"_source"+t+"_alpha"].value=n},r.getChainLink=function(t){return e.customUniforms[r.uuid+"_source"+t+"_alpha"].value},r.setAll=function(t=0){r.sources.forEach(function(n,o){e.customUniforms[r.uuid+"_source"+o+"_alpha"].value=t})},r.toggle=function(t,n){void 0===n?1==e.customUniforms[r.uuid+"_source"+t+"_alpha"].value?e.customUniforms[r.uuid+"_source"+t+"_alpha"].value=0:(e.customUniforms[r.uuid+"_source"+t+"_alpha"].value=1,current=t):e.customUniforms[r.uuid+"_source"+t+"_alpha"].value=n}}var Mixer=class{static function_list(){return[["BLEND","method","blendMode"],["MIX","method","mixMode"],["POD","set","pod"]]}constructor(e,t){var n=this;if(null!=e){null==t.uuid?n.uuid="Mixer_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,null==t.fragmentChannel?n._fragmentChannel=1:n._fragmentChannel=t.fragmentChannel,e.add(n),null!=t&&t,n.type="Module";var r=1,o=0,a=0,c=128,u=1,i=function(){return c};n.autoFade=!1,n.fading=!1;var s=1;n.mixmodes=[1,2,3,4,5,6,7,8,9];var l,d,m=1;n.blendmodes=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],l=t.source1,d=t.source2;var f="";f+="vec4 "+n.uuid+"_output = vec4( blend( ",f+=l.uuid+"_output * "+n.uuid+"_alpha1, ",f+=d.uuid+"_output * "+n.uuid+"_alpha2, ",f+=n.uuid+"_blendmode ) ",f+=")",f+=" + vec4(  "+l.uuid+"_output.a < 1.0 ? "+d.uuid+"_output.rgba * ( "+n.uuid+"_alpha1 - "+l.uuid+"_output.a ) : vec4( 0.,0.,0.,0. )  ) ",f+=" + vec4(  "+d.uuid+"_output.a < 1.0 ? "+l.uuid+"_output.rgba * ( "+n.uuid+"_alpha2 - - "+d.uuid+"_output.a ) : vec4( 0.,0.,0.,0. )  ) ",f+=";\n",f+="  /* custom_main */  ",n.init=function(){var t;e.customUniforms[n.uuid+"_mixmode"]={type:"i",value:1},e.customUniforms[n.uuid+"_blendmode"]={type:"i",value:1},e.customUniforms[n.uuid+"_alpha1"]={type:"f",value:.5},e.customUniforms[n.uuid+"_alpha2"]={type:"f",value:.5},e.customUniforms[n.uuid+"_sampler"]={type:"t",value:null},-1==(t=(t=(t=(t=(t=(t=1==n._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform int "+n.uuid+"_mixmode;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform int "+n.uuid+"_blendmode;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha1;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha2;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform vec4 "+n.uuid+"_output;\n/* custom_uniforms */")).indexOf("vec4 blend ( vec4 src, vec4 dst, int blendmode )")&&(t=t.replace("/* custom_helpers */","\n  vec4 blend ( vec4 src, vec4 dst, int blendmode ) {\n    if ( blendmode ==  1 ) return src + dst;\n    if ( blendmode ==  2 ) return src - dst;\n    if ( blendmode ==  3 ) return src * dst;\n    if ( blendmode ==  4 ) return min(src, dst);\n    if ( blendmode ==  5)  return vec4((src.x == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.x) / src.x)), (src.y == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.y) / src.y)), (src.z == 0.0) ? 0.0 : (1.0 - ((1.0 - dst.z) / src.z)),1.0);\n    if ( blendmode ==  6 ) return (src + dst) - 1.0;\n    if ( blendmode ==  7 ) return max(src, dst);\n    if ( blendmode ==  8 ) return (src + dst) - (src * dst);\n    if ( blendmode ==  9 ) return vec4((src.x == 1.0) ? 1.0 : min(1.0, dst.x / (1.0 - src.x)), (src.y == 1.0) ? 1.0 : min(1.0, dst.y / (1.0 - src.y)), (src.z == 1.0) ? 1.0 : min(1.0, dst.z / (1.0 - src.z)), 1.0);\n    if ( blendmode == 10 ) return src + dst;\n    if ( blendmode == 11 ) return vec4((dst.x <= 0.5) ? (2.0 * src.x * dst.x) : (1.0 - 2.0 * (1.0 - dst.x) * (1.0 - src.x)), (dst.y <= 0.5) ? (2.0 * src.y * dst.y) : (1.0 - 2.0 * (1.0 - dst.y) * (1.0 - src.y)), (dst.z <= 0.5) ? (2.0 * src.z * dst.z) : (1.0 - 2.0 * (1.0 - dst.z) * (1.0 - src.z)), 1.0);\n    if ( blendmode == 12 ) return vec4((src.x <= 0.5) ? (dst.x - (1.0 - 2.0 * src.x) * dst.x * (1.0 - dst.x)) : (((src.x > 0.5) && (dst.x <= 0.25)) ? (dst.x + (2.0 * src.x - 1.0) * (4.0 * dst.x * (4.0 * dst.x + 1.0) * (dst.x - 1.0) + 7.0 * dst.x)) : (dst.x + (2.0 * src.x - 1.0) * (sqrt(dst.x) - dst.x))), (src.y <= 0.5) ? (dst.y - (1.0 - 2.0 * src.y) * dst.y * (1.0 - dst.y)) : (((src.y > 0.5) && (dst.y <= 0.25)) ? (dst.y + (2.0 * src.y - 1.0) * (4.0 * dst.y * (4.0 * dst.y + 1.0) * (dst.y - 1.0) + 7.0 * dst.y)) : (dst.y + (2.0 * src.y - 1.0) * (sqrt(dst.y) - dst.y))), (src.z <= 0.5) ? (dst.z - (1.0 - 2.0 * src.z) * dst.z * (1.0 - dst.z)) : (((src.z > 0.5) && (dst.z <= 0.25)) ? (dst.z + (2.0 * src.z - 1.0) * (4.0 * dst.z * (4.0 * dst.z + 1.0) * (dst.z - 1.0) + 7.0 * dst.z)) : (dst.z + (2.0 * src.z - 1.0) * (sqrt(dst.z) - dst.z))), 1.0);\n    if ( blendmode == 13 ) return vec4((src.x <= 0.5) ? (2.0 * src.x * dst.x) : (1.0 - 2.0 * (1.0 - src.x) * (1.0 - dst.x)), (src.y <= 0.5) ? (2.0 * src.y * dst.y) : (1.0 - 2.0 * (1.0 - src.y) * (1.0 - dst.y)), (src.z <= 0.5) ? (2.0 * src.z * dst.z) : (1.0 - 2.0 * (1.0 - src.z) * (1.0 - dst.z)), 1.0);\n    if ( blendmode == 14 ) return vec4((src.x <= 0.5) ? (1.0 - (1.0 - dst.x) / (2.0 * src.x)) : (dst.x / (2.0 * (1.0 - src.x))), (src.y <= 0.5) ? (1.0 - (1.0 - dst.y) / (2.0 * src.y)) : (dst.y / (2.0 * (1.0 - src.y))), (src.z <= 0.5) ? (1.0 - (1.0 - dst.z) / (2.0 * src.z)) : (dst.z / (2.0 * (1.0 - src.z))),1.0);\n    if ( blendmode == 15 ) return 2.0 * src + dst - 1.0;\n    if ( blendmode == 16 ) return vec4((src.x > 0.5) ? max(dst.x, 2.0 * (src.x - 0.5)) : min(dst.x, 2.0 * src.x), (src.x > 0.5) ? max(dst.y, 2.0 * (src.y - 0.5)) : min(dst.y, 2.0 * src.y), (src.z > 0.5) ? max(dst.z, 2.0 * (src.z - 0.5)) : min(dst.z, 2.0 * src.z),1.0);\n    if ( blendmode == 17 ) return abs(dst - src);\n    if ( blendmode == 18 ) return src + dst - 2.0 * src * dst;\n    return src + dst;\n  }\n  /* custom_helpers */\n  ")),t=t.replace("/* custom_main */",f),1==n._fragmentChannel?e.fragmentShader=t:e.fragmentShader2=t};var g=(new Date).getTime(),p=0,v=0,_=0,h="b",y=0;n.update=function(){if(n.autoFade&&(c=i(),p=((new Date).getTime()-g)/1e3,n.pod(Math.sin(p*Math.PI*c*u/60)/2+.5)),n.fading){var e=(new Date).getTime(),t=(v=_-e)/y;"b"==h&&(t=Math.abs(t-1)),t<0&&(t=0),t>1&&(t=1),n.pod(t),v<0&&(n.fading=!1,t=Math.round(t),n.pod(t))}},n.render=function(){return a},n.alpha1=function(){return r},n.alpha2=function(){return o},n.mixMode=function(e){return null!=e&&(s=e),s},n.blendMode=function(t){return null!=t&&(m=t,e.customUniforms[n.uuid+"_blendmode"].value=m),n.pod(n.pod()),m},n.pod=function(t){return null!=t&&(a=t,1==s&&(r=a,o=1-a),2==s&&(r=Math.round(a),o=Math.round(1-a)),3==s&&((r=2*a)>1&&(r=1),(o=2-2*a)>1&&(o=1)),4==s&&(r=2*a,o=2-2*a),5==s&&((r=2*a)>1&&(r=1),(o=2-2*a)>1&&(o=1),r+=.36,o+=.36),6==s&&(r=1,o=0),7==s&&(r=0,o=1),8==s&&(r=.5,o=.5),9==s&&(r=1,o=1),10==s&&(r=a,o=1),11==s&&(r=1,o=a),e.customUniforms[n.uuid+"_alpha1"].value=r,e.customUniforms[n.uuid+"_alpha2"].value=o),a},n.bpm=function(e){return null!=e&&(c=e),c},n.bpmMod=function(e){return null!=e&&(u=e),u},n.bindBpm=function(e){i=e},n.setAutoFade=function(e){n.autoFade=e},n.fade=function(e){n.pod();n.fading=!0;var t=(new Date).getTime();_=t+e,h=n.pod()>.5?"a":"b",console.log("fadeTo",h,_,t,e),y=e}}}},Monitor=class{static function_list(){return[]}static help(){return"ownoes"}constructor(e,t){var n=this;null!=e&&(null==t.uuid?n.uuid="Monitor_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,n.renderer=e,n.source=t.source,e.add(n),n.type="Module",n.internal_renderer=null,n.init=function(){n.internal_renderer=new GlRenderer(t),n.internal_renderer.fragmentShader=n.renderer.fragmentShader,n.internal_renderer.vertexShader=n.renderer.vertexShader,n.internal_renderer.customUniforms=n.renderer.customUniforms,n.internal_renderer.customDefines=n.renderer.customDefines;new Output(n.internal_renderer,n.source);n.internal_renderer.init(),n.internal_renderer.render()},n.update=function(){})}};function Output(e,t,n){this.uuid="Output_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),this.type="Module",e.add(this);var r=t,o=n;this.init=function(){e.fragmentShader=e.fragmentShader.replace("/* custom_main */","\n  gl_FragColor = vec4( "+r.uuid+"_output );\n"),n&&(console.log("Output. Has 2nd source."),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","\n  gl_FragColor = vec4( "+o.uuid+"_output );\n"))},this.update=function(){}}function Switcher(e,t){var n=this;n.uuid="Switcher_"+(4294967296*(1+Math.random())|0).toString(16).substring(1),n.type="Module",e.add(n),n.sources=[t.source1,t.source2],n.active_source=0,n.init=function(){console.log("Switcher",n.uuid,n.sources),e.customUniforms[n.uuid+"_active_source"]={type:"i",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform int "+n.uuid+"_active_source;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+n.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_helpers */","\nvec4 get_source_"+n.uuid+" ( int active_source, vec4 src1, vec4 src2 ) {\n  if ( active_source ==  0 ) return src1;  if ( active_source ==  1 ) return src2;}\n/* custom_helpers */\n"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+n.uuid+"_output = get_source_"+n.uuid+"("+n.uuid+"_active_source, "+n.sources[0].uuid+"_output, "+n.sources[1].uuid+"_output );\n  /* custom_main */")},n.update=function(){},n.render=function(){return n.sources[n.active_source]},n.doSwitch=function(t){return null==t?0==n.active_source?n.active_source=1:n.active_source=0:0!=t&&1!=t?console.log(n.uuid,t,"not allowed"):n.active_source=t,e.customUniforms[n.uuid+"_active_source"]={type:"i",value:n.active_source},n.active_source}}var Source=class{constructor(e,t){this.type="Source",this.function_list=[["JUMP","method","jump"]],this.init=function(){},this.update=function(){},this.render=function(){},this.start=function(){},this.src=function(e){},this.play=function(){},this.pause=function(){},this.paused=function(){},this.currentFrame=function(e){},this.duration=function(){},this.jump=function(){}}};function FlexSource(e,t){var n=this,r=1024;null==t.uuid?n.uuid="FlexSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,null==t.fragmentChannel?n._fragmentChannel=1:n._fragmentChannel=t.fragmentChannel;t.texture_size&&(console.log("texture size now is: ",t.texture_size),r=t.texture_size),t.elementId?n.elementId=t.elementId:n.elementId="monitor_1",n.currentSrc="https://virtualmixproject.com/video/placeholder.mp4",n.type="FlexSource",n.bypass=!0,n.currentSrc=t.src;let o=t.src.split(".").pop();console.log("FlexSource. ext",o),"mp4"==o?n.type2="Video":"png"==o||"jpg"==o||"gif"==o?n.type2="Image":console.log("Unknown Source:",t.src);var a,c,u,i,s,l=128;n.bpmFollow=!1,n.fading=!1;e.add(n),n.init=function(){console.log("init Flex video source",n.uuid),(c=document.createElement("video")).setAttribute("crossorigin","anonymous"),c.setAttribute("playsinline",!0),c.playsinline=!0,c.preload="auto",c.muted=!0,c.poster="https://virtualmixproject.com/gif/telephone-pole-wire-tennis-shoes.jpg",null==t.src?c.src=n.currentSrc:c.src=t.src,console.log("loaded source: ",c.src),c.height=r,c.width=r,c.volume=0,c.loop=!0,c.load(),n.firstplay=!1,c.addEventListener("loadedmetadata",function(e){var t=this.videoWidth,n=this.videoHeight;console.log("WWWWW video width: ",t,n),console.log("WWWWW video duration: ",c.duration)},!1);var o=setInterval(function(){if(4==c.readyState){var e=Math.random()*c.duration;n.firstplay=!0,console.log(n.uuid,"First Play; ",e),clearInterval(o)}},400);function l(){n.firstplay=!0,document.body.removeEventListener("click",l),document.body.removeEventListener("touchstart",l),console.log("first touch was denied")}document.body.addEventListener("click",l),document.body.addEventListener("touchstart",l),(a=document.getElementById(n.elementId)).width=r,a.height=r,u=a.getContext("2d"),(i=new THREE.Texture(a)).wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,e.customUniforms[n.uuid]={type:"t",value:i},e.customUniforms[n.uuid+"_alpha"]={type:"f",value:1},e.customUniforms[n.uuid+"_uvmap"]={type:"v2",value:new THREE.Vector2(1,1)},1==n._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+n.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec2 "+n.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */",`\n        vec4 ${n.uuid+"_output"} = ( texture2D( ${n.uuid}, vUv * ${n.uuid+"_uvmap"} ).rgba * ${n.uuid+"_alpha"} );\n        /* custom_main */\n        `)):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+n.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec2 "+n.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */",`\n        vec4 ${n.uuid+"_output"} = ( texture2D( ${n.uuid}, vUv * ${n.uuid+"_uvmap"} ).rgba * ${n.uuid+"_alpha"} );\n        /* custom_main */\n        `)),n.video=c,n.canvas=a,window.image_source=new Image,(s=document.createElement("img")).setAttribute("id","gif_"+n.uuid),s.setAttribute("rel:auto_play","1"),console.log(n.uuid," Load",n.currentSrc,"..."),n.newImg=new Image,n.newImg.onload=function(){var e=n.newImg.height,t=n.newImg.width;n.imageWidth=t,n.imageHeight=e},n.newImg.src=n.currentSrc,console.log("FlexSource/Image Loaded First source!",n.currentSrc,"!"),n.bypass=!1};n.update=function(){let e=4/3;"Video"==n.type2&&c.videoWidth&&(e=c.videoWidth/c.videoHeight),"Image"==n.type2&&n.imageWidth&&(e=n.imageWidth/n.imageHeight);let t=r/(1/e),o=(r-t)/2;if(!(n.bypass=!1)){if("Video"==n.type2&&(c&&c.readyState.readyState===c.HAVE_ENOUGH_DATA&&c.seeking,u.drawImage(c,o,0,t,r),i&&(i.needsUpdate=!0)),"Image"==n.type2)try{u.clearRect(0,0,1024,1024),u.drawImage(n.newImg,o,0,t,1024),i&&(i.needsUpdate=!0)}catch(e){}if(n.bpmFollow){l=l,m=((new Date).getTime()-d)/1e3;let e=Math.sin(m*Math.PI*l*1/60)/2+.5;c.currentTime=e}}},n.render=function(){return i},n.src=function(e){if(null==e)return currentSrc;try{n.currentSrc=e,console.log("FlexSource set",n.currentSrc)}catch(e){return void console.log("FlexSource returned empty promise, retrying ...")}let r=e.split(".").pop();console.log("FlexSource. ext",r),"mp4"==r?n.type2="Video":"png"==r||"jpg"==r?n.type2="Image":console.log("Unknown Source:",t.src),"Video"==n.type2&&(c.src=e),"Image"==n.type2&&(console.log("load new src: ",e),n.currentSrc=e,n.newImg.src=n.currentSrc),i&&(i.needsUpdate=!0)},n.play=function(){return c.play()},n.pause=function(){return c.pause()},n.paused=function(){return c.paused},n.currentTime=function(e){return void 0===e?c.currentTime:(c.currentTime=e,e)},n.duration=function(){return c.duration},n.setUVMap=function(t,r){e.customUniforms[n.uuid+"_uvmap"].value=new THREE.Vector2(t,r)},n.setUVMapMod=function(t,r){console.log(e.customUniforms),e.customUniforms[n.uuid+"_uvmap_mod"].value=new THREE.Vector2(t,r)},n.alpha=function(t){if(null==t)return e.customUniforms[n.uuid+"_alpha"].value;e.customUniforms[n.uuid+"_alpha"].value=t},n.jump=function(e){if(4==c.readyState){if(null==e||isNaN(e))try{var t=Math.floor(Math.random()*c.buffered.end(0));console.log("jump to ",t),c.currentTime=t}catch(e){console.warn("video jump prevented a race error",e),c.currentTime=0}else c.currentTime=e;return c.currentTime}console.warn("Not enough data for jumping through video...")};var d=(new Date).getTime(),m=0;n.setBpmFollow=function(e){n.bpmFollow=e}}function GifSource(e,t){var n,r,o,a,c,u=this;null==t.uuid?u.uuid="GifSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):u.uuid=t.uuid,null==t.fragmentChannel?u._fragmentChannel=1:u._fragmentChannel=t.fragmentChannel,u.type="GifSource",u.bypass=!0,e.add(u),null==t.src?u.currentSrc="https://virtualmixerproject.com/gif/a443ae90a963a657e12737c466ddff95.gif":u.currentSrc=t.src,t.elementId?u.elementId=t.elementId:u.elementId="monitor_1";u.init=function(){(n=document.getElementById(u.elementId)).width=1024,n.height=1024,o=n.getContext("2d"),a=new THREE.Texture(n),e.customUniforms[u.uuid]={type:"t",value:a},e.customUniforms[u.uuid+"_alpha"]={type:"f",value:1},1==u._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */")):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+u.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec4 "+u.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+u.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","vec4 "+u.uuid+"_output = ( texture2D( "+u.uuid+", vUv ).rgba * "+u.uuid+"_alpha );\n  /* custom_main */")),u.gif=c,u.canvas=n,window.image_source=new Image,(r=document.createElement("img")).setAttribute("id","gif_"+u.uuid),r.setAttribute("rel:auto_play","1"),(c=new SuperGif({gif:r,c_w:"1024px",c_h:"576px"})).draw_while_loading=!0,console.log(u.uuid," Load",u.currentSrc,"..."),u.newImg=new Image,u.newImg.onload=function(){var e=u.newImg.height,t=u.newImg.width;u.imageWidth=t,u.imageHeight=e},u.newImg.src=u.currentSrc,c.load_url(u.currentSrc,function(){console.log("play initial source"),c.play()}),console.log("Gifsource Loaded First source!",u.currentSrc,"!"),u.bypass=!1};var i=0;u.update=function(){let e=4/3;u.imageWidth&&(e=u.imageWidth/u.imageHeight);let t=1024/(1/e),n=(1024-t)/2;try{i%6==0&&(o.clearRect(0,0,1024,1024),o.drawImage(c.get_canvas(),n,0,t,1024),a&&(a.needsUpdate=!0)),i++}catch(e){}},u.render=function(){return a},u.src=function(e){if(null==e)return u.currentSrc;console.log("load new src: ",e),u.currentSrc=e,c.pause(),c.load_url(e,function(){console.log("play gif",e),c.play()})},u.play=function(){return c.play()},u.pause=function(){return c.pause()},u.paused=function(){return!c.get_playing()},u.currentFrame=function(e){return void 0===e?c.get_current_frame():(c.move_to(e),e)},u.duration=function(){return c.get_length()}}function ImageSource(e,t){var n,r,o,a,c=this;null==t.uuid?c.uuid="ImageSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):c.uuid=t.uuid,null==t.fragmentChannel?c._fragmentChannel=1:c._fragmentChannel=t.fragmentChannel,c.type="ImageSource",c.bypass=!0,e.add(c),null==t.src?c.currentSrc="https://virtualmixerproject.com/gif/a443ae90a963a657e12737c466ddff95.gif":c.currentSrc=t.src,t.elementId?c.elementId=t.elementId:c.elementId="monitor_1";c.init=function(){(n=document.getElementById(c.elementId)).width=1024,n.height=1024,o=n.getContext("2d"),a=new THREE.Texture(n),e.customUniforms[c.uuid]={type:"t",value:a},e.customUniforms[c.uuid+"_alpha"]={type:"f",value:1},1==c._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */")):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec4 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */")),c.canvas=n,window.image_source=new Image,(r=document.createElement("img")).setAttribute("id","gif_"+c.uuid),r.setAttribute("rel:auto_play","1"),console.log(c.uuid," Load",c.currentSrc,"..."),c.newImg=new Image,c.newImg.onload=function(){var e=c.newImg.height,t=c.newImg.width;c.imageWidth=t,c.imageHeight=e},c.newImg.src=c.currentSrc,console.log("ImageSource Loaded First source!",c.currentSrc,"!"),c.bypass=!1};c.update=function(){let e=4/3;c.imageWidth&&(e=c.imageWidth/c.imageHeight);let t=1024/(1/e),n=(1024-t)/2;try{o.clearRect(0,0,1024,1024),o.drawImage(c.newImg,n,0,t,1024),a&&(a.needsUpdate=!0)}catch(e){}},c.render=function(){return a},c.src=function(e){if(null==e)return c.currentSrc;console.log("load new src: ",e),c.currentSrc=e},c.play=function(){return null},c.pause=function(){return null},c.paused=function(){return!0},c.currentFrame=function(e){return 0},c.duration=function(){return 0}}function MultiVideoSource(e,t){var n,r,o,a=this;null==t.uuid?a.uuid="MultiVideoSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):a.uuid=t.uuid,a.type="MultiVideoSource",a.bypass=!0,e.add(a);a.init=function(){console.log("init video source",a.uuid),videoElement=document.createElement("video"),videoElement.setAttribute("crossorigin","anonymous"),videoElement.muted=!0,null==t.src?videoElement.src="/streamable.com/w0skqb":videoElement.src=t.src,console.log("loaded source: ",videoElement.src),videoElement.height=1024,videoElement.width=1024,videoElement.loop=!0,videoElement.load(),a.firstplay=!1;var c=setInterval(function(){if(4==videoElement.readyState){var e=Math.random()*videoElement.duration;videoElement.currentTime=e,videoElement.play(),a.firstplay=!0,console.log(a.uuid,"First Play; ",e),clearInterval(c)}},400);document.body.addEventListener("click",function(){videoElement.play(),a.firstplay=!0}),videoElement.volume=0,(n=document.createElement("canvas")).width=1024,n.height=1024,r=n.getContext("2d"),o=new THREE.Texture(n),e.customUniforms[a.uuid]={type:"t",value:o},e.customUniforms[a.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+a.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+a.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+a.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+a.uuid+"_output = ( texture2D( "+a.uuid+", vUv ).rgba * "+a.uuid+"_alpha );\n  /* custom_main */"),a.video=videoElement,a.canvas=n,a.bypass=!1},a.update=function(){(a.bypass=!1)||(videoElement.readyState!==videoElement.HAVE_ENOUGH_DATA||videoElement.seeking?(r.clearRect(0,0,1024,1024),a.alpha=0):(r.drawImage(videoElement,0,0,1024,1024),o&&(o.needsUpdate=!0)))},a.render=function(){return o},a.src=function(e){videoElement.src=e;var t=setInterval(function(){4==videoElement.readyState&&(videoElement.play(),console.log(a.uuid,"First Play."),clearInterval(t))},400)},a.play=function(){return videoElement.play()},a.pause=function(){return videoElement.pause()},a.paused=function(){return videoElement.paused},a.currentTime=function(e){return void 0===e?videoElement.currentTime:(console.log("set time",e),videoElement.currentTime=e,e)},a.duration=function(){return videoElement.duration},a.alpha=function(t){if(null==t)return e.customUniforms[a.uuid+"_alpha"].value;e.customUniforms[a.uuid+"_alpha"].value=t},a.jump=function(e){if(null==e||isNaN(e))try{videoElement.currentTime=Math.floor(Math.random()*a.duration())}catch(e){console.log("prevented a race error")}else videoElement.currentTime=e;return videoElement.currentTime}}function SocketSource(e,t){}function SolidSource(e,t){var n,r=this;null==t.uuid?r.uuid="SolidSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):r.uuid=t.uuid,null==t.fragmentChannel?r._fragmentChannel=1:r._fragmentChannel=t.fragmentChannel,r.bypass=!0,e.add(r);var o={r:0,g:0,b:0,a:1};null!=t&&(n=t),r.init=function(){let t;console.log("init solid",n),null!=n.color&&(o=n.color),e.customUniforms[r.uuid+"_color"]={type:"v4",value:new THREE.Vector4(o.r,o.g,o.b,o.a)},t=(t=(t=(t=1==r._fragmentChannel?e.fragmentShader:e.fragmentShader2).replace("/* custom_uniforms */","uniform vec4 "+r.uuid+"_color;\n/* custom_uniforms */")).replace("/* custom_uniforms */","uniform vec4 "+r.uuid+"_output;\n/* custom_uniforms */")).replace("/* custom_main */","vec4 "+r.uuid+"_output = "+r.uuid+"_color;\n  /* custom_main */"),1==r._fragmentChannel?e.fragmentShader=t:e.fragmentShader2=t},r.update=function(){},r.render=function(){return o},r.color=function(t){return null!=t&&(null==(o=t).a&&(o.a=1),console.log(r.uuid," sets color: ",o),e.customUniforms[r.uuid+"_color"]={type:"v4",value:new THREE.Vector4(o.r,o.g,o.b,o.a)}),o},r.jump=function(e){console.log("no")}}function SVGSource(e,t){}function TextSource(e,t){var n,r,o,a,c=this;null==t.uuid?c.uuid="TextSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):c.uuid=t.uuid,c.type="TextSource",c.bypass=!0,e.add(c);c.init=function(){console.log("init text source",c.uuid),(r=document.createElement("DIV")).innerHTML="<h1> Awaiting text </h1>",r.height=1024,r.width=1024,c.firstplay=!1,n=document.createElement("canvas"),document.body.appendChild(n),n.width=1024,n.height=1024,o=n.getContext("2d"),a=new THREE.CanvasTexture(n),e.customUniforms[c.uuid]={type:"t",value:a},e.customUniforms[c.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec4 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */"),c.divElement=r,c.canvas=n,c.bypass=!1};var u=null;utils.get("/texts/fear_is_the_mind_killer.txt",function(e){u=e,console.log("get text",e)});var i=0,s="",l=0,d=12,m=600,f=300,g=64,p=512;c.update=function(){g*=.99,(c.bypass=!1)||null!=u&&(o.clearRect(0,0,n.width,n.height),o.fillStyle="rgba(60, 60, 60, 0.4)",o.font="604px IMPACT",o.textAlign="center",o.fillText(s.split(".").join(""),10*bpm.render()+f,m),o.fillStyle="white",o.font=g+"px IMPACT",o.textAlign="center",o.fillText(s.split(".").join(""),p,460),i>d&&(s=u.split(",")[l],d=u.split(",")[l].length*(bpm.bpm/72)+3,++l==u.split(",").length&&(l=0),i=0,m=Math.floor(200*Math.random())+600,f=Math.floor(200*Math.random())+200,p=Math.floor(100*Math.random())+470,g=Math.floor(30*Math.random())+70),i++,a&&(a.needsUpdate=!0))},c.render=function(){return a},c.alpha=function(t){if(null==t)return e.customUniforms[c.uuid+"_alpha"].value;e.customUniforms[c.uuid+"_alpha"].value=t}}function VideoSource(e,t){var n=this,r=1024;null==t.uuid?n.uuid="VideoSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):n.uuid=t.uuid,null==t.fragmentChannel?n._fragmentChannel=1:n._fragmentChannel=t.fragmentChannel;var o,a,c,u;t.texture_size&&(console.log("texture size now is: ",t.texture_size),r=t.texture_size),t.elementId?n.elementId=t.elementId:n.elementId="monitor_1",n.currentSrc="https://virtualmixproject.com/video/placeholder.mp4",n.type="VideoSource",n.bypass=!0;e.add(n),n.init=function(){console.log("init video source",n.uuid),(a=document.createElement("video")).setAttribute("crossorigin","anonymous"),a.setAttribute("playsinline",!0),a.playsinline=!0,a.preload="auto",a.muted=!0,a.poster="https://virtualmixproject.com/gif/telephone-pole-wire-tennis-shoes.jpg",null==t.src?a.src=n.currentSrc:a.src=t.src,console.log("loaded source: ",a.src),a.height=r,a.width=r,a.volume=0,a.loop=!0,a.load(),n.firstplay=!1,a.addEventListener("loadedmetadata",function(e){var t=this.videoWidth,n=this.videoHeight;console.log("WWWWW video width: ",t,n)},!1);var i=setInterval(function(){if(4==a.readyState){var e=Math.random()*a.duration;a.play(),n.firstplay=!0,console.log(n.uuid,"First Play; ",e),clearInterval(i)}},400);function s(){n.firstplay=!0,document.body.removeEventListener("click",s),document.body.removeEventListener("touchstart",s),console.log("first touch was denied")}document.body.addEventListener("click",s),document.body.addEventListener("touchstart",s),(o=document.getElementById(n.elementId)).width=r,o.height=r,c=o.getContext("2d"),(u=new THREE.Texture(o)).wrapS=THREE.RepeatWrapping,u.wrapT=THREE.RepeatWrapping,e.customUniforms[n.uuid]={type:"t",value:u},e.customUniforms[n.uuid+"_alpha"]={type:"f",value:1},e.customUniforms[n.uuid+"_uvmap"]={type:"v2",value:new THREE.Vector2(1,1)},1==n._fragmentChannel?(e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+n.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec2 "+n.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */",`\n        vec4 ${n.uuid+"_output"} = ( texture2D( ${n.uuid}, vUv * ${n.uuid+"_uvmap"} ).rgba * ${n.uuid+"_alpha"} );\n        /* custom_main */\n        `)):(e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform sampler2D "+n.uuid+";\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform float "+n.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_uniforms */","uniform vec2 "+n.uuid+"_uvmap;\n/* custom_uniforms */"),e.fragmentShader2=e.fragmentShader2.replace("/* custom_main */",`\n        vec4 ${n.uuid+"_output"} = ( texture2D( ${n.uuid}, vUv * ${n.uuid+"_uvmap"} ).rgba * ${n.uuid+"_alpha"} );\n        /* custom_main */\n        `)),n.video=a,n.canvas=o,n.bypass=!1};n.update=function(){let e=4/3;a.videoWidth&&(e=a.videoWidth/a.videoHeight);let t=r/(1/e),o=(r-t)/2;(n.bypass=!1)||(a&&a.readyState.readyState===a.HAVE_ENOUGH_DATA&&a.seeking,c.drawImage(a,o,0,t,r),u&&(u.needsUpdate=!0))},n.render=function(){return u},n.src=function(e){if(null==e)return currentSrc;try{n.currentSrc=e}catch(e){return void console.log("VideoSource returned empty promise, retrying ...")}a.src=e,a.play()},n.play=function(){return a.play()},n.pause=function(){return a.pause()},n.paused=function(){return a.paused},n.currentTime=function(e){return void 0===e?a.currentTime:(console.log("set time",e),a.currentTime=e,e)},n.duration=function(){return a.duration},n.setUVMap=function(t,r){e.customUniforms[n.uuid+"_uvmap"].value=new THREE.Vector2(t,r)},n.setUVMapMod=function(t,r){console.log(e.customUniforms),e.customUniforms[n.uuid+"_uvmap_mod"].value=new THREE.Vector2(t,r)},n.alpha=function(t){if(null==t)return e.customUniforms[n.uuid+"_alpha"].value;e.customUniforms[n.uuid+"_alpha"].value=t},n.jump=function(e){if(4==a.readyState){if(null==e||isNaN(e))try{var t=Math.floor(Math.random()*a.buffered.end(0));console.log("jump to ",t),a.currentTime=t}catch(e){console.warn("video jump prevented a race error",e),a.currentTime=0}else a.currentTime=e;return a.currentTime}console.warn("Not enough data for jumping through video...")}}function WebcamSource(e,t){var n,r,o,a,c=this;null==t.uuid?c.uuid="WebcamSource_"+(4294967296*(1+Math.random())|0).toString(16).substring(1):c.uuid=t.uuid,c.type="WebcamSource",c.bypass=!0,e.add(c);c.init=function(){console.log("init video source",c.uuid),(r=document.createElement("video")).setAttribute("crossorigin","anonymous"),r.height=1024,r.width=1024,r.loop=!0,r.load(),c.firstplay=!1;navigator.mediaDevices.getUserMedia({audio:!1,video:{width:1024,height:1024}}).then(function(e){r.srcObject=e,r.onloadedmetadata=function(e){r.play()}}).catch(function(e){console.log(e.name+": "+e.message)});var t=setInterval(function(){if(4==r.readyState){var e=Math.random()*r.duration;r.play(),c.firstplay=!0,console.log(c.uuid,"First Play; ",e),clearInterval(t)}},400);document.body.addEventListener("click",function(){r.play(),c.firstplay=!0}),r.volume=0,(n=document.createElement("canvas")).width=1024,n.height=1024,o=n.getContext("2d"),a=new THREE.Texture(n),e.customUniforms[c.uuid]={type:"t",value:a},e.customUniforms[c.uuid+"_alpha"]={type:"f",value:1},e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform sampler2D "+c.uuid+";\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform vec3 "+c.uuid+"_output;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_uniforms */","uniform float "+c.uuid+"_alpha;\n/* custom_uniforms */"),e.fragmentShader=e.fragmentShader.replace("/* custom_main */","vec4 "+c.uuid+"_output = ( texture2D( "+c.uuid+", vUv ).rgba * "+c.uuid+"_alpha );\n  /* custom_main */"),c.video=r,c.canvas=n,c.bypass=!1},c.update=function(){(c.bypass=!1)||(r.readyState!==r.HAVE_ENOUGH_DATA||r.seeking?(o.clearRect(0,0,1024,1024),c.alpha=0):(o.drawImage(r,0,0,1024,1024),a&&(a.needsUpdate=!0)))},c.render=function(){return a},c.play=function(){return r.play()},c.pause=function(){return r.pause()},c.paused=function(){return r.paused},c.duration=function(){return r.duration},c.alpha=function(t){if(null==t)return e.customUniforms[c.uuid+"_alpha"].value;e.customUniforms[c.uuid+"_alpha"].value=t}}FlexSource.prototype=new Source,FlexSource.constructor=FlexSource,GifSource.prototype=new Source,GifSource.constructor=GifSource,ImageSource.prototype=new Source,ImageSource.constructor=ImageSource,MultiVideoSource.prototype=new Source,MultiVideoSource.constructor=MultiVideoSource,SocketSource.prototype=new Source,SocketSource.constructor=SocketSource,SolidSource.prototype=new Source,SolidSource.constructor=SolidSource,SVGSource.prototype=new Source,SVGSource.constructor=SVGSource,TextSource.prototype=new Source,TextSource.constructor=TextSource,VideoSource.prototype=new Source,VideoSource.constructor=VideoSource,WebcamSource.prototype=new Source,WebcamSource.constructor=WebcamSource;